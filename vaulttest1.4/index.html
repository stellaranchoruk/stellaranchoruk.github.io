<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mirrasets â€” Vault-aware Swap Demo (AQUA â†’ AQUAm25)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0f12; --panel:#12181d; --ink:#e8f0f6; --muted:#94a3ad; --accent:#7d4bd1; --err:#ff6b6b; --ok:#57d29a; --border:#1c242c; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:900px;margin:28px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:22px}
    h1{margin:0 0 12px;font-size:20px;letter-spacing:.3px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    button{cursor:pointer;font-weight:700;border-radius:10px;border:1px solid #21464f;background:#0c1c20;color:#d9f6ff;padding:10px 14px;transition:.15s}
    button:hover{filter:brightness(1.08)}
    button.ghost{background:#141b22;border-color:#2a3340}
    button:disabled{opacity:.5;cursor:not-allowed}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #1e2831;background:#0e1419;color:#fff}
    label{display:block;margin:10px 0 6px;font-size:12px;color:var(--muted)}
    .slab{background:#0f1520;border:1px solid #1b2633;border-radius:22px;padding:16px;margin:12px 0}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .primary{background:var(--accent);border:1px solid #8b66d8;color:#fff}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0e1627;border:1px solid #2a3656;color:#cfe0ff;font-size:12px}
    .pill.ok{background:#0f1f1a;border-color:#214a3a;color:#b6ffd8}
    .pill.warn{background:#201114;border-color:#5a2a2a;color:#ffd8d8}
    .pill.info{background:#0f1826;border-color:#253c66}
    .small{font-size:12px;opacity:.9}

    /* v4 toasts (top-right) */
    .toast-v4-wrap{ position:fixed; right:18px; top:18px; z-index:9999; display:grid; gap:10px; width:min(92vw,420px); pointer-events:none; }
    .toast-v4{
      pointer-events:auto; display:grid; grid-template-columns:28px 1fr auto; align-items:start; gap:10px;
      padding:12px 14px; border-radius:14px; border:1px solid #253244; background:#0f1a24; color:#e7f2ff;
      box-shadow:0 12px 28px rgba(0,0,0,.35); transform:translateX(14px); opacity:0; animation:tv4in .18s ease-out forwards;
    }
    .toast-v4 .ico{ width:28px; height:28px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:16px; }
    .toast-v4 .body{ line-height:1.25; }
    .toast-v4 .title{ font-weight:700; margin-bottom:2px; }
    .toast-v4 .msg{ opacity:.9; font-size:13px; }
    .toast-v4 .x{ background:none; border:none; color:#9fb2c6; font-size:18px; cursor:pointer; }
    .toast-v4.ok  { border-color:#214a3a; background:#0f1f1a; }
    .toast-v4.err { border-color:#5a2a2a; background:#201114; }
    .toast-v4.info{ border-color:#253c66; background:#0f1826; }
    .toast-v4.ok  .ico { background:#1e3c33; }
    .toast-v4.err .ico { background:#3f1b1b; }
    .toast-v4.info .ico{ background:#1a2a46; }
    @keyframes tv4in { to{ transform:translateX(0); opacity:1; } }
    @keyframes tv4out{ to{ transform:translateX(14px); opacity:0; } }

    /* Backdrop + Modals */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:9997}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9998;text-align:left}
    .open{display:flex}
    .modal-inner{width:min(560px,92vw);background:#0e1627;border:1px solid #22315c;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .x{background:none;border:none;color:#bcc6d4;font-size:22px;line-height:1;cursor:pointer}
    .wallet-btn{width:100%;padding:14px 16px;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
    .qr-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:12px}
    .wallet-choices{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .wallet-choices button{background:#162554;border:1px solid #344a8a}
    a.link{color:#9ab0ff;text-decoration:underline}
    .mono-block{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break: break-all; background:#0c141a; border:1px dashed #2a3340; padding:8px 10px; border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h1>Vault-aware Swap Demo</h1>
        <div class="row">
          <span id="connPill" class="pill info">Not connected</span>
          <button id="connectBtn">Connect Wallet</button>
        </div>
      </div>

      <div class="slab">
        <div class="row" style="justify-content:space-between">
          <div>Connected account:</div>
          <div id="acct" class="mono">â€”</div>
        </div>
        <div class="row" style="justify-content:space-between">
          <div>LOBSTR Vault detected?</div>
          <div id="vaultBadge" class="pill">Unknown</div>
        </div>
      </div>

      <div class="slab">
        <h3 style="margin:0 0 6px">Build Swap (AQUA â†’ AQUAm25)</h3>
        <label>Amount of AQUA to sell</label>
        <input id="amt" type="text" inputmode="decimal" placeholder="e.g. 10" />
        <div class="actions">
          <button id="buildBtn" class="primary">Build Soroban Swap XDR</button>
          <button id="copyXdr" class="ghost" disabled>Copy XDR</button>
        </div>
        <label>Prepared XDR</label>
        <textarea id="xdr" rows="6" readonly placeholder="Built XDR will appear here"></textarea>
      </div>

      <div class="slab">
        <h3 style="margin:0 0 6px">Sign & Submit</h3>
        <div class="small muted" style="margin-bottom:8px">
          Flow: Sign with your connected wallet. If your account is protected by <b>LOBSTR Vault</b>, a modal will pop up with a copyable Signed XDR and a link to Vault (web) to add the additional signature.
        </div>
        <div class="actions">
          <button id="signSubmit" class="primary" disabled>Sign & Continue</button>
          <button id="openVault" class="ghost" style="display:none">Open LOBSTR Vault (web)</button>
        </div>
        <div id="result" class="small" style="margin-top:8px; line-height:1.45"></div>
      </div>

      <div class="slab">
        <h3 style="margin:0 0 6px">Debug</h3>
        <div id="debug" class="mono-block small">â€”</div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-v4-wrap" id="toastV4Wrap" aria-live="polite"></div>

  <!-- Connect Modal -->
  <div id="backdrop" class="backdrop"></div>
  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-inner">
      <div class="modal-header">
        <h2 id="loginTitle" style="font-size:18px;margin:0">Connect Wallet</h2>
        <button class="x" id="closeModal" aria-label="Close">Ã—</button>
      </div>
      <p class="small">Select a login method:</p>
      <button class="wallet-btn" id="wcBtn">ðŸ”— WalletConnect (mobile)</button>
      <button class="wallet-btn" id="freighterExtBtn">ðŸ§© Freighter (browser extension)</button>

      <div id="qrArea" class="qr-wrap" style="display:none">
        <canvas id="qrCanvas" width="256" height="256" style="background:#fff;border-radius:12px"></canvas>
        <div class="wallet-choices">
          <button id="btnLobstr">Open in LOBSTR</button>
          <button id="btnFreighter">Open in Freighter</button>
        </div>
        <div class="small">
          Scan with your wallet app (LOBSTR / Freighter), or tap a button above on mobile. Â·
          <a id="rawWcLink" class="link" href="#" target="_blank" rel="noreferrer">raw wc link</a>
        </div>
        <p id="linkStatus" class="small" style="margin:0;opacity:.8"></p>
      </div>
    </div>
  </div>

  <!-- Post-sign Vault Modal -->
  <div id="vaultBackdrop" class="backdrop"></div>
  <div id="vaultModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="vaultTitle">
    <div class="modal-inner">
      <div class="modal-header">
        <h2 id="vaultTitle" style="font-size:18px;margin:0">LOBSTR Vault Protected</h2>
        <button class="x" id="vaultClose" aria-label="Close">Ã—</button>
      </div>
      <p class="small" style="margin-top:0">
        This account is protected with <b>LOBSTR Vault</b>.<br/>
        Please <b>copy the Signed XDR</b> below and complete the additional signature in LOBSTR Vault.
      </p>
      <label>Signed XDR</label>
      <textarea id="vaultSignedXdr" rows="6" readonly placeholder="Signed XDR will appear here"></textarea>
      <div class="actions" style="margin-top:10px">
        <button id="copySignedXdr" class="primary">Copy Signed XDR</button>
        <button id="openVaultWeb" class="ghost">Open LOBSTR Vault (web)</button>
      </div>
      <p class="small muted" style="margin-top:10px">
        Tip: If the Vault app doesn't open automatically on mobile, open it manually and look for the pending request.
      </p>
    </div>
  </div>

  <script>window.process = window.process || { env: {} };</script>
  <!-- Stellar SDK (UMD v14.3.0) -->
  <script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@14.3.0/dist/stellar-sdk.min.js" crossorigin="anonymous"></script>

  <script type="module">
    import QRCode from "https://esm.sh/qrcode@1.5.3";

    // ---------- Shortcuts ----------
    const SDK = window.StellarSdk;
    if(!SDK) throw new Error("Stellar SDK failed to load.");
    const ServerCtor = (SDK.Horizon && SDK.Horizon.Server) || SDK.Server;
    if(!ServerCtor) throw new Error("Stellar SDK: Server constructor not found.");
    if(!SDK.rpc || !SDK.Address || !SDK.nativeToScVal) throw new Error("Soroban helpers missing");

    // ---------- Config ----------
    const HORIZON    = "https://horizon.stellar.org";
    const NETWORK    = SDK.Networks.PUBLIC;
    const server     = new ServerCtor(HORIZON);
    const soroban    = new SDK.rpc.Server("https://mainnet.sorobanrpc.com", { allowHttp:false });

    // Aquarius / Soroban router
    const routerContractId = "CBQDHNBFBZYE4MKPWBSJOPIYLW4SFSXAXUTSXJN76GNKYVYPCKWC6QUK";
    const baseApi          = "https://amm-api.aqua.network/api/external/v1";

    // AQUA / AQUAm25
    const AQUA   = new SDK.Asset("AQUA","GBNZILSTVQZ4R7IKQDGHYGY2QXL5QOFJYQMXPKWRRM5PAV7Y4M67AQUA");
    const AQUAm25= new SDK.Asset("AQUAm25","GDXF6SYWIQOKOZ7BACXHBFBLQZEIH25KOTTLWQK35GO3JKRNIFHHGBPC");

    // LOBSTR Vault sentinel
    const VAULT_KEY = "GA2T6GR7VXXXBETTERSAFETHANSORRYXXXPROTECTEDBYLOBSTRVAULT";

    // WalletConnect (hardened)
    const PROJECT_ID = "f658ce3a7c8a185214974f71539fea39";
    const EXPLORER   = "https://explorer-api.walletconnect.com/v3/wallets";

    // ---------- DOM ----------
    const $ = (id)=>document.getElementById(id);
    const toastV4Wrap = $("toastV4Wrap");
    function toastV4({ type="info", title="", message="", timeout=3200 } = {}){
      const el = document.createElement("div");
      el.className = `toast-v4 ${type}`;
      const icon = type==="ok" ? "âœ“" : type==="err" ? "!" : "â„¹ï¸Ž";
      el.innerHTML = `
        <div class="ico">${icon}</div>
        <div class="body">${title?`<div class="title">${title}</div>`:""}<div class="msg">${message||""}</div></div>
        <button class="x" aria-label="Close">Ã—</button>`;
      toastV4Wrap.appendChild(el);
      const close = ()=>{ el.style.animation="tv4out .16s ease-in forwards"; setTimeout(()=>el.remove(), 180); };
      el.querySelector(".x").onclick = close;
      if(timeout) setTimeout(close, timeout);
      return { close };
    }
    const tOk  = (m)=>toastV4({type:"ok",  title:"Done",  message:m});
    const tErr = (m)=>toastV4({type:"err", title:"Error", message:m});
    const info = (m)=>toastV4({type:"info",title:"Info",  message:m});

    const connPill   = $("connPill");
    const acctEl     = $("acct");
    const vaultBadge = $("vaultBadge");
    const amtEl      = $("amt");
    const xdrEl      = $("xdr");
    const buildBtn   = $("buildBtn");
    const copyXdr    = $("copyXdr");
    const signSubmit = $("signSubmit");
    const resultEl   = $("result");
    const debugEl    = $("debug");

    // Connect modal DOM
    const connectBtn=$("connectBtn"), backdrop=$("backdrop"), loginModal=$("loginModal"), closeModalBtn=$("closeModal");
    const wcBtn=$("wcBtn"), freighterExtBtn=$("freighterExtBtn");
    const qrArea=$("qrArea"), qrCanvas=$("qrCanvas"), linkStatus=$("linkStatus"), rawWcLink=$("rawWcLink");
    const btnLobstr=$("btnLobstr"), btnFreighter=$("btnFreighter");

    // Vault modal DOM
    const vaultBackdrop=$("vaultBackdrop"), vaultModal=$("vaultModal"), vaultClose=$("vaultClose");
    const vaultSignedXdr=$("vaultSignedXdr"), copySignedXdr=$("copySignedXdr"), openVaultWeb=$("openVaultWeb");
    const openVaultBtn=$("openVault");

    function openModal(){ backdrop.classList.add('open'); loginModal.classList.add('open'); }
    function closeModal(){ backdrop.classList.remove('open'); loginModal.classList.remove('open'); }
    connectBtn.addEventListener("click", openModal);
    closeModalBtn.addEventListener("click", closeModal);
    backdrop.addEventListener("click", closeModal);

    function openVaultModal(){ vaultBackdrop.classList.add('open'); vaultModal.classList.add('open'); }
    function closeVaultModal(){ vaultBackdrop.classList.remove('open'); vaultModal.classList.remove('open'); }
    vaultClose.addEventListener("click", closeVaultModal);
    vaultBackdrop.addEventListener("click", (e)=>{ if(e.target===vaultBackdrop) closeVaultModal(); });

    // ---- Connection pill helper
    function setConnPill({ text, kind="info", vault=false }){
      connPill.textContent = vault ? `LOBSTR Vault protected` : text;
      connPill.classList.remove("ok","warn","info");
      connPill.classList.add(vault ? "ok" : kind);
    }

    // ---------- WalletConnect hardened init
    let wcClient=null, session=null, latestWcUri=null;
    let connectionMode="none", pubkey="";
    let wcInitLock=false, wcBusy=false;

    const isIOS = ()=>/iPhone|iPad|iPod/i.test(navigator.userAgent);

    async function purgeWcStorage(){
      try{
        Object.keys(localStorage).forEach(k=>{
          if(k.startsWith("wc@2") || k.startsWith("walletconnect")) localStorage.removeItem(k);
        });
        Object.keys(sessionStorage).forEach(k=>{
          if(k.startsWith("wc@2") || k.startsWith("walletconnect")) sessionStorage.removeItem(k);
        });
      }catch{}
    }

    async function ensureClient({forceFresh=false, retry=false}={}){
      if (wcClient && !forceFresh) return wcClient;
      if (wcInitLock) { while (wcInitLock) await new Promise(r=>setTimeout(r,50)); return wcClient; }
      wcInitLock = true;
      try{
        if (forceFresh) await purgeWcStorage();
        const SignClient = (await import("https://esm.sh/@walletconnect/sign-client@2.21.8")).default;

        wcClient = await SignClient.init({
          projectId: PROJECT_ID,
          relayUrl: "wss://relay.walletconnect.com",
          metadata: {
            name: "Mirrasets Demo",
            description: "Vault-aware Soroban swap demo",
            url: location.origin,
            icons: ["https://walletconnect.com/walletconnect-logo.png"]
          }
        });

        // Clean expired pairings
        try{
          const pairings = wcClient.core.pairing.getPairings?.() || [];
          for (const p of pairings) {
            if (p.expiry && p.expiry*1000 < Date.now()) {
              await wcClient.core.pairing.disconnect({ topic: p.topic }).catch(()=>{});
            }
          }
        }catch{}

        // Listener to avoid "without any listeners"
        wcClient.events.removeAllListeners?.("session_request");
        wcClient.events.on("session_request", (_event)=>{ /* no-op */ });

        return wcClient;
      }catch(e){
        if(!retry && /No matching key/i.test(String(e?.message||e))){
          await purgeWcStorage();
          wcClient = null;
          return ensureClient({forceFresh:true, retry:true});
        }
        throw e;
      }finally{
        wcInitLock = false;
      }
    }

    async function getFreighterLinks(){
      try{
        const url = `${EXPLORER}?projectId=${encodeURIComponent(PROJECT_ID)}&entries=200&page=1`;
        const res = await fetch(url); const data = await res.json();
        const arr = (data?.listings ?? data?.data ?? []);
        const list = Array.isArray(arr) ? arr : Object.values(arr);
        const w = list.find(it => ((it.name||it.app?.name||"").toLowerCase()).includes("freighter"));
        const mobile = w?.mobile || w?.app?.mobile || {};
        return { native: mobile.native||mobile.nativeLink||null, universal: mobile.universal||mobile.universalLink||null, found: !!w };
      }catch{ return { native:null, universal:null, found:false }; }
    }
    function buildCandidates(base, wcUri){
      if(!base) return [];
      const enc = encodeURIComponent(wcUri);
      if (base.includes("{wc}") || base.includes("{URI}")) return [ base.replace("{wc}",enc).replace("{URI}",enc) ];
      const j = base.includes("?") ? "&" : "?";
      return [ `${base}${j}wc=${enc}`, `${base}${j}uri=${enc}` ];
    }
    function openFreighterSmart(links, wcUri){
      const store = isIOS()? "https://apps.apple.com/app/freighter/id6743947720" : "https://play.google.com/store/apps/details?id=org.stellar.freighterwallet&pli=1";
      const natives    = buildCandidates(links.native, wcUri);
      const universals = buildCandidates(links.universal, wcUri);
      let attempted=false;
      for(const href of natives){ attempted=true; window.location.href = href; setTimeout(()=>{},350); }
      if(universals.length){ attempted=true; window.open(universals[0], "_blank", "noopener"); }
      if(!attempted){ window.open(store, "_blank", "noopener"); }
    }
    function openLobstrApp(uri){
      const scheme = `lobstr://wc?uri=${encodeURIComponent(uri)}`;
      const store  = isIOS()? "https://apps.apple.com/app/id1404357892" : "https://play.google.com/store/apps/details?id=com.lobstr.client";
      const t0 = Date.now();
      window.location.href = scheme;
      setTimeout(()=>{ if(!document.hidden && Date.now()-t0<2000){ window.open(store, "_blank", "noopener"); } }, 1800);
    }

    // WC connect button (debounced + hardened)
    wcBtn.addEventListener("click", async ()=>{
      if (wcBusy) return;
      wcBusy = true; wcBtn.disabled = true;
      try{
        const sc = await ensureClient({ forceFresh:false });

        info("Starting WalletConnectâ€¦");
        const { uri, approval } = await sc.connect({
          requiredNamespaces: {
            stellar: {
              chains: ["stellar:pubnet"],
              methods: ["stellar_signXDR","stellar_signAndSubmitXDR"],
              events: []
            }
          }
        });

        if(!uri) throw new Error("No WC URI");
        latestWcUri = uri;

        // QR + deep links
        await QRCode.toCanvas(qrCanvas, uri, { width:256, margin:1 });
        qrArea.style.display = "flex";
        rawWcLink.href = uri;

        linkStatus.textContent = "Loading Freighter deep linkâ€¦";
        const freighterLinks = await getFreighterLinks();
        linkStatus.textContent = freighterLinks.found ? "" : "Freighter link not found â€” store fallback.";
        btnLobstr.onclick    = ()=> openLobstrApp(latestWcUri);
        btnFreighter.onclick = ()=> openFreighterSmart(freighterLinks, latestWcUri);

        // Await approval
        session = await approval();

        wcClient = sc;
        connectionMode = "wc";
        qrArea.style.display="none"; closeModal();

        const accounts = session.namespaces?.stellar?.accounts || [];
        const first = accounts.find(a=>a.startsWith("stellar:pubnet")) || accounts[0] || "";
        pubkey = first.split(":")[2] || "";
        acctEl.textContent = pubkey;

        setConnPill({ text:"Connected", kind:"info" });
        await detectVault(pubkey);
      }catch(e){
        if(/No matching key/i.test(String(e?.message||e))){
          info("Recovering WalletConnect stateâ€¦");
          await purgeWcStorage();
          wcClient = null;
          wcBtn.disabled=false; wcBusy=false;
          return;
        }
        console.error(e);
        tErr(e.message || "WC connect failed");
      }finally{
        wcBtn.disabled=false; wcBusy=false;
      }
    });

    // Freighter connect (extension)
    freighterExtBtn.addEventListener("click", async ()=>{
      try{
        const mod = await import('https://esm.sh/@stellar/freighter-api@5.0.0');
        const freighter = mod?.default ?? mod;
        let address = "";
        try { address = await freighter.getPublicKey(); } catch {}
        if(!address && freighter.getAddress){ const r=await freighter.getAddress(); address=r?.address||""; }
        if(!address && freighter.requestAccess){ const r=await freighter.requestAccess(); address=r?.address||""; }
        if(!address) throw new Error("Freighter connect denied or failed.");
        connectionMode="freighter";
        pubkey = address;
        closeModal();
        acctEl.textContent = pubkey;
        setConnPill({ text:"Connected", kind:"info" });
        await detectVault(pubkey);
      }catch(e){
        console.error(e);
        tErr(e.message||"Freighter connect failed");
      }
    });

    // ---------- Vault detection ----------
    async function detectVault(account){
      vaultBadge.textContent = "Checkingâ€¦";
      vaultBadge.classList.remove("ok","warn","info");
      try{
        const acc = await fetch(`${HORIZON}/accounts/${account}`).then(r=>r.json());
        const signers = (acc?.signers||[]).map(s=>s.key);
        const hasVault = signers.includes(VAULT_KEY);
        vaultBadge.textContent = hasVault ? "Yes â€” LOBSTR Vault signer present" : "No";
        vaultBadge.classList.add(hasVault ? "ok":"info");

        // Replace connection pill text with Vault-protected if present
        if (hasVault) setConnPill({ text:"Connected", vault:true });

        // Show the manual vault link button only when relevant
        openVaultBtn.style.display = hasVault ? "" : "none";
        return hasVault;
      }catch(e){
        vaultBadge.textContent = "Unknown (lookup failed)";
        vaultBadge.classList.add("warn");
        return false;
      }
    }

    const toCid = (asset)=> asset.contractId(NETWORK);

    // ---------- Build Soroban swap (AQUA -> AQUAm25, strict-send ~1% slippage) ----------
    async function buildSwapXdr(account, sellAmount){
      // 1) Aquarius route
      const body = {
        token_in_address:  toCid(AQUA),
        token_out_address: toCid(AQUAm25),
        amount: String(Math.round(Number(sellAmount)*1e7))
      };
      const path = await fetch(`${baseApi}/find-path/`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      }).then(r=>r.json());
      if(!path?.success) throw new Error("Aquarius could not quote a route");

      // 2) Build swap_chained with u128 amounts
      const acc = await soroban.getAccount(account);
      const router = new SDK.Contract(routerContractId);
      const addrAccount  = SDK.Address.fromString(account).toScVal();
      const addrTokenIn  = SDK.Address.fromString(toCid(AQUA)).toScVal();
      const inU128       = SDK.nativeToScVal(BigInt(Math.round(Number(sellAmount)*1e7)), { type:"u128" });
      const outMin       = BigInt(path.amount) - (BigInt(path.amount) * 100n/10000n); // 1% slippage
      const outMinU128   = SDK.nativeToScVal(outMin, { type:"u128" });
      const swapChainVal = SDK.xdr.ScVal.fromXDR(path.swap_chain_xdr, "base64");

      let tx = new SDK.TransactionBuilder(acc, { fee:"20000", networkPassphrase: NETWORK })
        .setTimeout(300)
        .addOperation(router.call("swap_chained", addrAccount, swapChainVal, addrTokenIn, inU128, outMinU128))
        .build();

      tx = await soroban.prepareTransaction(tx);
      return tx.toXDR();
    }

    // ---------- Sign helpers ----------
    const wcRequest = (method, xdr) => wcClient.request({
      topic: session.topic, chainId: "stellar:pubnet",
      request: { jsonrpc:"2.0", method, params:{ xdr } }
    });

    async function signViaCurrent(xdr){
      if(connectionMode==="wc"){
        const r = await wcRequest("stellar_signXDR", xdr);
        if(!r?.signedXDR) throw new Error("WalletConnect: no signedXDR");
        return r.signedXDR;
      }
      if(connectionMode==="freighter"){
        const mod = await import('https://esm.sh/@stellar/freighter-api@5.0.0');
        const freighter = mod?.default ?? mod;
        const res = await freighter.signTransaction(xdr, { networkPassphrase: NETWORK, accountToSign: pubkey });
        if(res?.error) throw new Error(res.error.message||"Freighter: sign failed");
        return res.signedTxXdr || res.signedXDR || res;
      }
      throw new Error("No wallet connected");
    }

    // ---------- Submit Soroban ----------
    async function submitSoroban(signedXdr){
      const tx = SDK.TransactionBuilder.fromXDR(signedXdr, NETWORK);
      const send = await soroban.sendTransaction(tx);
      if (send.status !== "PENDING" && send.status !== "SUCCESS")
        throw new Error(`Soroban send failed: ${send.status}`);
      let final = await soroban.getTransaction(send.hash);
      let tries = 0;
      while(final.status === "NOT_FOUND" && tries < 12){
        await new Promise(r=>setTimeout(r, 800));
        final = await soroban.getTransaction(send.hash);
        tries++;
      }
      if(final.status !== "SUCCESS") throw new Error(`Tx failed: ${final.status}`);
      return final;
    }

    // ---------- Vault web link fallback (manual) ----------
    function openVaultWebLink(xdr){
      const href = `https://vault.lobstr.co/sign?network=PUBLIC&xdr=${encodeURIComponent(xdr)}`;
      window.open(href, "_blank", "noopener");
    }

    // ---------- UI bindings ----------
    buildBtn.addEventListener("click", async ()=>{
      resultEl.textContent = "";
      xdrEl.value = "";
      copyXdr.disabled = true;
      signSubmit.disabled = true;
      try{
        if(!pubkey) throw new Error("Connect a wallet first.");
        const amt = parseFloat((amtEl.value||"").replace(/,/g,""));
        if(!isFinite(amt) || amt<=0) throw new Error("Enter a valid AQUA amount.");
        info("Building swap XDRâ€¦");
        const x = await buildSwapXdr(pubkey, amt);
        xdrEl.value = x;
        copyXdr.disabled = false;
        signSubmit.disabled = false;
        tOk("Swap XDR ready.");
      }catch(e){
        tErr(e.message||"Build failed");
      }
    });

    copyXdr.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(xdrEl.value); tOk("XDR copied"); }
      catch(e){ tErr("Clipboard failed"); }
    });

    // Show manual Vault link button only if vault present
    openVaultBtn.addEventListener("click", ()=>{
      if(!xdrEl.value) return;
      openVaultWebLink(xdrEl.value);
    });

    // Sign flow (Vault-aware)
    signSubmit.addEventListener("click", async ()=>{
      resultEl.innerHTML = "";
      try{
        if(!xdrEl.value) throw new Error("No XDR to sign.");
        const hasVault = await detectVault(pubkey); // refresh status
        openVaultBtn.style.display = hasVault ? "" : "none";

        info("Check your wallet to signâ€¦");
        const signed = await signViaCurrent(xdrEl.value);

        if(!hasVault){
          // Simple path â€” submit to Soroban now
          info("Submitting to Sorobanâ€¦");
          const final = await submitSoroban(signed);
          const u = BigInt(final.returnValue?.u128 ?? 0n);
          resultEl.innerHTML = `Submitted âœ“ hash: ${final.hash}<br/>Amount (u128): ${u}<br/>View: https://stellar.expert/explorer/public/tx/${final.hash}`;
          tOk("Submitted");
          return;
        }

        // Vault-protected account: show modal with signed XDR + web link
        vaultSignedXdr.value = signed;
        openVaultModal();

        // Also copy automatically as a nicety
        try{ await navigator.clipboard.writeText(signed); info("Signed XDR copied"); }catch{}

        // And show a small note in result
        resultEl.innerHTML = `Signed XDR prepared for LOBSTR Vault co-signature. Use the modal to copy / open Vault.`;
      }catch(e){
        console.error(e);
        tErr(e.message || "Sign/submit failed");
      }
    });

    // Vault modal actions
    copySignedXdr.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(vaultSignedXdr.value); tOk("Signed XDR copied"); }
      catch(e){ tErr("Clipboard failed"); }
    });
    openVaultWeb.addEventListener("click", ()=>{
      if(!vaultSignedXdr.value) return;
      openVaultWebLink(vaultSignedXdr.value);
    });

    // Minimal debug helper
    let dbg = [];
    function logd(x){ dbg.push(x); debugEl.textContent = dbg.slice(-20).map(v=>typeof v==="string"?v:JSON.stringify(v)).join("\n"); }
    window.addEventListener("error", (e)=>logd("ERR: "+(e.message||"unknown")));

    // ---------- Connect modal QR helpers ----------
    async function getFreighterLinks(){
      try{
        const url = `${EXPLORER}?projectId=${encodeURIComponent(PROJECT_ID)}&entries=200&page=1`;
        const res = await fetch(url); const data = await res.json();
        const arr = (data?.listings ?? data?.data ?? []);
        const list = Array.isArray(arr) ? arr : Object.values(arr);
        const w = list.find(it => ((it.name||it.app?.name||"").toLowerCase()).includes("freighter"));
        const mobile = w?.mobile || w?.app?.mobile || {};
        return { native: mobile.native||mobile.nativeLink||null, universal: mobile.universal||mobile.universalLink||null, found: !!w };
      }catch{ return { native:null, universal:null, found:false }; }
    }

    // Initial UI
    setConnPill({ text:"Not connected", kind:"info" });
    xdrEl.value = "";
    copyXdr.disabled = true;
    signSubmit.disabled = true;
    openVaultBtn.style.display = "none";
  </script>

  <!-- Freighter UMD fallback (optional; sometimes the CDN name can hiccup â€” WC path does not depend on this) -->
  <script>
    if(!window.freighterApi){
      const s = document.createElement('script');
      s.src = "https://cdn.freighter.app/freighter-api-v1.js";
      s.defer = true;
      s.onerror = ()=>{/* ignore - we import from esm.sh in-module when needed */};
      document.head.appendChild(s);
    }
  </script>
</body>
</html>
