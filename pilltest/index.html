<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>SEP-1 Icon Pills (TOML via Horizon) — Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@14.3.0/dist/stellar-sdk.min.js" crossorigin="anonymous"></script>
<style>
  :root{--bg:#0b0f12;--panel:#12181d;--ink:#e8f0f6;--muted:#8aa0ac;--border:#1c242c;--pill:#0f1620;}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:720px;margin:28px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:20px}
  h1{margin:0 0 14px;font-size:18px}
  label{display:block;margin:12px 0 6px;color:var(--muted);font-size:12px}
  select{width:100%;padding:12px;border-radius:10px;border:1px solid #1e2831;background:#0e1419;color:#fff}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;background:var(--pill);border:1px solid #1e2831}
  .pill .ico{width:22px;height:22px;border-radius:999px;overflow:hidden;flex:0 0 22px;background:#101822;display:grid;place-items:center}
  .pill .ico img{width:100%;height:100%;display:block}
  .pill .t{font-weight:700;letter-spacing:.2px}
  .box{background:#0d141b;border:1px solid #1b2531;border-radius:12px;padding:16px}
  .muted{color:var(--muted)}
  .preview{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .btn{cursor:pointer;font-weight:700;border-radius:10px;border:1px solid #28414d;background:#0c1c20;color:#d9f6ff;padding:10px 14px}
  .btn:hover{filter:brightness(1.06)}
  .tip{margin-top:10px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Asset pills with icons from SEP-1 (stellar.toml)</h1>

    <div class="row">
      <div style="flex:1;min-width:260px">
        <label>From (Code:Issuer or XLM)</label>
        <select id="from">
          <option value="XLM">XLM (native)</option>
          <!-- Common issuers for testing -->
          <option value="AQUA:GBNZILSTVQZ4R7IKQDGHYGY2QXL5QOFJYQMXPKWRRM5PAV7Y4M67AQUA">AQUA</option>
          <option value="AQUAm25:GDXF6SYWIQOKOZ7BACXHBFBLQZEIH25KOTTLWQK35GO3JKRNIFHHGBPC">AQUAm25</option>
          <option value="USDC:GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN">USDC (centre.io)</option>
        </select>
      </div>

      <div style="flex:1;min-width:260px">
        <label>To (fixed for demo)</label>
        <div class="pill" id="toPill">
          <span class="ico" id="toIcon"></span>
          <span class="t" id="toTicker">AQUAm25</span>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="muted" style="margin-bottom:8px">Preview</div>
      <div class="preview">
        <div class="pill" id="fromPill">
          <span class="ico" id="fromIcon"></span>
          <span class="t" id="fromTicker">XLM</span>
        </div>
        <div class="pill" title="to">
          <span class="ico" style="background:#151c2a; font-size:12px; font-weight:800; color:#bcd;line-height:1">→</span>
          <span class="t muted">to</span>
        </div>
        <div class="pill">
          <span class="ico" id="toIcon2"></span>
          <span class="t" id="toTicker2">AQUAm25</span>
        </div>
      </div>
      <div class="tip" id="note"></div>
    </div>

    <div class="row" style="margin-top:14px">
      <button class="btn" id="reload">Clear Cache & Reload</button>
    </div>
  </div>
</div>

<script>
  const SDK = window.StellarSdk;
  const HORIZON = "https://horizon.stellar.org";
  const AQUAM25_ISSUER = "GDXF6SYWIQOKOZ7BACXHBFBLQZEIH25KOTTLWQK35GO3JKRNIFHHGBPC";

  // Crisp inline XLM icon
  const XLM_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
    <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">
      <circle cx="128" cy="128" r="128" fill="#1b2a42"/>
      <path fill="#fff" d="M186.7 86.2c-28.7-28.8-75.2-28.9-104-.2-12.6 12.5-20 28.2-21.6 45l26.2-11
      c2.9-9.5 8.2-18.5 15.8-26 21.9-21.7 57.4-21.6 79.2.2 21.8 21.8 22 57.3.3 79.2-18.4 18.6-47.1 21.2-68.5 7.9l-12.4 20.9
      c30.1 16.7 68.7 12 93.7-13.2 28.9-29 28.8-75.8-1.1-103.8zM61 139.6l-18.5 7.8c-2.7 1.2-3.9 4.3-2.7 7l4.1 9.6c1.2 2.7 4.3 3.9 7 2.7l18.5-7.8 7.9 18.5c1.2 2.7 4.3 3.9 7 2.7l9.6-4.1c2.7-1.2 3.9-4.3 2.7-7l-7.9-18.5 72.7-30.8c2.7-1.2 3.9-4.3 2.7-7l-4.1-9.6c-1.2-2.7-4.3-3.9-7-2.7L84 138.6l-7.9-18.5c-1.2-2.7-4.3-3.9-7-2.7l-9.6 4.1c-2.7 1.2-3.9 4.3-2.7 7L61 139.6z"/>
    </svg>
  `);

  // Caches
  const ICON_CACHE   = new Map();   // "CODE:ISSUER|null" -> url
  const DOMAIN_CACHE = new Map();   // issuer -> domain
  const TOML_CACHE   = new Map();   // domain -> parsed object or null

  function monogram(text) {
    const c = document.createElement('canvas'); c.width = 64; c.height = 64;
    const ctx = c.getContext('2d');
    ctx.fillStyle = '#16212b'; ctx.beginPath(); ctx.arc(32,32,32,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#d8e6f2';
    ctx.font = 'bold 28px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText((text||'?').slice(0,3).toUpperCase(), 32, 36);
    return c.toDataURL('image/png');
  }

  async function getHomeDomain(issuer){
    if (DOMAIN_CACHE.has(issuer)) return DOMAIN_CACHE.get(issuer);
    const r = await fetch(`${HORIZON}/accounts/${issuer}`);
    if (!r.ok) throw new Error(`Issuer lookup failed: ${r.status}`);
    const j = await r.json();
    const dom = j.home_domain || "";
    DOMAIN_CACHE.set(issuer, dom);
    return dom;
  }

  async function getToml(domain){
    if (!domain) return null;
    if (TOML_CACHE.has(domain)) return TOML_CACHE.get(domain);
    try {
      const toml = await SDK.StellarTomlResolver.resolve(domain, { allowHttp:false, timeout:8000 });
      TOML_CACHE.set(domain, toml || null);
      return toml || null;
    } catch (e) {
      // Many domains still ship proper CORS; if not, we just cache null and fall back.
      console.warn("stellar.toml fetch failed for", domain, e);
      TOML_CACHE.set(domain, null);
      return null;
    }
  }

  function toAbsoluteUrl(domain, url){
    if (!url) return null;
    // Already absolute
    if (/^https?:\/\//i.test(url)) return url;
    // Protocol-relative
    if (/^\/\//.test(url)) return `https:${url}`;
    // Root-relative
    if (url.startsWith('/')) return `https://${domain}${url}`;
    // Plain relative path
    return `https://${domain}/${url}`;
  }

  function findCurrencyImage(toml, code, issuer, domain){
    if (!toml || !Array.isArray(toml.CURRENCIES)) return null;
    const hit = toml.CURRENCIES.find(c => {
      const ccode   = c.code || c.CODE;
      const cissuer = (c.issuer || c.ISSUER || "").toUpperCase();
      return ccode === code && cissuer === (issuer||"").toUpperCase();
    });
    const raw = hit?.image || hit?.logo || hit?.IMAGE || hit?.LOGO || null;
    return toAbsoluteUrl(domain, raw);
  }

  async function resolveIconFromToml(code, issuer){
    const key = `${code}:${issuer||''}`;
    if (ICON_CACHE.has(key)) return ICON_CACHE.get(key);

    if (code === 'XLM' && !issuer) {
      ICON_CACHE.set(key, XLM_SVG); return XLM_SVG;
    }

    try{
      const domain = await getHomeDomain(issuer);
      const toml   = await getToml(domain);
      const url    = findCurrencyImage(toml, code, issuer, domain);
      if (url) { ICON_CACHE.set(key, url); return url; }
    }catch(_){ /* fall through */ }

    const fallback = monogram(code);
    ICON_CACHE.set(key, fallback);
    return fallback;
  }

  function parseVal(v){ if (!v || v==='XLM') return { code:'XLM', issuer:null }; const [code, issuer]=v.split(':'); return { code, issuer }; }

  async function paintPill(iconEl, textEl, code, issuer){
    textEl.textContent = code;
    iconEl.innerHTML = '';
    const url = await resolveIconFromToml(code, issuer);
    const img = document.createElement('img');
    img.alt = `${code} logo`; img.referrerPolicy = 'no-referrer'; img.decoding = 'async';
    img.src = url;
    iconEl.appendChild(img);
  }

  async function refreshFrom(){
    const sel = document.getElementById('from');
    const { code, issuer } = parseVal(sel.value);
    // Show debug note with domain and whether TOML was found
    let note = '';
    if (issuer) {
      try {
        const domain = await getHomeDomain(issuer);
        const toml = await getToml(domain);
        note = `Issuer domain: ${domain || '—'} · TOML: ${toml ? 'OK' : 'unavailable'}`;
      } catch {
        note = 'Issuer domain lookup failed';
      }
    } else {
      note = 'Native XLM';
    }
    document.getElementById('note').textContent = note;

    await paintPill(document.getElementById('fromIcon'), document.getElementById('fromTicker'), code, issuer);
  }

  async function init(){
    await paintPill(document.getElementById('toIcon'),  document.getElementById('toTicker'),  'AQUAm25', AQUAM25_ISSUER);
    await paintPill(document.getElementById('toIcon2'), document.getElementById('toTicker2'), 'AQUAm25', AQUAM25_ISSUER);

    await refreshFrom();
    document.getElementById('from').addEventListener('change', refreshFrom);
    document.getElementById('reload').addEventListener('click', ()=>{
      ICON_CACHE.clear(); DOMAIN_CACHE.clear(); TOML_CACHE.clear();
      document.getElementById('note').textContent = 'Caches cleared.';
      refreshFrom();
    });
  }
  init();
</script>
</body>
</html>
