<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stellar Asset Icon Test (TOML → image=)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0b0f12; --panel:#12181d; --ink:#e8f0f6; --muted:#9bb0be; --ok:#57d29a; --err:#ff6b6b; --border:#1b2630; }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{ max-width:760px; margin:24px auto; padding:0 16px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:18px }
    h1{ margin:0 0 12px; font-size:18px; letter-spacing:.2px }
    label{ display:block; margin:8px 0 6px; font-size:12px; color:var(--muted) }
    input{ width:100%; padding:12px; border-radius:10px; border:1px solid #1e2831; background:#0e1419; color:#eaf6ff }
    .row{ display:flex; gap:10px; flex-wrap:wrap }
    .col{ flex:1; min-width:210px }
    button{ cursor:pointer; font-weight:600; border-radius:10px; border:1px solid #224a54; background:#0c1c20; color:#d9f6ff; padding:10px 14px }
    button:hover{ filter:brightness(1.08) }
    .pill{ display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:#0f1821; border:1px solid #1f2b36; font-weight:600 }
    .pill img{ width:20px; height:20px; border-radius:999px; object-fit:cover; display:block; background:#0a0f14 }
    .muted{ color:var(--muted); font-size:12px }
    .log{ margin-top:12px; padding:10px; border-radius:10px; background:#0b1115; border:1px dashed #20303a; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap }
    .flex-center{ display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .badge{ padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #22303b; background:#0e151c }
    .ok{ color:var(--ok); border-color:#244b39 }
    .err{ color:var(--err); border-color:#4b2a2a }
    /* toast */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#0e1823; border:1px solid #21464f; color:#eaf6ff; padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:none; max-width:92vw }
    .toast.show{ display:block }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Asset Icon via TOML <span class="badge">Horizon ➜ TOML ➜ image=</span></h1>

      <div class="row">
        <div class="col">
          <label>Asset Code</label>
          <input id="code" placeholder="e.g. USDC" value="USDC" />
        </div>
        <div class="col">
          <label>Asset Issuer (G…)</label>
          <input id="issuer" placeholder="G..." value="GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="load">Load Icon</button>
        <button id="tryAqua" class="muted" style="border-color:#2a3340">Try AQUA</button>
      </div>

      <div id="result" style="margin-top:14px; display:none" class="flex-center">
        <span class="pill" id="pill"><img id="icon" alt="" /><span id="ticker">—</span></span>
        <span id="status" class="badge"></span>
      </div>

      <div id="notes" class="muted" style="margin-top:10px"></div>

      <div id="log" class="log" aria-live="polite"></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const HORIZON = "https://horizon.stellar.org";

    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg){ toastEl.textContent = msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), 2400); }

    function pretty(obj){ try{return JSON.stringify(obj,null,2)}catch{return String(obj)} }

    // Fetch Horizon asset to get TOML link
    async function fetchTomlLink(code, issuer){
      const url = `${HORIZON}/assets?asset_code=${encodeURIComponent(code)}&asset_issuer=${encodeURIComponent(issuer)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`Horizon assets ${res.status}`);
      const j = await res.json();
      const rec = j?._embedded?.records?.[0];
      const toml = rec?._links?.toml?.href || "";
      if(!toml) throw new Error("No TOML link on Horizon record");
      return { toml, record:rec };
    }

    // Fetch TOML with graceful CORS fallback
    async function fetchTomlText(tomlUrl){
      try{
        const r = await fetch(tomlUrl, { mode:"cors" });
        if(!r.ok) throw new Error(`TOML ${r.status}`);
        return await r.text();
      }catch(e){
        // Fallback via r.jina.ai cache proxy (GET-only mirror)
        try{
          const mirror = "https://r.jina.ai/http/" + tomlUrl.replace(/^https?:\/\//i,"");
          const r2 = await fetch(mirror, { mode:"cors" });
          if(!r2.ok) throw new Error(`Mirror ${r2.status}`);
          return await r2.text();
        }catch(e2){
          throw new Error(`TOML fetch failed (${e.message}); mirror failed (${e2.message})`);
        }
      }
    }

    // Super-light TOML currency parser:
    // Splits on [[CURRENCIES]], pulls key=value lines, strips quotes
    function parseCurrenciesFromToml(tomlText){
      const blocks = tomlText.split(/\n\s*\[\[CURRENCIES\]\]\s*\n/gi);
      const out = [];
      for (const blk of blocks){
        // Skip header before first [[CURRENCIES]]
        if(!/^\s*code\s*=|^\s*issuer\s*=/mi.test(blk)) continue;
        const entry = {};
        // Capture lines like: key = "value"
        const re = /^\s*([A-Za-z0-9_\-]+)\s*=\s*("?)(.*?)\2\s*$/gm;
        let m;
        while((m = re.exec(blk)) !== null){
          const k = m[1].toLowerCase();
          const v = m[3];
          entry[k] = v;
        }
        if (entry.code || entry.issuer || entry.image) out.push(entry);
      }
      return out;
    }

    function findImageFor(code, issuer, currencies){
      const codeUpper = String(code).toUpperCase();
      // First, exact match on issuer + code
      let hit = currencies.find(c => (c.code||"").toUpperCase()===codeUpper && (c.issuer||"").toUpperCase()===issuer.toUpperCase());
      // Then, match on code if unique
      if(!hit){
        const sameCode = currencies.filter(c => (c.code||"").toUpperCase()===codeUpper);
        if (sameCode.length === 1) hit = sameCode[0];
      }
      return hit?.image || null;
    }

    async function loadIcon(){
      const code = $("code").value.trim();
      const issuer = $("issuer").value.trim();
      $("result").style.display = "none";
      $("log").textContent = "";
      $("notes").textContent = "";

      if(!code || !issuer){ toast("Enter code and issuer."); return; }

      try{
        $("status").className = "badge";
        $("status").textContent = "Looking up on Horizon…";
        const { toml, record } = await fetchTomlLink(code, issuer);

        const domain = record?.home_domain || new URL(toml).hostname || "(unknown)";
        $("notes").innerHTML = `Issuer: <span class="badge">${issuer}</span> · Domain: <span class="badge">${domain}</span><br/>TOML: <a href="${toml}" target="_blank" rel="noreferrer">${toml}</a>`;
        $("log").textContent = `Horizon record:\n${pretty(record)}\n\nTOML URL: ${toml}`;

        $("status").textContent = "Fetching TOML…";
        const text = await fetchTomlText(toml);
        $("log").textContent += `\n\nTOML (first 400 chars):\n${text.slice(0,400)}…`;

        const currencies = parseCurrenciesFromToml(text);
        $("log").textContent += `\n\nParsed currencies found: ${currencies.length}`;

        const img = findImageFor(code, issuer, currencies) ||
                    // light fallback: try top-level "IMAGE" key
                    (text.match(/^\s*image\s*=\s*"?([^\n"]+)"?/mi)?.[1] || null);

        if (!img){
          $("status").textContent = "No image field for this asset";
          $("status").classList.add("err");
          toast("No image= in TOML for this asset.");
          return;
        }

        // Render pill
        $("ticker").textContent = code.toUpperCase();
        $("icon").src = img;
        $("icon").alt = code.toUpperCase() + " logo";
        $("result").style.display = "flex";
        $("status").textContent = "Icon loaded ✓";
        $("status").classList.add("ok");
      }catch(e){
        $("status").textContent = "Failed";
        $("status").classList.add("err");
        $("log").textContent += `\n\nERROR: ${e.message||e}`;
        toast(e.message || "Failed to load icon");
      }
    }

    $("load").addEventListener("click", loadIcon);

    // Quick AQUA test button
    $("tryAqua").addEventListener("click", ()=>{
      $("code").value = "AQUA";
      $("issuer").value = "GBNZILSTVQZ4R7IKQDGHYGY2QXL5QOFJYQMXPKWRRM5PAV7Y4M67AQUA";
      loadIcon();
    });

    // Enter to submit
    $("issuer").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadIcon(); });
    $("code").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadIcon(); });
  </script>
</body>
</html>
