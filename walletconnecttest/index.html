<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stellar â€” WalletConnect + Freighter (Extension & Mobile)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Freighter API (UMD global: window.freighterApi) -->
  <!-- IMPORTANT: non-self-closing tag -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/stellar-freighter-api/5.0.0/index.min.js"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>

  <!-- Stellar SDK (UMD) for building XDR + Horizon calls -->
  <script
    src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@14/dist/stellar-sdk.min.js"
    crossorigin="anonymous"
  ></script>

  <style>
    :root{--bg:#0b1220;--card:#121a2b;--border:#233055;--muted:#8ea2ff}
    body{margin:0;padding:28px;background:var(--bg);color:#f1f5ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .card{max-width:920px;margin:0 auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px 22px}
    h1{margin:0 0 12px;font-size:22px} h2{margin:18px 0 8px;font-size:18px}
    p{margin:0 0 10px;opacity:.95}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{opacity:.85;font-size:14px} .small{font-size:12px;opacity:.8}
    .addr{word-break:break-all;font-family:ui-monospace,Menlo,Consolas,monospace}
    button{cursor:pointer;font-weight:600;border-radius:10px;border:1px solid #3a4a7a;background:#1a2550;color:#fff;padding:10px 14px}
    button:hover{filter:brightness(1.1)} button.ghost{background:transparent}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3d7a;background:#0b1430;color:#fff}
    label{display:block;margin:10px 0 6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section{margin-top:18px;padding-top:14px;border-top:1px dashed #2b3b6a}
    .inline{display:inline-flex;gap:10px;align-items:center}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
    .open{display:flex}
    .modal-inner{width:min(560px,92vw);background:#0e1627;border:1px solid #22315c;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .x{background:none;border:none;color:var(--muted);font-size:22px;line-height:1;cursor:pointer}
    .wallet-btn{width:100%;padding:14px 16px;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
    .qr-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:12px}
    .qr-help{font-size:13px;opacity:.85;text-align:center}
    .wallet-choices{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .wallet-choices button{background:#162554;border:1px solid #344a8a}
    a.link{color:#9ab0ff;text-decoration:underline}
  </style>
</head>
<body>
  <div class="card">
    <h1>Stellar â€” WalletConnect + Freighter (Extension & Mobile)</h1>
    <p>Connect via <b>WalletConnect</b> (LOBSTR / Freighter mobile) or the <b>Freighter browser extension</b>. Build a payment XDR, sign, and optionally submit.</p>

    <div class="row" style="margin-top:10px">
      <button id="connectBtn">Connect Wallet</button>
      <button id="disconnectBtn" class="ghost" disabled>Disconnect</button>
      <span id="status" class="muted">Not connected</span>
    </div>

    <div class="section">
      <div class="inline">
        <strong>Network:</strong>
        <label class="inline"><input type="radio" name="net" value="pubnet" checked /> Public</label>
        <label class="inline"><input type="radio" name="net" value="testnet" /> Testnet</label>
      </div>
      <p class="small">Change before connecting (disconnect to switch later).</p>
    </div>

    <div id="connected" style="display:none" class="section">
      <div class="muted">Connected address:</div>
      <div id="address" class="addr"></div>

      <div style="margin-top:12px" class="row">
        <button id="signDemoBtn">Sign XDR (prompt)</button>
        <button id="signAndSubmitPromptBtn">Sign &amp; Submit (prompt)</button>
      </div>
      <p id="signResult" class="small" style="margin-top:6px"></p>
    </div>

    <div class="section">
      <h2>Build Payment XDR</h2>
      <p class="small">Builds a native XLM payment from your connected address (fetches sequence &amp; base fee from Horizon).</p>

      <div class="grid">
        <div><label for="dest">Destination (Gâ€¦)</label><input id="dest" placeholder="Gâ€¦ destination address" /></div>
        <div><label for="amount">Amount (XLM)</label><input id="amount" type="number" min="0" step="0.0000001" placeholder="10.5" /></div>
      </div>

      <label for="memo">Memo (optional)</label>
      <input id="memo" maxlength="28" placeholder="Thanks AQUA!" />

      <div class="row" style="margin-top:10px">
        <button id="buildBtn">Build XDR</button>
        <span id="buildStatus" class="small"></span>
      </div>

      <label for="xdrOut" style="margin-top:12px">Transaction XDR</label>
      <textarea id="xdrOut" rows="6" placeholder="Built XDR appears here"></textarea>

      <div class="row" style="margin-top:10px">
        <button id="signBuiltBtn">Sign XDR (wallet)</button>
        <button id="signAndSubmitBuiltBtn">Sign &amp; Submit (wallet)</button>
        <button id="submitSignedBtn" class="ghost">Submit signed XDR (Horizon)</button>
      </div>
      <p id="submitResult" class="small" style="margin-top:6px"></p>
    </div>
  </div>

  <!-- Modal -->
  <div id="backdrop" class="backdrop"></div>
  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-inner">
      <div class="modal-header">
        <h2 id="loginTitle" style="font-size:18px;margin:0">Login</h2>
        <button class="x" id="closeModal" aria-label="Close">Ã—</button>
      </div>

      <p>Select a login method:</p>
      <button class="wallet-btn" id="wcBtn">ðŸ”— WalletConnect (mobile)</button>
      <button class="wallet-btn" id="freighterExtBtn">ðŸ§© Freighter (browser extension)</button>

      <!-- WalletConnect QR + wallet choices -->
      <div id="qrArea" class="qr-wrap" style="display:none">
        <canvas id="qrCanvas" width="256" height="256" style="background:#fff;border-radius:12px"></canvas>
        <div class="wallet-choices" aria-label="Open with wallet">
          <button id="btnLobstr" aria-label="Open in LOBSTR">Open in LOBSTR</button>
          <button id="btnFreighter" aria-label="Open in Freighter (mobile)">Open in Freighter</button>
        </div>
        <div class="qr-help">
          Scan with your wallet app (LOBSTR / Freighter),<br/>
          or tap a button above on mobile. Â· <a id="rawWcLink" class="link" href="#" target="_blank" rel="noreferrer">raw wc link</a>
        </div>
        <p id="linkStatus" class="small" style="margin:0;text-align:center;opacity:.8"></p>
      </div>
    </div>
  </div>

  <script>window.process = window.process || { env: {} };</script>

  <script type="module">
    // --------- Ensure Freighter API is present (UMD global or ESM fallback) ----------
    async function ensureFreighterApi(){
      if (window.freighterApi) return window.freighterApi;
      try {
        const mod = await import('https://esm.sh/@stellar/freighter-api@5.0.0');
        window.freighterApi = mod?.default ?? mod;
        return window.freighterApi;
      } catch (e) {
        console.error('Failed to import @stellar/freighter-api via ESM', e);
        return null;
      }
    }

    import SignClient from "https://esm.sh/@walletconnect/sign-client@2.21.8";
    import QRCode     from "https://esm.sh/qrcode@1.5.3";

    // ------- Config / helpers -------
    const EXPLORER   = "https://explorer-api.walletconnect.com/v3/wallets";
    const PROJECT_ID = "f658ce3a7c8a185214974f71539fea39";

    const STORE = {
      lobstr:   { ios:"https://apps.apple.com/app/id1404357892",                      android:"https://play.google.com/store/apps/details?id=com.lobstr.client" },
      freighter:{ ios:"https://apps.apple.com/app/freighter/id6743947720",           android:"https://play.google.com/store/apps/details?id=org.stellar.freighterwallet&pli=1" }
    };

    const $  = (id)=>document.getElementById(id);
    const on = (el,ev,fn)=>el&&el.addEventListener(ev,fn);
    const isIOS = ()=>/iPhone|iPad|iPod/i.test(navigator.userAgent);

    // DOM
    const connectBtn=$("connectBtn"), disconnectBtn=$("disconnectBtn"), statusEl=$("status");
    const connectedWrap=$("connected"), addrEl=$("address");
    const signBtn=$("signDemoBtn"), signSubmitPromptBtn=$("signAndSubmitPromptBtn"), signResult=$("signResult");
    const buildBtn=$("buildBtn"), buildStatus=$("buildStatus"), xdrOut=$("xdrOut");
    const destEl=$("dest"), amountEl=$("amount"), memoEl=$("memo");
    const signBuiltBtn=$("signBuiltBtn"), signAndSubmitBuiltBtn=$("signAndSubmitBuiltBtn");
    const submitSignedBtn=$("submitSignedBtn"), submitResult=$("submitResult");
    const backdrop=$("backdrop"), loginModal=$("loginModal"), closeModalBtn=$("closeModal");
    const wcBtn=$("wcBtn"), freighterExtBtn=$("freighterExtBtn");
    const qrArea=$("qrArea"), qrCanvas=$("qrCanvas"), linkStatus=$("linkStatus");
    const btnLobstr=$("btnLobstr"), btnFreighter=$("btnFreighter"), rawWcLink=$("rawWcLink");

    // Modal
    const openModal = ()=>{backdrop.classList.add("open");loginModal.classList.add("open");};
    const closeModal= ()=>{backdrop.classList.remove("open");loginModal.classList.remove("open");};
    on(closeModalBtn,"click",closeModal); on(backdrop,"click",closeModal);
    on(connectBtn,"click",openModal);

    // Stellar SDK
    if(!window.StellarSdk) throw new Error("Stellar SDK failed to load.");
    const SDK = window.StellarSdk;
    const ServerCtor = SDK.Server || SDK.Horizon?.Server;
    const { Networks, TransactionBuilder, Operation, Asset, Memo } = SDK;

    // Network
    let CURRENT_NET="pubnet";
    const chainId=()=>`stellar:${CURRENT_NET}`;
    const horizonUrl=()=>CURRENT_NET==="pubnet"?"https://horizon.stellar.org":"https://horizon-testnet.stellar.org";
    const netPassphrase=()=>CURRENT_NET==="pubnet"?Networks.PUBLIC:Networks.TESTNET;
    document.querySelectorAll('input[name="net"]').forEach(r=>on(r,"change",()=>{
      if(session || connectionMode!=="none"){ alert("Disconnect first to switch networks."); return; }
      CURRENT_NET=r.value;
    }));

    // Connection mode: 'none' | 'wc' | 'freighter'
    let connectionMode = "none";

    // WalletConnect
    let client=null, session=null, latestWcUri=null;
    async function ensureClient(){
      if(!client){
        client = await SignClient.init({ projectId: PROJECT_ID });
        console.log("WalletConnect SignClient ready");
      }
    }

    // LOBSTR deep link
    function openLobstrApp(wcUri){
      const scheme = `lobstr://wc?uri=${encodeURIComponent(wcUri)}`;
      const store  = isIOS()? STORE.lobstr.ios : STORE.lobstr.android;
      const t0 = Date.now();
      window.location.href = scheme;
      setTimeout(()=>{
        if(!document.hidden && Date.now()-t0 < 2000){
          window.open(store, "_blank", "noopener");
        }
      }, 1800);
    }

    // Freighter mobile deep links (Explorer)
    async function getFreighterLinks(){
      try{
        const url = `${EXPLORER}?projectId=${encodeURIComponent(PROJECT_ID)}&entries=200&page=1`;
        const res = await fetch(url);
        const data = await res.json();
        const raw = data?.listings ?? data?.data ?? [];
        const arr = Array.isArray(raw) ? raw : Object.values(raw);
        const w = arr.find(item => {
          const n = (item.name || item.app?.name || "").toLowerCase().trim();
          return n === "freighter" || n.includes("freighter");
        });
        const mobile = w?.mobile || w?.app?.mobile || {};
        return {
          native:    mobile.native || mobile.nativeLink || null,
          universal: mobile.universal || mobile.universalLink || null,
          found: !!w
        };
      }catch(e){
        console.warn("Explorer fetch failed:", e);
        return { native:null, universal:null, found:false };
      }
    }
    function buildCandidates(base, wcUri){
      if(!base) return [];
      const enc = encodeURIComponent(wcUri);
      if (base.includes("{wc}") || base.includes("{URI}")) {
        return [ base.replace("{wc}", enc).replace("{URI}", enc) ];
      }
      const hasQ = base.includes("?"); const j = hasQ ? "&" : "?";
      return [ `${base}${j}wc=${enc}`, `${base}${j}uri=${enc}` ];
    }
    function openFreighterSmart(links, wcUri){
      const store = isIOS()? STORE.freighter.ios : STORE.freighter.android;
      const natives = buildCandidates(links.native, wcUri);
      const universals = buildCandidates(links.universal, wcUri);

      let attempted = false;
      for (const href of natives){
        attempted = true;
        window.location.href = href;
        setTimeout(()=>{}, 350);
      }
      if (universals.length){
        attempted = true;
        window.open(universals[0], "_blank", "noopener");
      }
      if (!attempted){
        window.open(store, "_blank", "noopener");
      }
    }

    // WalletConnect flow
    on(wcBtn,"click", async ()=>{
      try{
        await ensureClient();
        statusEl.textContent = "Starting WalletConnectâ€¦";

        const { uri, approval } = await client.connect({
          optionalNamespaces: {
            stellar: { chains:[chainId()], methods:["stellar_signXDR","stellar_signAndSubmitXDR"], events:[] }
          }
        });
        if(!uri) throw new Error("No WC URI");
        latestWcUri = uri;

        await QRCode.toCanvas(qrCanvas, uri, { width:256, margin:1 });
        qrArea.style.display = "flex";
        rawWcLink.href = uri;

        linkStatus.textContent = "Loading Freighter deep linkâ€¦";
        const freighterLinks = await getFreighterLinks();
        linkStatus.textContent = freighterLinks.found ? "" : "Freighter link not found â€” store fallback.";

        const newL = btnLobstr.cloneNode(true), newF = btnFreighter.cloneNode(true);
        btnLobstr.replaceWith(newL); btnFreighter.replaceWith(newF);
        newL.addEventListener("click", ()=> openLobstrApp(latestWcUri));
        newF.addEventListener("click", ()=> openFreighterSmart(freighterLinks, latestWcUri));

        session = await approval();
        connectionMode = "wc";

        qrArea.style.display = "none"; closeModal();

        const accounts = session.namespaces?.stellar?.accounts || [];
        const first = accounts.find(a=>a.startsWith(chainId())) || accounts[0] || "";
        const address = first.split(":")[2] || "(unknown)";
        addrEl.textContent = address;
        connectedWrap.style.display = "block";
        statusEl.textContent = `Connected via WalletConnect (${CURRENT_NET})`;
        disconnectBtn.disabled = false;
        document.querySelectorAll('input[name="net"]').forEach(r=>r.disabled=true);
      }catch(e){
        console.error(e);
        statusEl.textContent = "Connection canceled or failed.";
      }
    });

    // ===== Freighter EXTENSION path (uses ensured freighterApi) =====
    let freighterPoll = null;
    function getFreighter(){ return window.freighterApi; }
    function hasFreighterConnect(api){
      return !!(api && (typeof api.getAddress==='function' || typeof api.requestAccess==='function' || typeof api.getPublicKey==='function'));
    }
    async function waitForFreighter(maxMs=6000, intervalMs=250){
      await ensureFreighterApi();
      if (hasFreighterConnect(getFreighter())) return true;
      return new Promise(resolve=>{
        const start=Date.now();
        freighterPoll = setInterval(async ()=>{
          await ensureFreighterApi();
          if (hasFreighterConnect(getFreighter()) || Date.now()-start>maxMs){
            clearInterval(freighterPoll); freighterPoll=null;
            resolve(hasFreighterConnect(getFreighter()));
          }
        }, intervalMs);
      });
    }
    async function getFreighterAddressSafe(api){
      try{
        if (api?.getAddress) {
          const r = await api.getAddress();
          if (r?.address) return r.address;
        }
        if (api?.requestAccess) {
          const r = await api.requestAccess();
          if (r?.address) return r.address;
        }
        if (api?.getPublicKey) {
          const pk = await api.getPublicKey();
          if (pk) return pk;
        }
      }catch(_){}
      return "";
    }

    on(freighterExtBtn,"click", async ()=>{
      try{
        const found = await waitForFreighter();
        if(!found){
          alert("Freighter extension not detected. Opening the Chrome Web Store page.");
          window.open("https://chromewebstore.google.com/detail/freighter/bkakmcofbanhnhfkkmlgmmohbcnkgkdk", "_blank", "noopener");
          return;
        }
        const api = getFreighter();
        const pubkey = await getFreighterAddressSafe(api);
        if(!pubkey) throw new Error("Access denied or no address");

        connectionMode = "freighter";
        addrEl.textContent = pubkey;
        connectedWrap.style.display = "block";
        statusEl.textContent = `Connected via Freighter extension (${CURRENT_NET})`;
        disconnectBtn.disabled = false;
        document.querySelectorAll('input[name="net"]').forEach(r=>r.disabled=true);
        closeModal();
      }catch(e){
        console.error(e);
        alert("Freighter connect failed or was canceled.");
      }
    });

    // Disconnect for both modes
    on(disconnectBtn,"click", async ()=>{
      try{
        if(connectionMode==="wc" && client && session){
          await client.disconnect({ topic: session.topic, reason:{ code:6000, message:"User disconnected" }});
        }
      }catch(e){ console.warn("disconnect error", e); }
      session=null; connectionMode="none";
      connectedWrap.style.display="none"; addrEl.textContent="";
      statusEl.textContent="Not connected"; disconnectBtn.disabled=true;
      document.querySelectorAll('input[name=\"net\"]').forEach(r=>r.disabled=false);
    });

    // Sign helpers
    const wcRequest = (method, xdr) => client.request({
      topic: session.topic, chainId: chainId(),
      request: { jsonrpc:"2.0", method, params:{ xdr } }
    });

    async function signXdrWithCurrentWallet(xdr){
      if(connectionMode==="wc"){
        const r = await wcRequest("stellar_signXDR", xdr);
        if(!r?.signedXDR) throw new Error("WalletConnect: no signedXDR returned");
        return r.signedXDR;
      }
      if(connectionMode==="freighter"){
        const api = getFreighter();
        const address = await getFreighterAddressSafe(api);
        const res = await api.signTransaction(xdr, { networkPassphrase: netPassphrase(), address });
        if (res?.error) throw new Error(res.error.message || "Freighter: sign failed");
        return res.signedTxXdr || res.signedXDR || res;
      }
      throw new Error("Not connected");
    }

    async function signAndSubmitWithCurrentWallet(xdr){
      const signedXdr = await signXdrWithCurrentWallet(xdr);
      const resp = await fetch(`${horizonUrl()}/transactions`,{
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body:"tx="+encodeURIComponent(signedXdr)
      });
      const data = await resp.json();
      if(!resp.ok) throw new Error("Horizon error: "+(data?.extras?.result_codes?.transaction||resp.status));
      return { hash: data.hash, signedXdr };
    }

    // Prompt flows
    on(signBtn,"click", async ()=>{
      const xdr = prompt("Paste a Transaction XDR to sign");
      if(!xdr){ signResult.textContent="No XDR provided."; return; }
      try{
        signResult.textContent="Signingâ€¦";
        const signed = await signXdrWithCurrentWallet(xdr);
        console.log("signedXDR:", signed);
        signResult.textContent="Signed âœ“ (check console)";
      }catch(e){ console.error(e); signResult.textContent=e.message || "Signing failed."; }
    });

    on(signAndSubmitPromptBtn,"click", async ()=>{
      const xdr = prompt("Paste a Transaction XDR to sign & submit");
      if(!xdr){ signResult.textContent="No XDR provided."; return; }
      try{
        signResult.textContent="Submittingâ€¦";
        const res = await signAndSubmitWithCurrentWallet(xdr);
        console.log("submit result:", res);
        signResult.textContent=`Submitted âœ“ tx: ${res.hash}`;
      }catch(e){ console.error(e); signResult.textContent=e.message || "Sign & submit failed."; }
    });

    // Build XDR (native payment)
    async function buildPaymentXDR({ source, destination, amount, memo }){
      const server=new ServerCtor(horizonUrl());
      const account=await server.loadAccount(source);
      const baseFee=await server.fetchBaseFee();
      const tb=new TransactionBuilder(account,{ fee:String(baseFee), networkPassphrase: netPassphrase() })
        .addOperation(Operation.payment({ destination, asset: Asset.native(), amount: String(amount) }))
        .setTimeout(300);
      if(memo) tb.addMemo(Memo.text(memo));
      return tb.build().toXDR();
    }

    const connectedAddress = ()=> addrEl.textContent.trim().startsWith("G") ? addrEl.textContent.trim() : null;

    on(buildBtn,"click", async ()=>{
      buildStatus.textContent="";
      const source=connectedAddress();
      if(!source){ buildStatus.textContent="Connect first."; return; }
      const destination=destEl.value.trim(), amount=amountEl.value.trim(), memo=memoEl.value.trim();
      if(!/^G[A-Z2-7]{55}$/.test(destination)){ buildStatus.textContent="Invalid destination."; return; }
      if(!amount || Number(amount)<=0){ buildStatus.textContent="Enter amount."; return; }
      try{
        buildStatus.textContent="Buildingâ€¦";
        xdrOut.value = await buildPaymentXDR({ source, destination, amount, memo });
        buildStatus.textContent="Built âœ“";
      }catch(e){ console.error(e); buildStatus.textContent="Failed to build XDR."; }
    });

    // Built-XDR sign/submit buttons
    on(signBuiltBtn,"click", async ()=>{
      const xdr=xdrOut.value.trim(); if(!xdr){ submitResult.textContent="Build or paste an XDR first."; return; }
      if(connectionMode==="none"){ submitResult.textContent="Connect first."; return; }
      submitResult.textContent="Signingâ€¦";
      try{
        const signed = await signXdrWithCurrentWallet(xdr);
        xdrOut.value = signed;
        submitResult.textContent="Signed XDR âœ“";
      }catch(e){ console.error(e); submitResult.textContent=e.message || "Signing failed."; }
    });

    on(signAndSubmitBuiltBtn,"click", async ()=>{
      const xdr=xdrOut.value.trim(); if(!xdr){ submitResult.textContent="Build or paste an XDR first."; return; }
      if(connectionMode==="none"){ submitResult.textContent="Connect first."; return; }
      submitResult.textContent="Submittingâ€¦";
      try{
        const res = await signAndSubmitWithCurrentWallet(xdr);
        submitResult.textContent=`Submitted âœ“ tx: ${res.hash}`;
        console.log("submit result:", res);
      }catch(e){ console.error(e); submitResult.textContent=e.message || "Sign & submit failed."; }
    });

    on(submitSignedBtn,"click", async ()=>{
      const xdr=xdrOut.value.trim(); if(!xdr){ submitResult.textContent="Need a signed XDR."; return; }
      submitResult.textContent="Submitting to Horizonâ€¦";
      try{
        const resp = await fetch(`${horizonUrl()}/transactions`,{
          method:"POST",
          headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
          body:"tx="+encodeURIComponent(xdr)
        });
        const data = await resp.json();
        if(resp.ok){ submitResult.textContent=`Horizon OK âœ“ tx: ${data.hash}`; }
        else{ submitResult.textContent="Horizon error (check console)."; console.error("Horizon error:", data); }
      }catch(e){ console.error(e); submitResult.textContent="Network/submit error."; }
    });

    // Re-check Freighter when tab regains focus (user may have just installed/unlocked)
    window.addEventListener('focus', ()=>{ ensureFreighterApi(); });
  </script>

  <noscript style="color:#fff">Enable JavaScript to use WalletConnect.</noscript>
</body>
</html>
