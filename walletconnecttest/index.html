<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stellar WalletConnect v2 â€” Static Demo (QR + XDR Builder)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{--bg:#0b1220;--card:#121a2b;--border:#233055;--muted:#8ea2ff}
    body{margin:0;padding:28px;background:var(--bg);color:#f1f5ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .card{max-width:920px;margin:0 auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px 22px}
    h1{margin:0 0 12px;font-size:22px}
    h2{margin:18px 0 8px;font-size:18px}
    p{margin:0 0 10px;opacity:.95}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{opacity:.85;font-size:14px}
    .small{font-size:12px;opacity:.8}
    .addr{word-break:break-all;font-family:ui-monospace,Menlo,Consolas,monospace}
    button{cursor:pointer;font-weight:600;border-radius:10px;border:1px solid #3a4a7a;background:#1a2550;color:#fff;padding:10px 14px}
    button:hover{filter:brightness(1.1)}
    button.ghost{background:transparent}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3d7a;background:#0b1430;color:#fff}
    label{display:block;margin:10px 0 6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section{margin-top:18px;padding-top:14px;border-top:1px dashed #2b3b6a}
    .inline{display:inline-flex;gap:10px;align-items:center}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
    .open{display:flex}
    .modal-inner{width:min(540px,92vw);background:#0e1627;border:1px solid #22315c;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .x{background:none;border:none;color:var(--muted);font-size:22px;line-height:1;cursor:pointer}
    .wallet-btn{width:100%;padding:14px 16px;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
    .qr-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:12px}
    .qr-help{font-size:13px;opacity:.85;text-align:center}
    .wallet-choices{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .wallet-choices button{background:#162554;border:1px solid #344a8a}
    a.link{color:#9ab0ff;text-decoration:underline}
  </style>

  <!-- Stellar SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@14/dist/stellar-sdk.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="card">
    <h1>Stellar WalletConnect v2 â€” Static Demo</h1>
    <p>Connect a Stellar wallet via WalletConnect v2. On desktop youâ€™ll see a QR; on mobile pick a wallet (LOBSTR, Freighter, xBull Wallet). Build a payment XDR, sign, and optionally submit.</p>

    <div class="row" style="margin-top:10px">
      <button id="connectBtn">Connect Wallet</button>
      <button id="disconnectBtn" class="ghost" disabled>Disconnect</button>
      <span id="status" class="muted">Not connected</span>
    </div>

    <div class="section">
      <div class="inline">
        <strong>Network:</strong>
        <label class="inline"><input type="radio" name="net" value="pubnet" checked /> Public</label>
        <label class="inline"><input type="radio" name="net" value="testnet" /> Testnet</label>
      </div>
      <p class="small">Change before connecting (disconnect to switch later).</p>
    </div>

    <div id="connected" style="display:none" class="section">
      <div class="muted">Connected address:</div>
      <div id="address" class="addr"></div>

      <div style="margin-top:12px" class="row">
        <button id="signDemoBtn">Sign XDR (prompt)</button>
        <button id="signAndSubmitPromptBtn">Sign &amp; Submit (prompt)</button>
      </div>
      <p id="signResult" class="small" style="margin-top:6px"></p>
    </div>

    <div class="section">
      <h2>Build Payment XDR</h2>
      <div class="grid">
        <div>
          <label for="dest">Destination (Gâ€¦)</label>
          <input id="dest" placeholder="Gâ€¦ destination address" />
        </div>
        <div>
          <label for="amount">Amount (XLM)</label>
          <input id="amount" type="number" min="0" step="0.0000001" placeholder="10.5" />
        </div>
      </div>
      <label for="memo">Memo (optional)</label>
      <input id="memo" maxlength="28" placeholder="Thanks AQUA!" />
      <div class="row" style="margin-top:10px">
        <button id="buildBtn">Build XDR</button>
        <span id="buildStatus" class="small"></span>
      </div>
      <label for="xdrOut" style="margin-top:12px">Transaction XDR</label>
      <textarea id="xdrOut" rows="6" placeholder="Built XDR appears here"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="signBuiltBtn">Sign XDR (wallet)</button>
        <button id="signAndSubmitBuiltBtn">Sign &amp; Submit (wallet)</button>
        <button id="submitSignedBtn" class="ghost">Submit signed XDR (Horizon)</button>
      </div>
      <p id="submitResult" class="small" style="margin-top:6px"></p>
    </div>
  </div>

  <div id="backdrop" class="backdrop"></div>
  <div id="loginModal" class="modal">
    <div class="modal-inner">
      <div class="modal-header">
        <h2 id="loginTitle" style="font-size:18px;margin:0">Login</h2>
        <button class="x" id="closeModal">Ã—</button>
      </div>
      <p>Select a login method:</p>
      <button class="wallet-btn" id="wcBtn">ðŸ”— WalletConnect</button>
      <div id="qrArea" class="qr-wrap" style="display:none">
        <canvas id="qrCanvas" width="256" height="256" style="background:#fff;border-radius:12px"></canvas>
        <div class="wallet-choices">
          <button id="btnLobstr">Open in LOBSTR</button>
          <button id="btnFreighter">Open in Freighter</button>
          <button id="btnXbull">Open in xBull Wallet</button>
        </div>
        <div class="qr-help">
          Scan with your wallet app (LOBSTR / Freighter / xBull Wallet),<br/>
          or tap a button above on mobile. Â· <a id="rawWcLink" class="link" href="#" target="_blank" rel="noreferrer">raw wc link</a>
        </div>
      </div>
    </div>
  </div>

  <script>window.process = window.process || { env: {} };</script>

  <script type="module">
    import SignClient from "https://esm.sh/@walletconnect/sign-client@2.21.8";
    import QRCode from "https://esm.sh/qrcode@1.5.3";

    if (!window.StellarSdk) throw new Error("Stellar SDK failed to load.");
    const SDK = window.StellarSdk;
    const ServerCtor = SDK.Server || SDK.Horizon?.Server;
    const { Networks, TransactionBuilder, Operation, Asset, Memo } = SDK;

    const PROJECT_ID = "f658ce3a7c8a185214974f71539fea39";
    const $ = (id)=>document.getElementById(id);
    const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn);
    const isIOS = ()=>/iPhone|iPad|iPod/i.test(navigator.userAgent);

    const connectBtn=$("connectBtn"), disconnectBtn=$("disconnectBtn"), statusEl=$("status");
    const connectedWrap=$("connected"), addrEl=$("address");
    const signBtn=$("signDemoBtn"), signSubmitPromptBtn=$("signAndSubmitPromptBtn"), signResult=$("signResult");
    const buildBtn=$("buildBtn"), buildStatus=$("buildStatus"), xdrOut=$("xdrOut");
    const destEl=$("dest"), amountEl=$("amount"), memoEl=$("memo");
    const signBuiltBtn=$("signBuiltBtn"), signAndSubmitBuiltBtn=$("signAndSubmitBuiltBtn");
    const submitSignedBtn=$("submitSignedBtn"), submitResult=$("submitResult");
    const backdrop=$("backdrop"), loginModal=$("loginModal"), closeModalBtn=$("closeModal"), wcBtn=$("wcBtn");
    const qrArea=$("qrArea"), qrCanvas=$("qrCanvas");
    const btnLobstr=$("btnLobstr"), btnFreighter=$("btnFreighter"), btnXbull=$("btnXbull"), rawWcLink=$("rawWcLink");

    const openModal=()=>{backdrop.classList.add("open");loginModal.classList.add("open");};
    const closeModal=()=>{backdrop.classList.remove("open");loginModal.classList.remove("open");};
    on(closeModalBtn,"click",closeModal); on(backdrop,"click",closeModal);

    let CURRENT_NET="pubnet";
    const netRadios=document.querySelectorAll('input[name="net"]');
    netRadios.forEach(r=>on(r,"change",()=>{ if(session){alert("Disconnect first");return;} CURRENT_NET=r.value; }));
    const chainId=()=>`stellar:${CURRENT_NET}`;
    const horizonUrl=()=>CURRENT_NET==="pubnet"?"https://horizon.stellar.org":"https://horizon-testnet.stellar.org";
    const netPassphrase=()=>CURRENT_NET==="pubnet"?Networks.PUBLIC:Networks.TESTNET;

    let client=null, session=null;
    async function ensureClient(){ if(!client){ client=await SignClient.init({projectId:PROJECT_ID}); console.log("WalletConnect ready"); } }

    on(connectBtn,"click",openModal);

    function openLobstrApp(wcUri){
      const encoded=encodeURIComponent(wcUri);
      const schemeUrl=`lobstr://wc?uri=${encoded}`;
      const store=isIOS()? "https://apps.apple.com/app/id1404357892" :"https://play.google.com/store/apps/details?id=com.lobstr.client";
      const t0=Date.now();
      window.location.href=schemeUrl;
      setTimeout(()=>{
        if(!document.hidden && Date.now()-t0<2000){
          window.open(store,"_blank","noopener");
        }
      },1800);
    }

    function openUniversalNewTab(url){ window.open(url,"_blank","noopener"); }

    on(wcBtn,"click",async()=>{
      try{
        await ensureClient();
        statusEl.textContent="Starting WalletConnectâ€¦";
        const { uri, approval }=await client.connect({
          optionalNamespaces:{ stellar:{ chains:[chainId()], methods:["stellar_signXDR","stellar_signAndSubmitXDR"], events:[] } }
        });
        if(!uri) throw new Error("No URI");
        await QRCode.toCanvas(qrCanvas,uri,{width:256});
        qrArea.style.display="flex";
        rawWcLink.href=uri;

        on(btnLobstr,"click",()=>openLobstrApp(uri));
        on(btnFreighter,"click",()=>openUniversalNewTab(`https://freighter.app/wc?uri=${encodeURIComponent(uri)}`));
        on(btnXbull,"click",()=>openUniversalNewTab(`https://xbull.app/wc?uri=${encodeURIComponent(uri)}`));

        session=await approval();
        qrArea.style.display="none"; closeModal();

        const accounts=session.namespaces?.stellar?.accounts||[];
        const address=accounts[0]?.split(":")[2]||"(unknown)";
        addrEl.textContent=address; connectedWrap.style.display="block";
        statusEl.textContent=`Connected (${CURRENT_NET})`; disconnectBtn.disabled=false;
      }catch(e){console.error(e);statusEl.textContent="Connection failed.";}
    });

    on(disconnectBtn,"click",async()=>{
      try{ if(client&&session){ await client.disconnect({topic:session.topic,reason:{code:6000,message:"User disconnected"}}); } }catch{}
      session=null; connectedWrap.style.display="none"; addrEl.textContent=""; statusEl.textContent="Not connected";
    });

    const wcRequest=(method,xdr)=>client.request({topic:session.topic,chainId:chainId(),request:{jsonrpc:"2.0",method,params:{xdr}}});

    on(signBtn,"click",async()=>{
      if(!session) return; const xdr=prompt("Paste XDR"); if(!xdr) return;
      try{const r=await wcRequest("stellar_signXDR",xdr);console.log(r);signResult.textContent="Signed âœ“";}catch{signResult.textContent="Failed";}
    });

    on(signAndSubmitPromptBtn,"click",async()=>{
      if(!session) return; const xdr=prompt("Paste XDR"); if(!xdr) return;
      try{const r=await wcRequest("stellar_signAndSubmitXDR",xdr);console.log(r);signResult.textContent="Submitted âœ“";}catch{signResult.textContent="Failed";}
    });

    async function buildPaymentXDR({source,destination,amount,memo}){
      const server=new ServerCtor(horizonUrl()); const account=await server.loadAccount(source);
      const baseFee=await server.fetchBaseFee();
      const tb=new TransactionBuilder(account,{fee:String(baseFee),networkPassphrase:netPassphrase()})
        .addOperation(Operation.payment({destination,asset:Asset.native(),amount:String(amount)})).setTimeout(300);
      if(memo) tb.addMemo(Memo.text(memo)); return tb.build().toXDR();
    }

    const connectedAddress=()=>addrEl.textContent.startsWith("G")?addrEl.textContent.trim():null;

    on(buildBtn,"click",async()=>{
      buildStatus.textContent=""; const source=connectedAddress();
      if(!source){buildStatus.textContent="Connect first.";return;}
      const dest=destEl.value.trim(),amt=amountEl.value.trim(),memo=memoEl.value.trim();
      if(!/^G[A-Z2-7]{55}$/.test(dest)){buildStatus.textContent="Bad destination";return;}
      try{xdrOut.value=await buildPaymentXDR({source,destination:dest,amount:amt,memo});buildStatus.textContent="Built âœ“";}catch(e){console.error(e);buildStatus.textContent="Error";}
    });

    on(signBuiltBtn,"click",async()=>{
      if(!session){submitResult.textContent="Connect first.";return;}
      const xdr=xdrOut.value.trim(); if(!xdr){submitResult.textContent="No XDR";return;}
      try{const r=await wcRequest("stellar_signXDR",xdr);if(r?.signedXDR){xdrOut.value=r.signedXDR;submitResult.textContent="Signed âœ“";}}catch{submitResult.textContent="Fail";}
    });

    on(signAndSubmitBuiltBtn,"click",async()=>{
      if(!session){submitResult.textContent="Connect first.";return;}
      const xdr=xdrOut.value.trim(); if(!xdr){submitResult.textContent="No XDR";return;}
      try{const r=await wcRequest("stellar_signAndSubmitXDR",xdr);console.log(r);submitResult.textContent="Submitted âœ“";}catch{submitResult.textContent="Fail";}
    });

    on(submitSignedBtn,"click",async()=>{
      const xdr=xdrOut.value.trim(); if(!xdr){submitResult.textContent="Need XDR";return;}
      try{const res=await fetch(`${horizonUrl()}/transactions`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"tx="+encodeURIComponent(xdr)});const j=await res.json();submitResult.textContent=res.ok?`OK âœ“ tx: ${j.hash}`:"Horizon error";}catch{submitResult.textContent="Network fail";}
    });
  </script>

  <noscript style="color:#fff">Enable JavaScript.</noscript>
</body>
</html>
