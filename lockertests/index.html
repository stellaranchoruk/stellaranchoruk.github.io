<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mirrasets â€” AQUAm25 Locker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Freighter API (UMD) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-freighter-api/5.0.0/index.min.js"
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Stellar SDK (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@14/dist/stellar-sdk.min.js"
    crossorigin="anonymous"></script>

  <style>
    :root { --bg:#0b1220; --card:#121a2b; --border:#233055; --muted:#8ea2ff; }
    * { box-sizing: border-box; }
    body { margin:0; padding:28px; background:var(--bg); color:#f1f5ff; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap{max-width:980px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px}
    h1{margin:0 0 10px} h2{margin:18px 0 8px}
    p{margin:.25rem 0 .75rem;opacity:.96}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;opacity:.8}
    .muted{opacity:.85}
    button{cursor:pointer;font-weight:600;border-radius:10px;border:1px solid #3a4a7a;background:#1a2550;color:#fff;padding:10px 14px;transition:.15s}
    button:hover{filter:brightness(1.08)}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3d7a;background:#0b1430;color:#fff}
    input[readonly]{opacity:.9;background:#0a1230;border-style:dashed}
    label{display:block;margin:10px 0 6px}
    .section{margin-top:20px;padding-top:14px;border-top:1px dashed #2b3b6a}
    .box{background:#0e1627;border:1px solid #22315c;border-radius:12px;padding:14px}
    .pct{display:flex;gap:8px;margin-top:6px}
    .pct button{flex:1;background:#162554;border:1px solid #344a8a}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
    .open{display:flex}
    .modal-inner{width:min(560px,92vw);background:#0e1627;border:1px solid #22315c;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .x{background:none;border:none;color:var(--muted);font-size:22px;line-height:1;cursor:pointer}
    .wallet-btn{width:100%;padding:14px 16px;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
    .qr-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:12px}
    .wallet-choices{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .wallet-choices button{background:#162554;border:1px solid #344a8a}
    a.link{color:#9ab0ff;text-decoration:underline}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}

    /* New: little chips for selected asset + balance */
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #2a3d7a;background:#0b1430;border-radius:999px;padding:6px 10px;font-size:12px;opacity:.95}
    .chip img{width:16px;height:16px;border-radius:50%;object-fit:cover;background:#111}
    .chip .fallback{width:16px;height:16px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#1a2550;font-weight:700}
    .label-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .linkish{border:none;background:transparent;color:#9ab0ff;text-decoration:underline;padding:0;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>AQUAm25 Interest Earning Locker</h1>
      <p>Earn interest on your AQUAm25 by locking it for 1 year! Simply enter a <b>Public Key</b> manually or connect a wallet, then proceed to lock. We'll send your interest every week on Sundays until your lock ends, at which point you'll need to relock to continue earning interest.</p>

      <div class="row" style="margin-top:8px">
        <button id="connectBtn">Connect Wallet</button>
        <button id="disconnectBtn" class="ghost" disabled>Disconnect</button>
        <span id="status" class="muted" aria-live="polite">Not connected</span>
      </div>

      <!-- Connection -->
      <div class="section box" style="margin-top:20px">
        <h2>Connection</h2>
        <p class="small">Mode: <b id="mode">â€”</b></p>
        <p class="small">Address: <span id="addr" style="word-break:break-all"></span></p>
        <p class="small">Network: <b>Public</b></p>
        <p class="small">Tip: Using mobile? Choose LOBSTR or Freighter from the WalletConnect popup.</p>
      </div>

      <!-- Swap -->
      <div class="section box" id="swapBox">
        <h2>Swap</h2>
        <p class="small">Swap any Stellar token you hold into AQUAm25 using the network DEX.</p>

        <!-- Row 1: From & Amount -->
        <div class="row" style="gap:14px">
          <div style="flex:1;min-width:260px">
            <div class="label-row">
              <label for="swapFrom" style="margin-bottom:0">From</label>
              <!-- Selected asset chip with logo + domain -->
              <span id="selectedAssetChip" class="chip" title="Selected asset" style="display:none">
                <span id="assetLogoWrap">
                  <span class="fallback" id="assetLogoFallback">âˆŽ</span>
                </span>
                <span id="assetChipText" class="small"></span>
              </span>
            </div>
            <select id="swapFrom"></select>
          </div>

          <div style="width:220px;max-width:100%">
            <div class="label-row">
              <label for="swapAmount" style="margin-bottom:0">Amount</label>
              <!-- Clickable balance chip -->
              <button id="fillMaxBtn" class="chip linkish" title="Click to autofill your full balance" style="display:none">
                Balance: <span id="selectedBal">0</span>
              </button>
            </div>
            <input id="swapAmount" type="number" step="any" placeholder="0.0" />
          </div>
        </div>

        <!-- Row 2: To & Estimated -->
        <div class="row" style="gap:14px;margin-top:6px">
          <div style="flex:1;min-width:260px">
            <label>To</label>
            <div class="mono small" style="padding:10px 12px;border:1px solid #2a3d7a;border-radius:10px;background:#0b1430">
              <span id="toAssetTitle">AQUAm25</span><br/>
              <span id="toIssuerMeta" style="opacity:.8">Loading issuer domainâ€¦</span>
            </div>
          </div>
          <div style="width:180px">
            <label for="swapEst">Estimated receive</label>
            <input id="swapEst" type="text" readonly placeholder="â€”" />
          </div>
        </div>

        <p class="small" id="swapQuote" style="margin-top:6px" aria-live="polite"></p>

        <label for="xdrSwap" style="margin-top:10px">Swap XDR</label>
        <textarea id="xdrSwap" rows="5" placeholder="Built swap XDR appears here" readonly></textarea>

        <div class="row" style="margin-top:10px;flex-wrap:wrap">
          <button id="swapSignSubmit">Sign &amp; Submit (current wallet)</button>
          <button id="swapSignOnly" class="ghost">Sign (donâ€™t submit)</button>
          <button id="swapCopy" class="ghost">Copy XDR</button>
        </div>

        <p id="swapResult" class="small" style="margin-top:6px" aria-live="polite"></p>
      </div>

      <!-- Locker -->
      <div class="section box" id="lockerBox">
        <h2>Locker</h2>

        <label for="pubkey">Public Key</label>
        <input id="pubkey" placeholder="Gâ€¦ (manual entry allowed if not connected)" />

        <p class="small">AQUAm25 Balance: <b id="aquaBal">-</b></p>

        <label for="amount">AQUAm25 Amount</label>
        <input id="amount" type="number" step="any" placeholder="Amount to lock" />
        <div class="pct">
          <button data-pct="25">25%</button>
          <button data-pct="50">50%</button>
          <button data-pct="75">75%</button>
          <button data-pct="100">100%</button>
        </div>

        <p id="lockInfo" class="small" style="margin-top:8px;white-space:pre-line;opacity:.9"></p>

        <label for="xdrOut" style="margin-top:10px">Transaction XDR</label>
        <textarea id="xdrOut" rows="6" placeholder="Built XDR appears here" readonly></textarea>

        <div class="row" style="margin-top:10px;flex-wrap:wrap">
          <button id="signSubmitBtn">Sign &amp; Submit (current wallet)</button>
          <button id="signOnlyBtn" class="ghost">Sign (donâ€™t submit)</button>
          <button id="copyBtn" class="ghost">Copy XDR</button>
          <button id="labBtn" class="ghost">Open in Stellar Lab</button>
        </div>

        <p id="actionResult" class="small" style="margin-top:6px" aria-live="polite"></p>
      </div>
    </div>
  </div>

  <!-- Connect Modal -->
  <div id="backdrop" class="backdrop"></div>
  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-inner">
      <div class="modal-header">
        <h2 id="loginTitle" style="font-size:18px;margin:0">Connect Wallet</h2>
        <button class="x" id="closeModal" aria-label="Close">Ã—</button>
      </div>
      <p>Select a login method:</p>
      <button class="wallet-btn" id="wcBtn">ðŸ”— WalletConnect (mobile)</button>
      <button class="wallet-btn" id="freighterExtBtn">ðŸ§© Freighter (browser extension)</button>

      <div id="qrArea" class="qr-wrap" style="display:none">
        <canvas id="qrCanvas" width="256" height="256" style="background:#fff;border-radius:12px"></canvas>
        <div class="wallet-choices">
          <button id="btnLobstr">Open in LOBSTR</button>
          <button id="btnFreighter">Open in Freighter</button>
        </div>
        <div class="small">
          Scan with your wallet app (LOBSTR / Freighter), or tap a button above on mobile. Â·
          <a id="rawWcLink" class="link" href="#" target="_blank" rel="noreferrer">raw wc link</a>
        </div>
        <p id="linkStatus" class="small" style="margin:0;text-align:center;opacity:.8"></p>
      </div>
    </div>
  </div>

  <script>window.process = window.process || { env: {} };</script>

  <script type="module">
    import SignClient from "https://esm.sh/@walletconnect/sign-client@2.21.8";
    import QRCode     from "https://esm.sh/qrcode@1.5.3";

    // ---------- Config ----------
    const PROJECT_ID = "f658ce3a7c8a185214974f71539fea39";
    const EXPLORER   = "https://explorer-api.walletconnect.com/v3/wallets";
    const HORIZON    = "https://horizon.stellar.org";
    const NETWORK    = window.StellarSdk.Networks.PUBLIC;

    // AQUA / AQUAm25
    const AQUA_CODE   = "AQUA";
    const AQUA_ISSUER = "GBNZILSTVQZ4R7IKQDGHYGY2QXL5QOFJYQMXPKWRRM5PAV7Y4M67AQUA";
    const AQUAm25_CODE   = "AQUAm25";
    const AQUAm25_ISSUER = "GDXF6SYWIQOKOZ7BACXHBFBLQZEIH25KOTTLWQK35GO3JKRNIFHHGBPC";
    const TRACKER_KEY    = "GDGEWZMIJ2K6AEYYV2L4FYN27YJP5OVZSWCJIM662D5OS7EL6T6WBGBP";

    const STORE = {
      lobstr:   { ios:"https://apps.apple.com/app/id1404357892",                      android:"https://play.google.com/store/apps/details?id=com.lobstr.client" },
      freighter:{ ios:"https://apps.apple.com/app/freighter/id6743947720",           android:"https://play.google.com/store/apps/details?id=org.stellar.freighterwallet&pli=1" }
    };

    // ---------- DOM ----------
    const $=(id)=>document.getElementById(id);
    const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn);
    const isIOS=()=>/iPhone|iPad|iPod/i.test(navigator.userAgent);

    const connectBtn=$("connectBtn"), disconnectBtn=$("disconnectBtn"), statusEl=$("status");
    const backdrop=$("backdrop"), loginModal=$("loginModal"), closeModalBtn=$("closeModal");
    const qrArea=$("qrArea"), qrCanvas=$("qrCanvas"), linkStatus=$("linkStatus"), rawWcLink=$("rawWcLink");

    const pubkeyEl=$("pubkey"), aquaBalEl=$("aquaBal"), amountEl=$("amount"), lockInfoEl=$("lockInfo");
    const xdrOut=$("xdrOut"), actionResult=$("actionResult"), addrEl=$("addr"), modeEl=$("mode");
    const signSubmitBtn=$("signSubmitBtn"), signOnlyBtn=$("signOnlyBtn"), copyBtn=$("copyBtn"), labBtn=$("labBtn");
    const pctBtns=[...document.querySelectorAll(".pct button")];

    // Swap DOM
    const swapFrom=$("swapFrom"), swapAmount=$("swapAmount"), swapQuote=$("swapQuote"),
          xdrSwap=$("xdrSwap"), swapSignSubmit=$("swapSignSubmit"),
          swapSignOnly=$("swapSignOnly"), swapCopy=$("swapCopy"), swapResult=$("swapResult"),
          swapEst=$("swapEst"), selectedAssetChip=$("selectedAssetChip"),
          assetChipText=$("assetChipText"), assetLogoWrap=$("assetLogoWrap"),
          assetLogoFallback=$("assetLogoFallback"), fillMaxBtn=$("fillMaxBtn"), selectedBal=$("selectedBal"),
          toIssuerMeta=$("toIssuerMeta");

    // ---------- Stellar SDK / Server ----------
    if(!window.StellarSdk) throw new Error("Stellar SDK failed to load.");
    const SDK = window.StellarSdk;
    const ServerCtor = SDK.Server || (SDK.Horizon && SDK.Horizon.Server);
    if(!ServerCtor) throw new Error("Stellar SDK: Server constructor not found.");
    let _server=null; const getServer=()=>(_server ||= new ServerCtor(HORIZON));
    const AQUA     = new SDK.Asset(AQUA_CODE, AQUA_ISSUER);
    const AQUAm25  = new SDK.Asset(AQUAm25_CODE, AQUAm25_ISSUER);

    // ---------- State ----------
    // 'none' | 'wc' | 'freighter'
    let connectionMode="none";
    let client=null, session=null, latestWcUri=null;
    let buildTimer=null;       // locker debounce
    let swapTimer=null;        // swap debounce
    let lockerRefreshTimer=null;

    // Caches
    const DOMAIN_CACHE = new Map(); // issuer => domain (string or "")
    const LOGO_CACHE   = new Map(); // issuer => imageURL (string or "")

    // ---------- Helpers ----------
    const isValidG = k => { try{return SDK.StrKey.isValidEd25519PublicKey(k);}catch{return false;} };
    const cleanAmt = a => { const n=Number(a); if(!isFinite(n)||n<=0) return null; return n.toFixed(7).replace(/\.0+$/,""); };
    const shortG = g => `${g.slice(0,6)}â€¦${g.slice(-6)}`;
    const fmt = n => (Number(n)||0).toString();

    function disableLockerButtons(){ [signSubmitBtn,signOnlyBtn,copyBtn,labBtn].forEach(b=>b.disabled=true); }
    function enableLockerButtons(){ const ok=!!xdrOut.value.trim(); [signSubmitBtn,signOnlyBtn,copyBtn,labBtn].forEach(b=>b.disabled=!ok); }

    function disableSwapButtons(){ [swapSignSubmit,swapSignOnly,swapCopy].forEach(b=>b.disabled=true); }
    function enableSwapButtons(){ const ok=!!xdrSwap.value.trim(); [swapSignSubmit,swapSignOnly,swapCopy].forEach(b=>b.disabled=!ok); }

    // ---------- Connection state ----------
    function setConnected(address, mode){
      addrEl.textContent = address || "";
      modeEl.textContent = mode==="wc"?"WalletConnect":(mode==="freighter"?"Freighter extension":"â€”");
      statusEl.textContent = address ? `Connected (${modeEl.textContent})` : "Not connected";
      disconnectBtn.disabled = !address;

      if(address && /^G[A-Z2-7]{55}$/.test(address)){
        pubkeyEl.value = address;
        pubkeyEl.readOnly = true;
        initForNewAccount();      // fill swap once, refresh balance, build locker
        startLockerAutoRefresh(); // locker-only periodic balance update
      }else{
        pubkeyEl.readOnly = false;
        stopLockerAutoRefresh();
      }
    }

    on(disconnectBtn,"click", async ()=>{
      try{
        if(connectionMode==="wc" && client && session){
          await client.disconnect({ topic: session.topic, reason:{ code:6000, message:"User disconnected" }});
        }
      }catch(e){ console.warn(e); }
      session=null; connectionMode="none"; setConnected("", "none");
      // Reset any stale UI state/results and disable buttons
      xdrOut.value = ""; xdrSwap.value = ""; swapEst.value = "";
      actionResult.textContent = ""; swapResult.textContent = ""; swapQuote.textContent = "";
      disableLockerButtons(); disableSwapButtons();
    });

    // ---------- Locker balance + build ----------
    async function loadAquaM25Balance(pk){
      const acct = await getServer().loadAccount(pk);
      const bal = acct.balances.find(b => b.asset_code===AQUAm25_CODE && b.asset_issuer===AQUAm25_ISSUER);
      return { acct, balance: bal ? bal.balance : "0" };
    }
    function startLockerAutoRefresh(){
      stopLockerAutoRefresh();
      lockerRefreshTimer = setInterval(async ()=>{
        const pk = pubkeyEl.value.trim();
        if(!isValidG(pk)) return;
        try{
          const { balance } = await loadAquaM25Balance(pk);
          aquaBalEl.textContent = balance;
        }catch(e){ console.warn(e); }
      }, 15000);
    }
    function stopLockerAutoRefresh(){
      if(lockerRefreshTimer) clearInterval(lockerRefreshTimer);
      lockerRefreshTimer = null;
    }

    function scheduleLockerBuild(){
      disableLockerButtons();
      if(buildTimer) clearTimeout(buildTimer);
      buildTimer = setTimeout(async ()=>{
        const xdr = await buildLockXDR();
        if(xdr){ xdrOut.value = xdr; enableLockerButtons(); }
        else { xdrOut.value=""; disableLockerButtons(); }
      }, 700);
    }

    async function buildLockXDR(){
      const pk = pubkeyEl.value.trim();
      const amt = cleanAmt(amountEl.value.trim());
      if(!isValidG(pk) || !amt) return null;

      try{
        const src = await getServer().loadAccount(pk);

        const now = new Date();
        const end = new Date(now);
        end.setUTCFullYear(end.getUTCFullYear()+1);
        end.setUTCHours(23,59,59,0);
        const endTs = Math.floor(end.getTime()/1000).toString();
        lockInfoEl.textContent = `Lock start: ${now.toLocaleString()}
Lock end (UTC):   ${end.toLocaleString(undefined,{timeZone:'UTC'})}`;

        const claimants = [
          new SDK.Claimant(pk, SDK.Claimant.predicateNot(SDK.Claimant.predicateBeforeAbsoluteTime(endTs))),
          new SDK.Claimant(TRACKER_KEY, SDK.Claimant.predicateBeforeAbsoluteTime("0"))
        ];

        const tx = new SDK.TransactionBuilder(src, { fee: "20000", networkPassphrase: NETWORK })
          .addOperation(SDK.Operation.createClaimableBalance({ asset: AQUAm25, amount: amt, claimants }))
          .setTimeout(180)
          .build();

        return tx.toXDR();
      }catch(e){ console.error(e); return null; }
    }

    // Locker inputs
    on(pubkeyEl,"input", ()=>{
      if(pubkeyEl.readOnly) return;
      scheduleLockerBuild();
    });
    on(pubkeyEl,"change", ()=>{
      if(pubkeyEl.readOnly) return;
      initForNewAccount();
      startLockerAutoRefresh();
    });
    on(amountEl,"input", scheduleLockerBuild);

    pctBtns.forEach(btn=>btn.addEventListener("click", ()=>{
      const bal = Math.max(0, parseFloat(aquaBalEl.textContent) || 0);
      const pct = parseInt(btn.dataset.pct,10)/100;
      const v = cleanAmt(bal*pct);
      amountEl.value = v||"";
      scheduleLockerBuild();
    }));

    // ---------- Swap (balances, domains, logos) ----------
    async function loadAllBalances(pk){
      const acct = await getServer().loadAccount(pk);
      const items = [];
      const xlmBal = acct.balances.find(b=>b.asset_type==="native");
      if (xlmBal && parseFloat(xlmBal.balance) > 0) {
        items.push({ code:"XLM", issuer:null, balance: xlmBal.balance, domain:"native" });
      }
      for(const b of acct.balances){
        if(b.asset_type==="native") continue;
        if(parseFloat(b.balance) <= 0) continue; // hide zero-balance assets
        items.push({ code:b.asset_code, issuer:b.asset_issuer, balance:b.balance });
      }
      return { acct, items };
    }

    async function fetchDomainsForIssuers(issuers){
      const unique = [...new Set(issuers.filter(Boolean))];
      const need = unique.filter(i => !DOMAIN_CACHE.has(i));
      await Promise.all(need.map(async (issuer)=>{
        try{
          const r = await fetch(`${HORIZON}/accounts/${issuer}`);
          const j = await r.json();
          const d = (j && j.home_domain) ? j.home_domain : "";
          DOMAIN_CACHE.set(issuer, d);
        }catch(_){ DOMAIN_CACHE.set(issuer, ""); }
      }));
    }

    async function fetchLogosForIssuers(issuers){
      const unique = [...new Set(issuers.filter(Boolean))];
      const need = unique.filter(i => !LOGO_CACHE.has(i));
      await Promise.all(need.map(async (issuer)=>{
        try{
          const dom = DOMAIN_CACHE.get(issuer);
          if(!dom){ LOGO_CACHE.set(issuer,""); return; }
          const url = `https://${dom}/.well-known/stellar.toml`;
          const res = await fetch(url, { mode:"cors" });
          if(!res.ok){ LOGO_CACHE.set(issuer,""); return; }
          const txt = await res.text();
          // Very light TOML scan for [[CURRENCIES]] blocks with matching ISSUER; find IMAGE
          const blocks = txt.split(/\[\[CURRENCIES\]\]/i).slice(1);
          let img="";
          for(const block of blocks){
            const issuerMatch = block.match(/^\s*issuer\s*=\s*\"?([^\"]+)\"?/im);
            const codeMatch   = block.match(/^\s*code\s*=\s*\"?([A-Za-z0-9_]{1,12})\"?/im);
            const imageMatch  = block.match(/^\s*image\s*=\s*\"?([^\"]+)\"?/im);
            const issuerVal = issuerMatch && issuerMatch[1]?.trim();
            if(issuerVal && issuerVal.toUpperCase()===issuer.toUpperCase()){
              img = imageMatch ? imageMatch[1].trim() : "";
              // Prefer exact match, but if code matches and no image, keep searching
              if(img) break;
            }
            // Fallback: if only one currency and ISSUER missing but code matches (rare)
            if(!img && codeMatch && issuerVal==null) {
              img = imageMatch ? imageMatch[1].trim() : "";
            }
          }
          LOGO_CACHE.set(issuer, img||"");
        }catch(_){ LOGO_CACHE.set(issuer,""); }
      }));
    }

    function labelWithDomain(code, issuer){
      if(!issuer) return `${code} Â· native`;
      const dom = DOMAIN_CACHE.get(issuer) || "";
      const right = dom || shortG(issuer);
      return `${code} Â· ${right}`;
    }

    function renderSelectedAssetChip(code, issuer){
      const text = labelWithDomain(code, issuer);
      assetChipText.textContent = text;
      selectedAssetChip.style.display = "inline-flex";
      // logo (if any)
      assetLogoWrap.innerHTML = "";
      const imgUrl = issuer ? (LOGO_CACHE.get(issuer)||"") : "";
      if(imgUrl){
        const img = document.createElement("img");
        img.src = imgUrl; img.alt = code; img.width=16; img.height=16;
        assetLogoWrap.appendChild(img);
      }else{
        const fb = document.createElement("span");
        fb.className = "fallback";
        fb.textContent = code[0] || "âˆŽ";
        assetLogoWrap.appendChild(fb);
      }
    }

    function fillSwapDropdownOnce(items){
      swapFrom.innerHTML = "";
      for(const it of items){
        const opt = document.createElement("option");
        opt.value = it.issuer ? `${it.code}:${it.issuer}` : "XLM";
        opt.textContent = labelWithDomain(it.code, it.issuer); // no balance in label anymore
        opt.dataset.balance = it.balance; // keep for the balance chip
        opt.dataset.code = it.code;
        if(it.issuer) opt.dataset.issuer = it.issuer;
        swapFrom.appendChild(opt);
      }
      // Default to AQUA if present; else first
      const def = `${AQUA_CODE}:${AQUA_ISSUER}`;
      const found = [...swapFrom.options].find(o=>o.value===def);
      swapFrom.value = found ? def : (swapFrom.options[0]?.value || "");
      // Update chips after initial fill
      updateSelectedAssetUI();
    }

    function getSelectedOption(){
      return swapFrom.options[swapFrom.selectedIndex] || null;
    }

    function updateSelectedAssetUI(){
      const opt = getSelectedOption();
      if(!opt){ selectedAssetChip.style.display="none"; fillMaxBtn.style.display="none"; return; }
      const code = opt.dataset.code || (opt.value==="XLM"?"XLM":"");
      const issuer = opt.dataset.issuer || null;
      const bal = opt.dataset.balance || "0";
      selectedBal.textContent = fmt(bal);
      fillMaxBtn.style.display = parseFloat(bal)>0 ? "inline-flex" : "none";
      renderSelectedAssetChip(code, issuer);
    }

    async function updateToBoxDomain(){
      // Make To show AQUAm25 + domain
      if(!DOMAIN_CACHE.has(AQUAm25_ISSUER)){
        await fetchDomainsForIssuers([AQUAm25_ISSUER]);
      }
      const dom = DOMAIN_CACHE.get(AQUAm25_ISSUER) || shortG(AQUAm25_ISSUER);
      toIssuerMeta.textContent = dom;
    }

    async function initForNewAccount(){
      const pk = pubkeyEl.value.trim();
      if(!isValidG(pk)) { aquaBalEl.textContent="Invalid key"; return; }

      try{
        // Locker balance
        const { balance } = await loadAquaM25Balance(pk);
        aquaBalEl.textContent = balance;

        // Balances (hide zero), domains and logos
        const { items } = await loadAllBalances(pk);
        await fetchDomainsForIssuers(items.map(i=>i.issuer).filter(Boolean).concat([AQUAm25_ISSUER]));
        await fetchLogosForIssuers(items.map(i=>i.issuer).filter(Boolean));
        fillSwapDropdownOnce(items);

        // To box domain
        updateToBoxDomain();

        // Suggested defaults (do NOT auto-quote)
        if(!amountEl.value.trim()){
          const v = cleanAmt(parseFloat(balance||"0")*0.25);
          if(v){ amountEl.value = v; }
        }
        scheduleLockerBuild();
      }catch(e){ console.error(e); }
    }

    // ---------- Swap: quoting ----------
    async function quoteSwap(){
      // Only on user actions
      disableSwapButtons();
      xdrSwap.value = "";
      swapEst.value = "";
      swapQuote.textContent = "";

      const pk = pubkeyEl.value.trim();
      const sendAmt = cleanAmt(swapAmount.value.trim());
      if(!isValidG(pk) || !sendAmt) return;

      let sendAsset;
      if(swapFrom.value === "XLM"){
        sendAsset = SDK.Asset.native();
      }else{
        const [code, issuer] = swapFrom.value.split(":");
        sendAsset = new SDK.Asset(code, issuer);
      }
      const sendLabel = (sendAsset.isNative && sendAsset.isNative()) ? "XLM" : (sendAsset.code || (sendAsset.getCode ? sendAsset.getCode() : "asset"));

      try{
        const paths = await getServer().strictSendPaths(sendAsset, sendAmt, [AQUAm25]).call();
        const records = paths.records || [];
        if(!records.length){
          swapQuote.textContent = `No path found from ${sendLabel} â†’ AQUAm25 for this amount.`;
          return;
        }
        records.sort((a,b)=> parseFloat(b.destination_amount) - parseFloat(a.destination_amount));
        const best = records[0];

        const destAmount = best.destination_amount;
        const minOut = (parseFloat(destAmount) * 0.98).toFixed(7); // 2% buffer
        swapEst.value = destAmount;

        const pathStr = (best.path && best.path.length)
          ? `Path: ${best.path.map(p=>`${p.asset_code||'XLM'}:${DOMAIN_CACHE.get(p.asset_issuer)|| (p.asset_issuer?shortG(p.asset_issuer):'native')}`).join(" â†’ ")}`
          : "Direct";

        swapQuote.innerHTML = `Min receive (2% slippage): <b>${minOut}</b> AQUAm25<br/><span class="small">${pathStr}</span>`;

        const src = await getServer().loadAccount(pk);

        const op = SDK.Operation.pathPaymentStrictSend({
          sendAsset,
          sendAmount: sendAmt,
          destination: pk,
          destAsset: AQUAm25,
          destMin: minOut,
          path: (best.path||[]).map(p => p.asset_type==="native"
              ? SDK.Asset.native()
              : new SDK.Asset(p.asset_code, p.asset_issuer))
        });

        const txb = new SDK.TransactionBuilder(src, { fee: "20000", networkPassphrase: NETWORK });
        // Ensure trustline exists for AQUAm25
        const hasTrust = !!src.balances.find(b=>b.asset_code===AQUAm25_CODE && b.asset_issuer===AQUAm25_ISSUER);
        if(!hasTrust){ txb.addOperation(SDK.Operation.changeTrust({ asset: AQUAm25 })); }

        txb.addOperation(op).setTimeout(180);
        const tx = txb.build();

        xdrSwap.value = tx.toXDR();
        enableSwapButtons();
      }catch(e){
        console.error(e);
        swapQuote.textContent = "Failed to quote path.";
        xdrSwap.value = "";
        disableSwapButtons();
      }
    }

    // UI wiring
    on(swapFrom,"change", ()=>{
      updateSelectedAssetUI();
      // Donâ€™t auto-quote; user will type the amount
    });

    on(swapAmount,"input", ()=>{
      if(swapTimer) clearTimeout(swapTimer);
      swapTimer = setTimeout(quoteSwap, 400);
    });

    on(fillMaxBtn,"click", ()=>{
      const opt = getSelectedOption();
      if(!opt) return;
      const bal = opt.dataset.balance || "0";
      swapAmount.value = bal;
      quoteSwap();
    });

    // ---------- First-load ----------
    window.addEventListener("load", ()=>{
      const pk = pubkeyEl.value.trim();
      updateToBoxDomain();
      if(isValidG(pk)){ initForNewAccount(); startLockerAutoRefresh(); }
      disableLockerButtons();
      disableSwapButtons();
    });
  </script>

  <noscript style="color:#fff">Enable JavaScript to use the AQUAm25 locker.</noscript>
</body>
</html>
