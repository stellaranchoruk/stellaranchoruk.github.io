<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>bUSDC Vault UI</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111a2b; --muted:#8ea0c2; --text:#e8eefc;
      --accent:#5eead4; --warn:#fbbf24; --bad:#fb7185; --ok:#34d399;
      --border:rgba(255,255,255,.10);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{ margin:0; font-family:var(--sans); background:linear-gradient(180deg,#070a10,#0b0f17 40%,#070a10); color:var(--text); }
    .wrap{ max-width:1050px; margin:24px auto; padding:0 16px; }
    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; }
    .card{ background:rgba(17,26,43,.92); border:1px solid var(--border); border-radius:14px; padding:16px; }
    h1{ margin:0 0 6px; font-size:20px; letter-spacing:-.01em; }
    h2{ margin:0 0 10px; font-size:16px; letter-spacing:-.01em; }
    .muted{ color:var(--muted); font-size:13px; }
    label{ display:block; margin:10px 0 6px; font-size:13px; color:var(--muted); }
    input, select{
      width:100%; box-sizing:border-box; padding:10px 12px;
      background:rgba(255,255,255,.03); border:1px solid var(--border);
      color:var(--text); border-radius:10px; outline:none;
      font-family:var(--mono); font-size:13px;
    }
    button{
      cursor:pointer; border:1px solid var(--border); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:10px; font-weight:700;
    }
    button.primary{ border-color:rgba(94,234,212,.35); background:rgba(94,234,212,.12); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .kvs{ display:grid; grid-template-columns: 180px 1fr; gap:8px 10px; margin-top:10px; }
    .key{ color:var(--muted); font-size:13px; }
    .val{ font-family:var(--mono); font-size:13px; overflow-wrap:anywhere; }
    .log{ white-space:pre-wrap; font-family:var(--mono); font-size:12px; background:rgba(0,0,0,.25);
      border:1px solid var(--border); padding:10px; border-radius:10px; max-height:280px; overflow:auto; }
    .pill{ display:inline-block; padding:4px 9px; border:1px solid var(--border); border-radius:999px;
      font-size:12px; color:var(--muted); max-width:100%; overflow:hidden; text-overflow:ellipsis; vertical-align:middle; }
    .good{ color:var(--ok); border-color:rgba(52,211,153,.35); }
    .bad{ color:var(--bad); border-color:rgba(251,113,133,.35); }
    .hr{ height:1px; background:var(--border); margin:14px 0; }
    @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } .kvs{ grid-template-columns: 140px 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="align-items:flex-start;">
        <div style="flex:1.6;">
          <h1>bUSDC Vault UI</h1>
          <div class="muted">Contract: <span class="pill" id="contractPill"></span></div>
          <div class="muted">RPC: <span class="pill" id="rpcPill"></span></div>
        </div>
        <div style="flex:.9; text-align:right;">
          <div class="muted">Wallet</div>
          <div class="row" style="justify-content:flex-end; gap:8px; margin-top:8px;">
            <button id="btnConnect" class="primary">Connect Freighter</button>
            <button id="btnRefresh">Refresh</button>
          </div>
          <div class="muted" style="margin-top:8px;">
            Address: <span id="addr" class="pill" title="not connected">not connected</span>
          </div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h2>Vault state</h2>
        <div class="muted">Human amounts assume 7 decimals (USDC-style). Raw is the exact on-chain integer.</div>
        <div class="hr"></div>

        <div class="kvs">
          <div class="key">Underlying asset</div><div class="val" id="underlying">—</div>
          <div class="key">Share token</div><div class="val" id="share">—</div>

          <div class="key">Share price</div><div class="val" id="sharePrice">—</div>
          <div class="key">1 bUSDC ≈</div><div class="val" id="oneShareWorth">—</div>

          <div class="key">Total assets</div><div class="val" id="totalAssets">—</div>
          <div class="key">Total supply</div><div class="val" id="totalSupply">—</div>
        </div>
      </div>

      <div class="card">
        <h2>Actions</h2>

        <label>Amount (decimal, e.g. 100.5)</label>
        <input id="amount" placeholder="e.g. 100.5" />

        <div class="row" style="margin-top:10px;">
          <button id="btnPreviewDeposit">Preview deposit</button>
          <button id="btnPreviewWithdraw">Preview withdraw</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnDeposit" class="primary" disabled>Deposit</button>
          <button id="btnWithdraw" class="primary" disabled>Withdraw</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Deposit/Withdraw requires Freighter signing. Previews are read-only.
        </div>

        <div style="margin-top:12px;">
          <div class="muted">Result</div>
          <div id="result" class="pill">—</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="row" style="align-items:center;">
        <h2 style="margin:0;">Debug log</h2>
        <div style="text-align:right;">
          <button id="btnClear">Clear</button>
        </div>
      </div>
      <div id="log" class="log" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Stellar SDK browser build -->
  <script src="https://unpkg.com/@stellar/stellar-sdk@14.4.3/dist/stellar-sdk-minimal.min.js"></script>
  <!-- Freighter API (UMD) -->
  <script src="https://unpkg.com/@stellar/freighter-api@1.7.1/dist/index.umd.js"></script>

  <script>
    // ========= CONFIG =========
    const CONTRACT_ID = "CCR63UWZKPVR2OAZJEBHT4OKBLHX2OAMUYZ63JLO2V72FY3SKAXQTGF6";
    const RPC_URL = "https://rpc.lightsail.network/";
    const NETWORK_PASSPHRASE = "Public Global Stellar Network ; September 2015";
    const DECIMALS = 7; // classic USDC-style scale
    // ==========================

    const el = (id) => document.getElementById(id);
    const logEl = el("log");

    // BigInt-safe logger (fixes: "Do not know how to serialize a BigInt")
    const log = (...args) => {
      const line = args.map(a => {
        if (typeof a === "bigint") return a.toString();
        if (a && typeof a === "object") {
          return JSON.stringify(a, (k, v) => (typeof v === "bigint" ? v.toString() : v), 2);
        }
        return String(a);
      }).join(" ");
      logEl.textContent += (logEl.textContent ? "\n" : "") + line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(...args);
    };

    el("contractPill").textContent = CONTRACT_ID;
    el("rpcPill").textContent = RPC_URL;

    function setResult(text, ok=true){
      const r = el("result");
      r.textContent = text;
      r.className = "pill " + (ok ? "good" : "bad");
    }

    // Format BigInt using DECIMALS (7)
    function fmtDec(x, decimals = DECIMALS){
      if (typeof x !== "bigint") return String(x);
      const neg = x < 0n;
      const v = neg ? -x : x;
      const s = v.toString().padStart(decimals + 1, "0");
      const whole = s.slice(0, -decimals);
      let frac = s.slice(-decimals).replace(/0+$/,"");
      return (neg ? "-" : "") + whole + (frac ? "." + frac : "");
    }

    // Shows "raw (≈ human)"
    function fmtBoth(x){
      if (typeof x === "bigint") return `${x.toString()}  (≈ ${fmtDec(x)})`;
      return String(x);
    }

    // Parse decimal string to i128 scaled by DECIMALS
    function parseAmountToI128(amountStr, decimals = DECIMALS){
      const s = (amountStr || "").trim();
      if (!s) throw new Error("Enter an amount.");
      if (!/^\d+(\.\d+)?$/.test(s)) throw new Error("Amount must be a positive number (e.g. 12 or 12.34).");

      const [i, f=""] = s.split(".");
      const frac = (f + "0".repeat(decimals)).slice(0, decimals);
      const bi = BigInt(i + frac);
      if (bi <= 0n) throw new Error("Amount must be > 0.");
      return bi;
    }

    // Resolve the correct RPC Server constructor across builds
    function makeRpcServer(url){
      if (window.StellarSdk?.rpc?.Server) return new window.StellarSdk.rpc.Server(url);
      if (window.StellarSdk?.SorobanRpc?.Server) return new window.StellarSdk.SorobanRpc.Server(url);
      throw new Error("Could not find RPC Server constructor (StellarSdk.rpc.Server / StellarSdk.SorobanRpc.Server).");
    }

    const Stellar = window.StellarSdk;
    const Contract = Stellar.Contract;
    const scValToNative = Stellar.scValToNative;
    const nativeToScVal = Stellar.nativeToScVal;

    const server = makeRpcServer(RPC_URL);
    const contract = new Contract(CONTRACT_ID);

    let publicKey = null;

    // For read-only simulation, we can use any valid account as source.
    // This placeholder account works for simulation-only.
    const READONLY_SOURCE = "GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF";

    async function simulateCall(fn, argsScVals=[]){
      const sourcePk = publicKey || READONLY_SOURCE;
      const source = await server.getAccount(sourcePk);

      const tx = new Stellar.TransactionBuilder(source, {
        fee: Stellar.BASE_FEE,
        networkPassphrase: NETWORK_PASSPHRASE
      })
      .addOperation(contract.call(fn, ...argsScVals))
      .setTimeout(30)
      .build();

      const sim = await server.simulateTransaction(tx);
      if ((Stellar.rpc?.isSimulationError?.(sim)) || sim.error) {
        throw new Error("Simulation failed: " + (sim.error ? JSON.stringify(sim.error) : JSON.stringify(sim, null, 2)));
      }
      const retval = sim.result?.retval;
      return { sim, retval };
    }

    async function readFn(fn, argsScVals=[]){
      log(`→ simulate ${fn}()`);
      const { retval } = await simulateCall(fn, argsScVals);
      const native = scValToNative(retval);
      log(`← ${fn}() =`, native);
      return native;
    }

    function assembleTransaction(tx, sim){
      if (Stellar.rpc?.assembleTransaction) return Stellar.rpc.assembleTransaction(tx, sim);
      if (Stellar.SorobanRpc?.assembleTransaction) return Stellar.SorobanRpc.assembleTransaction(tx, sim);
      throw new Error("assembleTransaction not found in this SDK build.");
    }

    async function writeFn(fn, argsScVals=[]){
      if (!publicKey) throw new Error("Connect Freighter first.");

      log(`→ build ${fn}() tx`);
      const source = await server.getAccount(publicKey);
      const tx0 = new Stellar.TransactionBuilder(source, {
        fee: Stellar.BASE_FEE,
        networkPassphrase: NETWORK_PASSPHRASE
      })
      .addOperation(contract.call(fn, ...argsScVals))
      .setTimeout(60)
      .build();

      log(`→ simulate ${fn}()`);
      const sim = await server.simulateTransaction(tx0);
      if ((Stellar.rpc?.isSimulationError?.(sim)) || sim.error) {
        throw new Error("Simulation failed: " + (sim.error ? JSON.stringify(sim.error) : JSON.stringify(sim, null, 2)));
      }

      const assembled = assembleTransaction(tx0, sim);
      const xdr = assembled.toXDR();

      log("→ request Freighter signature");
      const signedXdr = await window.freighterApi.signTransaction(xdr, {
        networkPassphrase: NETWORK_PASSPHRASE
      });

      const signedTx = Stellar.TransactionBuilder.fromXDR(signedXdr, NETWORK_PASSPHRASE);

      log("→ sendTransaction");
      const send = await server.sendTransaction(signedTx);
      log("sendTransaction =", send);

      // Poll until complete
      const hash = send.hash;
      for (let i=0;i<20;i++){
        await new Promise(r => setTimeout(r, 1500));
        const res = await server.getTransaction(hash);
        if (res.status === "SUCCESS") return res;
        if (res.status === "FAILED") throw new Error("Transaction FAILED: " + JSON.stringify(res, null, 2));
      }
      throw new Error("Timed out waiting for tx completion.");
    }

    async function refreshState(){
      setResult("Refreshing…", true);

      try{
        // read everything in parallel
        const [asset, share, sp, ta, ts] = await Promise.all([
          readFn("query_asset"),
          readFn("query_share"),
          readFn("share_price"),
          readFn("total_assets"),
          readFn("total_supply"),
        ]);

        // Addresses are strings; numbers are often BigInt
        el("underlying").textContent = String(asset);
        el("share").textContent = String(share);

        el("sharePrice").textContent = fmtBoth(sp);
        el("totalAssets").textContent = fmtBoth(ta);
        el("totalSupply").textContent = fmtBoth(ts);

        // Nice headline: 1 bUSDC ≈ X USDC (assuming share_price is in asset base units per 1 share with 7 dp)
        if (typeof sp === "bigint") {
          el("oneShareWorth").textContent = `${fmtDec(sp)} (USDC)`;
        } else {
          el("oneShareWorth").textContent = String(sp);
        }

        setResult("OK", true);
      }catch(e){
        console.error(e);
        setResult(e.message || String(e), false);
        log("ERROR:", e.message || String(e));
      }
    }

    async function connectFreighter(){
      setResult("Connecting…", true);
      try{
        if (!window.freighterApi) throw new Error("Freighter API not found. Is Freighter installed/enabled?");
        const isAllowed = await window.freighterApi.isAllowed();
        if (!isAllowed) await window.freighterApi.setAllowed();

        publicKey = await window.freighterApi.getPublicKey();
        el("addr").textContent = publicKey;
        el("addr").title = publicKey;

        // Enable write buttons
        el("btnDeposit").disabled = false;
        el("btnWithdraw").disabled = false;

        setResult("Connected", true);
        log("Connected:", publicKey);
        await refreshState();
      }catch(e){
        setResult(e.message || String(e), false);
        log("ERROR:", e.message || String(e));
      }
    }

    async function preview(which){
      try{
        const amt = parseAmountToI128(el("amount").value);
        const fn = which === "deposit" ? "preview_deposit" : "preview_withdraw";
        const { retval } = await simulateCall(fn, [ nativeToScVal(amt, { type: "i128" }) ]);
        const native = scValToNative(retval);
        setResult(`${fn}: ${fmtBoth(native)}`, true);
      }catch(e){
        setResult(e.message || String(e), false);
      }
    }

    async function doDeposit(){
      try{
        const amt = parseAmountToI128(el("amount").value);

        // If your vault is deposit(assets) only, remove the receiver arg below.
        const receiver = Stellar.Address.fromString(publicKey).toScVal();

        const res = await writeFn("deposit", [
          nativeToScVal(amt, { type: "i128" }),
          receiver
        ]);

        setResult("Deposit SUCCESS", true);
        log("Deposit result:", res);
        await refreshState();
      }catch(e){
        setResult(e.message || String(e), false);
        log("ERROR:", e.message || String(e));
      }
    }

    async function doWithdraw(){
      try{
        const amt = parseAmountToI128(el("amount").value);

        // Typical 4626: withdraw(assets, receiver, owner)
        // If your vault is withdraw(assets) or withdraw(assets, receiver), adjust accordingly.
        const receiver = Stellar.Address.fromString(publicKey).toScVal();
        const owner = Stellar.Address.fromString(publicKey).toScVal();

        const res = await writeFn("withdraw", [
          nativeToScVal(amt, { type: "i128" }),
          receiver,
          owner
        ]);

        setResult("Withdraw SUCCESS", true);
        log("Withdraw result:", res);
        await refreshState();
      }catch(e){
        setResult(e.message || String(e), false);
        log("ERROR:", e.message || String(e));
      }
    }

    // Wire buttons
    el("btnConnect").onclick = connectFreighter;
    el("btnRefresh").onclick = refreshState;
    el("btnClear").onclick = () => (logEl.textContent = "");
    el("btnPreviewDeposit").onclick = () => preview("deposit");
    el("btnPreviewWithdraw").onclick = () => preview("withdraw");
    el("btnDeposit").onclick = doDeposit;
    el("btnWithdraw").onclick = doWithdraw;

    // Initial load
    refreshState();
  </script>
</body>
</html>
