<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>bUSDC Vault UI</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111a2b; --muted:#8ea0c2; --text:#e8eefc;
      --accent:#5eead4; --warn:#fbbf24; --bad:#fb7185; --ok:#34d399;
      --border:rgba(255,255,255,.10);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{ margin:0; font-family:var(--sans); background:var(--bg); color:var(--text); }
    .wrap{ max-width:1050px; margin:24px auto; padding:0 16px; }
    .grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:var(--muted); font-size:13px; }
    label{ display:block; margin:10px 0 6px; font-size:13px; color:var(--muted); }
    input, select{
      width:100%; box-sizing:border-box; padding:10px 12px;
      background:rgba(255,255,255,.03); border:1px solid var(--border);
      color:var(--text); border-radius:10px; outline:none;
      font-family:var(--mono); font-size:13px;
    }
    button{
      cursor:pointer; border:1px solid var(--border); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:10px; font-weight:600;
    }
    button.primary{ border-color:rgba(94,234,212,.35); background:rgba(94,234,212,.12); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .kvs{ display:grid; grid-template-columns: 180px 1fr; gap:8px 10px; margin-top:10px; }
    .key{ color:var(--muted); font-size:13px; }
    .val{ font-family:var(--mono); font-size:13px; overflow-wrap:anywhere; }
    .log{ white-space:pre-wrap; font-family:var(--mono); font-size:12px; background:rgba(0,0,0,.25);
      border:1px solid var(--border); padding:10px; border-radius:10px; max-height:260px; overflow:auto; }
    .pill{ display:inline-block; padding:3px 8px; border:1px solid var(--border); border-radius:999px;
      font-size:12px; color:var(--muted); }
    .good{ color:var(--ok); }
    .bad{ color:var(--bad); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="align-items:flex-start;">
        <div style="flex:1.6;">
          <h1>bUSDC Vault UI</h1>
          <div class="muted">Contract: <span class="pill" id="contractPill"></span></div>
          <div class="muted">RPC: <span class="pill" id="rpcPill"></span></div>
        </div>
        <div style="flex:.9; text-align:right;">
          <div class="muted">Wallet</div>
          <div class="row" style="justify-content:flex-end; gap:8px; margin-top:8px;">
            <button id="btnConnect" class="primary">Connect Freighter</button>
            <button id="btnRefresh">Refresh</button>
          </div>
          <div class="muted" style="margin-top:8px;">
            Address: <span id="addr" class="pill">not connected</span>
          </div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h2 style="margin:0 0 10px; font-size:16px;">Vault state</h2>
        <div class="kvs">
          <div class="key">Underlying asset</div><div class="val" id="underlying">—</div>
          <div class="key">Share token</div><div class="val" id="share">—</div>
          <div class="key">Share price</div><div class="val" id="sharePrice">—</div>
          <div class="key">Total assets</div><div class="val" id="totalAssets">—</div>
          <div class="key">Total supply</div><div class="val" id="totalSupply">—</div>
        </div>

        <div style="margin-top:14px;" class="muted">
          Notes: This contract exposes ERC-4626-style methods (deposit/mint/withdraw/redeem, previews, max_*).
          Values are returned as Soroban ScVals; we display both “raw” and “as 7-decimal” when numeric.
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px; font-size:16px;">Actions</h2>

        <label>Amount (decimal)</label>
        <input id="amount" placeholder="e.g. 100.5" />

        <div class="row" style="margin-top:10px;">
          <button id="btnPreviewDeposit">Preview deposit</button>
          <button id="btnPreviewWithdraw">Preview withdraw</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnDeposit" class="primary" disabled>Deposit</button>
          <button id="btnWithdraw" class="primary" disabled>Withdraw</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Withdraw/deposit require Freighter signing.
        </div>

        <div style="margin-top:12px;">
          <div class="muted">Result</div>
          <div id="result" class="pill">—</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="row" style="align-items:center;">
        <h2 style="margin:0; font-size:16px;">Debug log</h2>
        <div style="text-align:right;">
          <button id="btnClear">Clear</button>
        </div>
      </div>
      <div id="log" class="log" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Stellar SDK browser build -->
  <script src="https://unpkg.com/@stellar/stellar-sdk@14.4.3/dist/stellar-sdk-minimal.min.js"></script>
  <!-- Freighter API (UMD) -->
  <script src="https://unpkg.com/@stellar/freighter-api@1.7.1/dist/index.umd.js"></script>

  <script>
    // ========= CONFIG =========
    const CONTRACT_ID = "CCR63UWZKPVR2OAZJEBHT4OKBLHX2OAMUYZ63JLO2V72FY3SKAXQTGF6";
    const RPC_URL = "https://rpc.lightsail.network/";
    const NETWORK_PASSPHRASE = "Public Global Stellar Network ; September 2015";
    // ==========================

    const el = (id) => document.getElementById(id);
    const logEl = el("log");
    const log = (...args) => {
      const line = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
      logEl.textContent += (logEl.textContent ? "\n" : "") + line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(...args);
    };

    el("contractPill").textContent = CONTRACT_ID;
    el("rpcPill").textContent = RPC_URL.replace(/^https?:\/\//,"");

    // Resolve the correct RPC Server constructor across builds
    function makeRpcServer(url){
      // Most common in the browser dist:
      if (window.StellarSdk?.rpc?.Server) return new window.StellarSdk.rpc.Server(url);
      // Some builds:
      if (window.StellarSdk?.SorobanRpc?.Server) return new window.StellarSdk.SorobanRpc.Server(url);
      throw new Error("Could not find RPC Server constructor (StellarSdk.rpc.Server / StellarSdk.SorobanRpc.Server). Check SDK build.");
    }

    const Stellar = window.StellarSdk;
    const Contract = Stellar.Contract;
    const scValToNative = Stellar.scValToNative;
    const nativeToScVal = Stellar.nativeToScVal;

    const server = makeRpcServer(RPC_URL);
    const contract = new Contract(CONTRACT_ID);

    let publicKey = null;

    function setResult(text, ok=true){
      const r = el("result");
      r.textContent = text;
      r.className = "pill " + (ok ? "good" : "bad");
    }

    function parseAmountToI128_7(amountStr){
      // Stellar-style 7 decimals (like classic assets). Adjust if your vault uses a different scale.
      const n = Number(amountStr);
      if (!Number.isFinite(n) || n <= 0) throw new Error("Enter a positive number amount.");
      const scaled = BigInt(Math.round(n * 1e7));
      return scaled;
    }

    function formatMaybeNumeric(native){
      // If native is bigint, show raw + 7dp interpretation
      if (typeof native === "bigint"){
        const raw = native.toString();
        const sign = raw.startsWith("-") ? "-" : "";
        const abs = sign ? raw.slice(1) : raw;
        const pad = abs.padStart(8, "0");
        const whole = pad.slice(0, -7);
        const frac = pad.slice(-7);
        return `${native.toString()}  (≈ ${sign}${whole}.${frac})`;
      }
      return (typeof native === "string" ? native : JSON.stringify(native));
    }

    async function simulateCall(fn, argsScVals=[]){
      if (!publicKey) publicKey = (await server.getHealth()).healthy ? publicKey : publicKey; // noop; keeps structure
      const source = await server.getAccount(publicKey || "GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF"); // placeholder if not connected
      // NOTE: For read-only calls we can use any source; RPC will simulate without submitting.
      const tx = new Stellar.TransactionBuilder(source, {
        fee: Stellar.BASE_FEE,
        networkPassphrase: NETWORK_PASSPHRASE
      })
      .addOperation(contract.call(fn, ...argsScVals))
      .setTimeout(30)
      .build();

      const sim = await server.simulateTransaction(tx);
      if (Stellar.rpc?.isSimulationError?.(sim) || sim.error) {
        throw new Error("Simulation failed: " + JSON.stringify(sim, null, 2));
      }
      const retval = sim.result?.retval;
      return { sim, retval };
    }

    async function readFn(fn, argsScVals=[]){
      log(`→ simulate ${fn}()`);
      const { retval } = await simulateCall(fn, argsScVals);
      const native = scValToNative(retval);
      log(`← ${fn}() =`, native);
      return native;
    }

    async function writeFn(fn, argsScVals=[]){
      if (!publicKey) throw new Error("Connect Freighter first.");

      log(`→ build ${fn}() tx`);
      const source = await server.getAccount(publicKey);
      const tx0 = new Stellar.TransactionBuilder(source, {
        fee: Stellar.BASE_FEE,
        networkPassphrase: NETWORK_PASSPHRASE
      })
      .addOperation(contract.call(fn, ...argsScVals))
      .setTimeout(60)
      .build();

      log(`→ simulate ${fn}()`);
      const sim = await server.simulateTransaction(tx0);
      if (Stellar.rpc?.isSimulationError?.(sim) || sim.error) {
        throw new Error("Simulation failed: " + JSON.stringify(sim, null, 2));
      }

      // Assemble the transaction with the footprint/resources from simulation
      const assembled =
        (Stellar.rpc?.assembleTransaction)
          ? Stellar.rpc.assembleTransaction(tx0, sim)
          : (Stellar.SorobanRpc?.assembleTransaction)
            ? Stellar.SorobanRpc.assembleTransaction(tx0, sim)
            : null;

      if (!assembled) throw new Error("assembleTransaction not found in this SDK build.");

      const xdr = assembled.toXDR();

      log("→ request Freighter signature");
      const signed = await window.freighterApi.signTransaction(xdr, {
        networkPassphrase: NETWORK_PASSPHRASE
      });

      const signedTx = Stellar.TransactionBuilder.fromXDR(
        signed,
        NETWORK_PASSPHRASE
      );

      log("→ sendTransaction");
      const send = await server.sendTransaction(signedTx);
      log("sendTransaction =", send);

      // Poll until complete
      let hash = send.hash;
      for (let i=0;i<20;i++){
        await new Promise(r => setTimeout(r, 1500));
        const res = await server.getTransaction(hash);
        if (res.status === "SUCCESS") return res;
        if (res.status === "FAILED") throw new Error("Transaction FAILED: " + JSON.stringify(res, null, 2));
      }
      throw new Error("Timed out waiting for tx completion.");
    }

    async function refreshState(){
      setResult("Refreshing…", true);

      try{
        // These function names come directly from your WASM strings:
        // query_asset, query_share, share_price, total_assets, total_supply
        const [asset, share, sp, ta, ts] = await Promise.all([
          readFn("query_asset"),
          readFn("query_share"),
          readFn("share_price"),
          readFn("total_assets"),
          readFn("total_supply"),
        ]);

        el("underlying").textContent = formatMaybeNumeric(asset);
        el("share").textContent = formatMaybeNumeric(share);
        el("sharePrice").textContent = formatMaybeNumeric(sp);
        el("totalAssets").textContent = formatMaybeNumeric(ta);
        el("totalSupply").textContent = formatMaybeNumeric(ts);

        setResult("OK", true);
      }catch(e){
        console.error(e);
        setResult(e.message || String(e), false);
        log("ERROR:", e.message || String(e));
      }
    }

    async function connectFreighter(){
      setResult("Connecting…", true);
      try{
        if (!window.freighterApi) throw new Error("Freighter API not found. Is Freighter installed/enabled?");
        const isAllowed = await window.freighterApi.isAllowed();
        if (!isAllowed){
          await window.freighterApi.setAllowed();
        }
        publicKey = await window.freighterApi.getPublicKey();
        el("addr").textContent = publicKey;

        // Enable write buttons
        el("btnDeposit").disabled = false;
        el("btnWithdraw").disabled = false;

        setResult("Connected", true);
        log("Connected:", publicKey);
      }catch(e){
        setResult(e.message || String(e), false);
        log("ERROR:", e.message || String(e));
      }
    }

    async function preview(which){
      try{
        const amt = parseAmountToI128_7(el("amount").value);
        const fn = which === "deposit" ? "preview_deposit" : "preview_withdraw";
        const { retval } = await simulateCall(fn, [ nativeToScVal(amt, { type: "i128" }) ]);
        const native = scValToNative(retval);
        setResult(`${fn}: ${formatMaybeNumeric(native)}`, true);
      }catch(e){
        setResult(e.message || String(e), false);
      }
    }

    async function doDeposit(){
      try{
        const amt = parseAmountToI128_7(el("amount").value);
        // Most 4626 vaults are deposit(assets, receiver). Your contract name suggests deposit exists.
        // If your contract's signature is deposit(assets) only, remove the receiver arg.
        const receiver = publicKey;
        const res = await writeFn("deposit", [
          nativeToScVal(amt, { type: "i128" }),
          Stellar.Address.fromString(receiver).toScVal()
        ]);
        setResult("Deposit SUCCESS", true);
        log("Deposit result:", res);
        await refreshState();
      }catch(e){
        setResult(e.message || String(e), false);
        log("ERROR:", e.message || String(e));
      }
    }

    async function doWithdraw(){
      try{
        const amt = parseAmountToI128_7(el("amount").value);
        // Typical 4626: withdraw(assets, receiver, owner)
        const receiver = publicKey;
        const owner = publicKey;
        const res = await writeFn("withdraw", [
          nativeToScVal(amt, { type: "i128" }),
          Stellar.Address.fromString(receiver).toScVal(),
          Stellar.Address.fromString(owner).toScVal()
        ]);
        setResult("Withdraw SUCCESS", true);
        log("Withdraw result:", res);
        await refreshState();
      }catch(e){
        setResult(e.message || String(e), false);
        log("ERROR:", e.message || String(e));
      }
    }

    // Wire buttons
    el("btnConnect").onclick = connectFreighter;
    el("btnRefresh").onclick = refreshState;
    el("btnClear").onclick = () => (logEl.textContent = "");
    el("btnPreviewDeposit").onclick = () => preview("deposit");
    el("btnPreviewWithdraw").onclick = () => preview("withdraw");
    el("btnDeposit").onclick = doDeposit;
    el("btnWithdraw").onclick = doWithdraw;

    // Initial load
    refreshState();
  </script>
</body>
</html>
