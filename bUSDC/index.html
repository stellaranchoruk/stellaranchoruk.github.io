<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>bUSDC Vault ‚Äì Simple UI</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111a2b;
      --muted:#8ea0c2;
      --text:#e8eefc;
      --accent:#5eead4;
      --warn:#fbbf24;
      --bad:#fb7185;
      --ok:#34d399;
      --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1000px 700px at 20% 0%, rgba(94,234,212,.12), transparent 55%),
                 radial-gradient(900px 600px at 95% 15%, rgba(251,113,133,.10), transparent 55%),
                 var(--bg);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1080px; margin:0 auto; padding:22px 16px 60px;}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand h1{margin:0; font-size:20px; letter-spacing:.2px}
    .brand .sub{color:var(--muted); margin-top:4px; font-size:12px}
    .row{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px;}
    @media (max-width: 940px){ .row{grid-template-columns:1fr;} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .card h2{margin:0 0 10px; font-size:15px}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .grid2{grid-template-columns:1fr;} }
    .kv{
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(0,0,0,.18);
      min-height:54px;
    }
    .kv .k{color:var(--muted); font-size:11px; letter-spacing:.2px; text-transform:uppercase}
    .kv .v{margin-top:4px; font-size:14px; word-break:break-all}
    .kv .v.big{font-size:18px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
    }
    .pill .dot{width:8px;height:8px;border-radius:50%; background:var(--muted)}
    .pill.ok .dot{background:var(--ok)}
    .pill.warn .dot{background:var(--warn)}
    .pill.bad .dot{background:var(--bad)}
    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    button{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    button:hover{border-color: rgba(94,234,212,.35)}
    button:disabled{opacity:.5; cursor:not-allowed}
    button.primary{
      background:linear-gradient(180deg, rgba(94,234,212,.22), rgba(94,234,212,.10));
      border-color: rgba(94,234,212,.28);
    }
    button.ghost{
      background:transparent;
    }
    .input{
      display:flex; flex-direction:column; gap:6px; margin-top:10px;
    }
    input, textarea, select{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 11px;
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font:inherit;
    }
    textarea{min-height:120px; resize:vertical; display:none;}
    .small{color:var(--muted); font-size:12px}
    .muted{color:var(--muted)}
    .status-line{margin-top:10px; color:var(--muted)}
    .hr{height:1px; background:var(--border); margin:12px 0}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
    .toast-v4-wrap{
      position:fixed; top:12px; right:12px; z-index:50;
      display:flex; flex-direction:column; gap:10px;
      pointer-events:none;
    }
    .toast-v4{
      pointer-events:auto;
      width:min(380px, calc(100vw - 24px));
      border-radius:14px;
      padding:10px 10px;
      border:1px solid var(--border);
      background:rgba(10,14,22,.86);
      backdrop-filter: blur(8px);
      display:flex; gap:10px; align-items:flex-start;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      animation: tv4in .16s ease-out forwards;
    }
    .toast-v4 .ico{
      width:26px; height:26px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-weight:800;
    }
    .toast-v4.ok .ico{color:var(--ok)}
    .toast-v4.err .ico{color:var(--bad)}
    .toast-v4.info .ico{color:var(--accent)}
    .toast-v4 .body{flex:1}
    .toast-v4 .title{font-weight:800; font-size:12px; letter-spacing:.2px}
    .toast-v4 .msg{font-size:12px; color:var(--muted); margin-top:2px; white-space:pre-wrap}
    .toast-v4 .x{
      border:none; background:transparent; color:var(--muted); cursor:pointer;
      font-size:18px; padding:0 6px;
    }
    @keyframes tv4in{from{transform:translateY(-6px); opacity:0} to{transform:none; opacity:1}}
    @keyframes tv4out{from{transform:none; opacity:1} to{transform:translateY(-6px); opacity:0}}
    .backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; z-index:40;
    }
    .backdrop.open{display:block}
    .modal{
      position:fixed; inset:0;
      display:none; z-index:41;
      place-items:center;
      padding:18px;
    }
    .modal.open{display:grid}
    .modal-inner{
      width:min(540px, 100%);
      background:rgba(16,22,35,.92);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: 0 16px 50px rgba(0,0,0,.5);
      padding:14px;
      backdrop-filter: blur(8px);
    }
    .modal-header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px}
    .modal-header h3{margin:0; font-size:16px}
    .modal-header .x{border:none; background:transparent; color:var(--muted); font-size:20px; cursor:pointer}
    .qr-wrap{margin-top:12px; display:none; gap:12px; align-items:center; flex-direction:column}
    .wallet-choices{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .two-col{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:560px){ .two-col{grid-template-columns:1fr} }
  </style>
</head>

<body>
  <div class="toast-v4-wrap" id="toastV4Wrap" aria-live="polite"></div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>bUSDC Vault UI</h1>
        <div class="sub">Simple interface for the Origin-style vault contract on Soroban + Stellar classic assets.</div>
      </div>
      <div class="pill" id="netPill"><span class="dot"></span><span id="netLabel">Pubnet</span></div>
    </div>

    <div class="row">
      <!-- LEFT -->
      <div class="card">
        <h2>Vault state</h2>

        <div class="grid2">
          <div class="kv">
            <div class="k">Contract</div>
            <div class="v mono" id="contractIdOut"></div>
          </div>
          <div class="kv">
            <div class="k">RPC</div>
            <div class="v mono" id="rpcOut"></div>
          </div>

          <div class="kv">
            <div class="k">Asset code</div>
            <div class="v big" id="assetCodeOut">bUSDC</div>
          </div>
          <div class="kv">
            <div class="k">Issuer</div>
            <div class="v mono" id="issuerOut"></div>
          </div>

          <div class="kv">
            <div class="k">Share token (Soroban ID)</div>
            <div class="v mono" id="shareOut">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Underlying asset (Soroban ID)</div>
            <div class="v mono" id="assetOut">‚Äî</div>
          </div>

          <div class="kv">
            <div class="k">Share price (assets per share)</div>
            <div class="v big" id="sharePriceOut">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Implied bUSDC value</div>
            <div class="v big" id="impliedOut">‚Äî</div>
          </div>

          <div class="kv">
            <div class="k">Total assets</div>
            <div class="v" id="totalAssetsOut">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Total supply</div>
            <div class="v" id="totalSupplyOut">‚Äî</div>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="refreshBtn">Refresh state</button>
          <button class="ghost" id="toggleLogsBtn">Show logs</button>
        </div>

        <textarea id="logs" class="mono" spellcheck="false"></textarea>

        <div class="status-line small" id="stateStatus"></div>

        <div class="hr"></div>

        <h2>Deposit / Withdraw</h2>
        <div class="small muted">
          These actions build a Soroban transaction, prepare it via RPC, then sign via WalletConnect / Freighter / Secret Key.
          Vault accounts trigger the ‚Äúcopy signed XDR and co-sign in LOBSTR Vault‚Äù flow. 
        </div>

        <div class="two-col" style="margin-top:10px">
          <div>
            <div class="input">
              <label class="small">Deposit amount (USDC units)</label>
              <input id="depositAmt" inputmode="decimal" placeholder="e.g. 100.00" />
            </div>
            <div class="actions">
              <button id="depositBtn" class="primary">Deposit</button>
              <button id="depositXdrToggle">Reveal XDR</button>
            </div>
            <textarea id="depositXdr" class="mono" spellcheck="false"></textarea>
            <div class="status-line small" id="depositStatus"></div>
          </div>

          <div>
            <div class="input">
              <label class="small">Withdraw amount (bUSDC shares)</label>
              <input id="withdrawAmt" inputmode="decimal" placeholder="e.g. 100.00" />
            </div>
            <div class="actions">
              <button id="withdrawBtn" class="primary">Withdraw</button>
              <button id="withdrawXdrToggle">Reveal XDR</button>
            </div>
            <textarea id="withdrawXdr" class="mono" spellcheck="false"></textarea>
            <div class="status-line small" id="withdrawStatus"></div>
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>Wallet</h2>

        <div class="kv">
          <div class="k">Connection</div>
          <div class="v" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div>
              <div id="connStatus" class="pill bad" style="display:inline-flex"><span class="dot"></span><span>Not connected</span></div>
              <div class="small muted" id="connModeLine" style="margin-top:6px">‚Äî</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
              <button id="connectBtn" class="primary">Connect</button>
              <button id="disconnectBtn" disabled>Disconnect</button>
            </div>
          </div>
        </div>

        <div class="input">
          <label class="small">Public key (G...)</label>
          <input id="pubkeyEl" class="mono" placeholder="G..." />
          <div class="actions">
            <button id="usePubkeyBtn">Use pubkey (read-only)</button>
            <button id="openExplorerBtn">Open in StellarExpert</button>
          </div>
        </div>

        <div class="input">
          <label class="small">Secret key (S...) (optional)</label>
          <input id="seckeyEl" class="mono" placeholder="S... (not stored)" />
          <div class="small muted">
            If you use secret-key mode, signing happens locally in this browser tab (no storage).
          </div>
          <div class="actions">
            <button id="useSecretBtn">Use secret (local signing)</button>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Balances</h2>
        <div class="grid2">
          <div class="kv">
            <div class="k">bUSDC balance</div>
            <div class="v big" id="busdcBalOut">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Selling liabilities</div>
            <div class="v" id="busdcLiaOut">‚Äî</div>
          </div>
        </div>
        <div class="actions">
          <button id="refreshBalBtn" class="primary">Refresh balance</button>
        </div>
        <div class="status-line small" id="balStatus"></div>

        <div class="hr"></div>

        <h2>Links</h2>
        <div class="small muted">
          Vault: <span class="mono">CCR63UWZKPVR2OAZJEBHT4OKBLHX2OAMUYZ63JLO2V72FY3SKAXQTGF6</span><br/>
          bUSDC issuer: <span class="mono">GA57KXF2UAGURRYK4LKTO4BO2JASL2PQCO2C53XUNK5G4CXX6QAL6QNR</span>
        </div>

      </div>
    </div>
  </div>

  <!-- Connect Modal -->
  <div id="backdrop" class="backdrop"></div>
  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-inner">
      <div class="modal-header">
        <h3 id="loginTitle">Connect Wallet</h3>
        <button class="x" id="closeModal" aria-label="Close">√ó</button>
      </div>
      <div class="small">Pick a login method:</div>
      <div class="actions" style="margin-top:10px">
        <button id="wcBtn">üîó WalletConnect (mobile)</button>
        <button id="freighterExtBtn">üß© Freighter (extension)</button>
      </div>

      <div id="qrArea" class="qr-wrap">
        <canvas id="qrCanvas" width="256" height="256" style="background:#fff;border-radius:12px"></canvas>
        <div class="wallet-choices">
          <button id="btnLobstr">Open in LOBSTR</button>
          <button id="btnFreighter">Open in Freighter</button>
        </div>
        <div class="small">
          Scan with your wallet app, or tap above on mobile. ¬∑
          <a id="rawWcLink" class="link" href="#" target="_blank" rel="noreferrer">raw wc link</a>
        </div>
        <div id="linkStatus" class="small muted"></div>
      </div>
    </div>
  </div>

  <!-- Sign Prompt Modal -->
  <div id="signBackdrop" class="backdrop"></div>
  <div id="signModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="signTitle">
    <div class="modal-inner">
      <div class="modal-header">
        <h3 id="signTitle">Sign Transaction</h3>
        <button class="x" id="closeSign" aria-label="Close">√ó</button>
      </div>
      <p class="small">
        Your transaction is ready to sign.
        <br><br>
        <b>Desktop:</b> approve in the wallet connected via WalletConnect.
        <br><br>
        <b>Mobile:</b> open your wallet:
      </p>
      <div class="wallet-choices">
        <button id="signLobstr">Open in LOBSTR</button>
        <button id="signFreighter">Open in Freighter</button>
      </div>
    </div>
  </div>

  <!-- Vault Modal -->
  <div id="vaultBackdrop" class="backdrop"></div>
  <div id="vaultModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="vaultTitle">
    <div class="modal-inner">
      <div class="modal-header">
        <h3 id="vaultTitle">LOBSTR Vault co-sign required</h3>
        <button class="x" id="closeVault" aria-label="Close">√ó</button>
      </div>
      <div class="small muted">
        This account appears to be protected by LOBSTR Vault. We won‚Äôt submit the tx.
        Copy the signed XDR below and complete co-signing inside LOBSTR Vault.
      </div>
      <div class="actions">
        <button id="copySignedXdr" class="primary">Copy signed XDR</button>
        <button id="toggleVaultXdr">Reveal XDR</button>
      </div>
      <textarea id="signedXdrOut" class="mono" spellcheck="false" style="display:none"></textarea>
    </div>
  </div>

  <!-- WalletConnect deps -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/sign-client@2.17.1/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script type="module">
    // -----------------------
    // Config (EDIT ME)
    // -----------------------
    const CONTRACT_ID = "CCR63UWZKPVR2OAZJEBHT4OKBLHX2OAMUYZ63JLO2V72FY3SKAXQTGF6";

    // bUSDC classic asset (for balance lookup / display)
    const BUSDC_CODE   = "bUSDC";
    const BUSDC_ISSUER = "GA57KXF2UAGURRYK4LKTO4BO2JASL2PQCO2C53XUNK5G4CXX6QAL6QNR";

    // Pubnet
    const NETWORK = "Public Global Stellar Network ; September 2015";
    const HORIZON = "https://horizon.stellar.org";

    // Soroban RPC (your suggestion)
    const SOROBAN_RPC = "https://rpc.lightsail.network/";
    // const SOROBAN_RPC = "https://mainnet.sorobanrpc.com"; // fallback if needed

    // LOBSTR Vault signer key (same pattern as your AQUAmb page)
    const VAULT_KEY = "GA2T6GR7VXXXBETTERSAFETHANSORRYXXXPROTECTEDBYLOBSTRVAULT";

    // WalletConnect (same pattern as your AQUAmb page)
    const PROJECT_ID = "f658ce3a7c8a185214974f71539fea39";
    const EXPLORER   = "https://explorer-api.walletconnect.com/v3/wallets";

    // -----------------------
    // Imports
    // -----------------------
    import * as SDK from "https://esm.sh/stellar-sdk@12.1.0";

    // -----------------------
    // DOM
    // -----------------------
    const $ = (id)=>document.getElementById(id);
    const contractIdOut = $("contractIdOut");
    const rpcOut = $("rpcOut");
    const issuerOut = $("issuerOut");

    const shareOut = $("shareOut");
    const assetOut = $("assetOut");
    const sharePriceOut = $("sharePriceOut");
    const impliedOut = $("impliedOut");
    const totalAssetsOut = $("totalAssetsOut");
    const totalSupplyOut = $("totalSupplyOut");
    const stateStatus = $("stateStatus");
    const refreshBtn = $("refreshBtn");
    const toggleLogsBtn = $("toggleLogsBtn");
    const logsEl = $("logs");

    const pubkeyEl = $("pubkeyEl");
    const seckeyEl = $("seckeyEl");
    const connectBtn = $("connectBtn");
    const disconnectBtn = $("disconnectBtn");
    const usePubkeyBtn = $("usePubkeyBtn");
    const useSecretBtn = $("useSecretBtn");
    const openExplorerBtn = $("openExplorerBtn");

    const connStatus = $("connStatus");
    const connModeLine = $("connModeLine");

    const busdcBalOut = $("busdcBalOut");
    const busdcLiaOut = $("busdcLiaOut");
    const refreshBalBtn = $("refreshBalBtn");
    const balStatus = $("balStatus");

    const depositAmt = $("depositAmt");
    const withdrawAmt = $("withdrawAmt");
    const depositBtn = $("depositBtn");
    const withdrawBtn = $("withdrawBtn");
    const depositXdr = $("depositXdr");
    const withdrawXdr = $("withdrawXdr");
    const depositXdrToggle = $("depositXdrToggle");
    const withdrawXdrToggle = $("withdrawXdrToggle");
    const depositStatus = $("depositStatus");
    const withdrawStatus = $("withdrawStatus");

    // Modals
    const backdrop = $("backdrop");
    const loginModal = $("loginModal");
    const closeModal = $("closeModal");
    const wcBtn = $("wcBtn");
    const freighterExtBtn = $("freighterExtBtn");
    const qrArea = $("qrArea");
    const qrCanvas = $("qrCanvas");
    const btnLobstr = $("btnLobstr");
    const btnFreighter = $("btnFreighter");
    const rawWcLink = $("rawWcLink");
    const linkStatus = $("linkStatus");

    const signBackdrop = $("signBackdrop");
    const signModal = $("signModal");
    const closeSign = $("closeSign");
    const signLobstr = $("signLobstr");
    const signFreighter = $("signFreighter");

    const vaultBackdrop = $("vaultBackdrop");
    const vaultModal = $("vaultModal");
    const closeVault = $("closeVault");
    const copySignedXdr = $("copySignedXdr");
    const toggleVaultXdr = $("toggleVaultXdr");
    const signedXdrOut = $("signedXdrOut");

    // -----------------------
    // Helpers
    // -----------------------
    const toastV4Wrap = $("toastV4Wrap");
    function toastV4({ type="info", title="", message="", timeout=2600 } = {}){
      const el = document.createElement("div");
      el.className = `toast-v4 ${type}`;
      const icon = type==="ok" ? "‚úì" : type==="err" ? "!" : "‚ÑπÔ∏é";
      el.innerHTML = `
        <div class="ico">${icon}</div>
        <div class="body">${title?`<div class="title">${title}</div>`:""}<div class="msg">${message||""}</div></div>
        <button class="x" aria-label="Close">√ó</button>`;
      toastV4Wrap.appendChild(el);
      const close = ()=>{ el.style.animation="tv4out .16s ease-in forwards"; setTimeout(()=>el.remove(), 180); };
      el.querySelector(".x").onclick = close;
      if(timeout) setTimeout(close, timeout);
      return { close };
    }
    const toast = (msg, err=false)=> toastV4({ type: err ? "err" : "ok", title: err ? "Error" : "Done", message: msg });

    const isValidG = (k)=>{ try{return SDK.StrKey.isValidEd25519PublicKey(k);}catch{return false;} };
    const isValidS = (k)=>{ try{return SDK.StrKey.isValidEd25519SecretSeed(k);}catch{return false;} };

    function fmt7(x){
      const n = Number(x);
      if(!isFinite(n)) return String(x ?? "‚Äî");
      return n.toFixed(7).replace(/\.?0+$/,'');
    }
    function parseAmtToI128_7dp(amountStr){
      // Convert decimal string into integer scaled by 1e7 (as BigInt)
      const s = String(amountStr||"").trim().replace(/,/g,"");
      if(!s) return 0n;
      const neg = s.startsWith("-");
      const t = neg ? s.slice(1) : s;
      const [i, dRaw=""] = t.split(".");
      const d = (dRaw + "0000000").slice(0,7);
      const bi = BigInt(i || "0");
      const bd = BigInt(d || "0");
      const v = bi * 10000000n + bd;
      return neg ? -v : v;
    }

    // JSON BigInt safe
    const jsonBig = (obj)=>JSON.stringify(obj, (_k,v)=> typeof v==="bigint" ? v.toString() : v, 2);

    function logLine(...args){
      const line = args.map(a=>{
        if(typeof a === "string") return a;
        try{ return jsonBig(a); }catch{ return String(a); }
      }).join(" ");
      logsEl.value += line + "\n";
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    function toggleEl(el, btn){
      const hidden = el.style.display === "none" || !el.style.display;
      el.style.display = hidden ? "block" : "none";
      btn.textContent = hidden ? "Hide XDR" : "Reveal XDR";
    }

    // -----------------------
    // RPC / SDK setup
    // -----------------------
    const ServerCtor = SDK.Horizon?.Server ?? SDK.Server; // avoids the undefined Server issue
    const rpc = ()=> new (SDK.SorobanRpc?.Server ?? SDK.SorobanRpcServer)(SOROBAN_RPC, { allowHttp: SOROBAN_RPC.startsWith("http://") });

    const contract = new SDK.Contract(CONTRACT_ID);

    // Use the pubnet master account for simulation (always exists)
    const SIM_SOURCE = "GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF";

    // -----------------------
    // Wallet state
    // -----------------------
    let connectionMode = "none"; // none | wc | freighter | pubkey | secret
    let pubkey = null;
    let secretKey = null;

    // WC session
    const SignClient = window.SignClient?.default || window.SignClient;
    let wcClient = null;
    let session = null;
    let latestWcUri = null;

    // -----------------------
    // Vault modal
    // -----------------------
    function openVaultModal(xdr){
      signedXdrOut.value = xdr || "";
      vaultBackdrop.classList.add("open");
      vaultModal.classList.add("open");
    }
    function closeVaultModal(){
      vaultBackdrop.classList.remove("open");
      vaultModal.classList.remove("open");
    }
    closeVault.onclick = closeVaultModal;
    vaultBackdrop.addEventListener("click", (e)=>{ if(e.target===vaultBackdrop) closeVaultModal(); });
    copySignedXdr.onclick = async ()=>{
      try{ await navigator.clipboard.writeText(signedXdrOut.value||""); toast("Signed XDR copied."); }
      catch{ toast("Clipboard failed.", true); }
    };
    toggleVaultXdr.onclick = ()=> toggleEl(signedXdrOut, toggleVaultXdr);

    // -----------------------
    // Connection UI
    // -----------------------
    function setConnPill(kind, label){
      connStatus.classList.remove("ok","warn","bad");
      connStatus.classList.add(kind);
      connStatus.querySelector("span:last-child").textContent = label;
    }
    async function detectVault(account){
      if(!account) return false;
      try{
        const r = await fetch(`${HORIZON}/accounts/${account}`);
        const j = await r.json();
        const ks = (j.signers || []).map(s => s.key);
        return ks.includes(VAULT_KEY);
      }catch{
        return false;
      }
    }

    function setConnected(address, mode){
      pubkey = address || null;
      connectionMode = mode || "none";

      disconnectBtn.disabled = !pubkey;
      if(pubkey) pubkeyEl.value = pubkey;

      if(!pubkey){
        setConnPill("bad","Not connected");
        connModeLine.textContent = "‚Äî";
        return;
      }

      // Vault-aware label
      detectVault(pubkey).then((hasVault)=>{
        if(hasVault){
          setConnPill("warn","LOBSTR Vault");
          connModeLine.textContent = `Mode: ${connectionMode} ¬∑ Vault protected`;
        }else{
          setConnPill("ok","Connected");
          connModeLine.textContent = `Mode: ${connectionMode}`;
        }
      });

      // refresh balance right away
      refreshBalance().catch(()=>{});
    }

    // -----------------------
    // Modals
    // -----------------------
    function openModal(){ backdrop.classList.add("open"); loginModal.classList.add("open"); }
    function closeModalFn(){ backdrop.classList.remove("open"); loginModal.classList.remove("open"); qrArea.style.display="none"; }
    connectBtn.onclick = openModal;
    closeModal.onclick = closeModalFn;
    backdrop.addEventListener("click", closeModalFn);

    function openSignModal(){ signBackdrop.classList.add("open"); signModal.classList.add("open"); }
    function closeSignModal(){ signBackdrop.classList.remove("open"); signModal.classList.remove("open"); }
    closeSign.onclick = closeSignModal;
    signBackdrop.addEventListener("click", closeSignModal);

    // -----------------------
    // WalletConnect helpers (same approach as AQUAmb)
    // -----------------------
    const isIOS = ()=> /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    async function purgeWcStorage(){
      try{
        Object.keys(localStorage).forEach(k=>{
          if(k.startsWith("wc@2")) localStorage.removeItem(k);
        });
      }catch{}
    }

    async function ensureClient({ retry=false } = {}){
      if(wcClient) return wcClient;
      try{
        wcClient = await SignClient.init({
          projectId: PROJECT_ID,
          relayUrl: "wss://relay.walletconnect.com",
          metadata: {
            name: "bUSDC Vault UI",
            description: "Vault-aware Soroban vault UI",
            url: location.origin,
            icons: ["https://walletconnect.com/walletconnect-logo.png"]
          }
        });
        // cleanup expired pairings
        try{
          const pairings = wcClient.core.pairing.getPairings?.() || [];
          for(const p of pairings){
            if(p.expiry && p.expiry*1000 < Date.now()){
              wcClient.core.pairing.disconnect({ topic:p.topic });
            }
          }
        }catch{}
        return wcClient;
      }catch(e){
        if(!retry && /No matching key/i.test(String(e?.message||e))){
          await purgeWcStorage();
          wcClient = null;
          return ensureClient({ retry:true });
        }
        throw e;
      }
    }

    async function getFreighterLinks(){
      try{
        const url = `${EXPLORER}?projectId=${encodeURIComponent(PROJECT_ID)}&entries=200&page=1`;
        const res = await fetch(url);
        const data = await res.json();
        const raw = data?.listings ?? data?.data ?? [];
        const arr = Array.isArray(raw) ? raw : Object.values(raw);
        const w = arr.find(it => ((it.name||it.app?.name||"").toLowerCase()).includes("freighter"));
        const mobile = w?.mobile || w?.app?.mobile || {};
        return { native: mobile.native||mobile.nativeLink||null, universal: mobile.universal||mobile.universalLink||null, found: !!w };
      }catch{
        return { native:null, universal:null, found:false };
      }
    }
    function buildCandidates(base, wcUri){
      if(!base) return [];
      const enc = encodeURIComponent(wcUri);
      if (base.includes("{wc}") || base.includes("{URI}")) return [ base.replace("{wc}",enc).replace("{URI}",enc) ];
      const j = base.includes("?") ? "&" : "?";
      return [ `${base}${j}wc=${enc}`, `${base}${j}uri=${enc}` ];
    }
    function openFreighterSmart(links, wcUri){
      const store = isIOS()
        ? "https://apps.apple.com/app/freighter/id6743947720"
        : "https://play.google.com/store/apps/details?id=org.stellar.freighterwallet&pli=1";
      const natives = buildCandidates(links.native, wcUri);
      const universals = buildCandidates(links.universal, wcUri);
      let attempted=false;
      for(const href of natives){ attempted=true; window.location.href = href; setTimeout(()=>{},350); }
      if(universals.length){ attempted=true; window.open(universals[0], "_blank", "noopener"); }
      if(!attempted){ window.open(store, "_blank", "noopener"); }
    }
    function openLobstrApp(uri){
      const scheme = `lobstr://wc?uri=${encodeURIComponent(uri)}`;
      const store  = isIOS()
        ? "https://apps.apple.com/app/id1404357892"
        : "https://play.google.com/store/apps/details?id=com.lobstr.client";
      const t0 = Date.now();
      window.location.href = scheme;
      setTimeout(()=>{ if(!document.hidden && Date.now()-t0<2000){ window.open(store, "_blank", "noopener"); } }, 1800);
    }

    // -----------------------
    // Freighter connect
    // -----------------------
    async function ensureFreighterApi(){
      if (window.freighterApi) return window.freighterApi;
      try{
        const mod = await import("https://esm.sh/@stellar/freighter-api@5.0.0");
        window.freighterApi = mod?.default ?? mod;
        return window.freighterApi;
      }catch{
        return null;
      }
    }

    freighterExtBtn.onclick = async ()=>{
      try{
        const freighter = await ensureFreighterApi();
        if(!freighter){ alert("Freighter extension not detected."); return; }

        let address = "";
        try { address = await freighter.getPublicKey(); } catch {}
        if(!address && freighter.getAddress){ const r=await freighter.getAddress(); address=r?.address||""; }
        if(!address && freighter.requestAccess){ const r=await freighter.requestAccess(); address=r?.address||""; }
        if(!address){ alert("Freighter connect denied or failed."); return; }

        secretKey = null;
        closeModalFn();
        setConnected(address, "freighter");
        toast("Freighter connected.");
      }catch(e){
        console.error(e);
        alert("Freighter connect failed.");
      }
    };

    // -----------------------
    // WalletConnect connect
    // -----------------------
    wcBtn.onclick = async ()=>{
      try{
        const sc = await ensureClient();
        toast("Starting WalletConnect‚Ä¶");

        const { uri, approval } = await sc.connect({
          optionalNamespaces: {
            stellar: { chains:["stellar:pubnet"], methods:["stellar_signXDR","stellar_signAndSubmitXDR"], events:[] }
          }
        });

        if(!uri) throw new Error("No WalletConnect URI");
        latestWcUri = uri;

        try { await QRCode.toCanvas(qrCanvas, uri, { width:256, margin:1 }); } catch {}
        qrArea.style.display = "flex";
        rawWcLink.href = uri;

        linkStatus.textContent = "Loading Freighter deep link‚Ä¶";
        const freighterLinks = await getFreighterLinks();
        linkStatus.textContent = freighterLinks.found ? "" : "Freighter link not found ‚Äî store fallback.";

        btnLobstr.onclick = ()=> openLobstrApp(latestWcUri);
        btnFreighter.onclick = async ()=>{
          const links = await getFreighterLinks();
          openFreighterSmart(links, latestWcUri);
        };

        session = await approval();

        // Extract address
        const accounts = session.namespaces?.stellar?.accounts || [];
        const first = accounts.find(a=>a.startsWith("stellar:pubnet")) || accounts[0] || "";
        const address = first.split(":")[2] || "";
        if(!isValidG(address)) throw new Error("WC returned invalid address.");

        secretKey = null;
        wcClient = sc;
        qrArea.style.display="none";
        closeModalFn();
        setConnected(address, "wc");
        toast("WalletConnect connected.");
      }catch(e){
        console.error(e);
        toast("Connection canceled or failed.", true);
      }
    };

    // Sign buttons inside sign modal
    signLobstr.onclick = ()=> { if(latestWcUri) openLobstrApp(latestWcUri); };
    signFreighter.onclick = async ()=> {
      if(!latestWcUri) return;
      const links = await getFreighterLinks();
      openFreighterSmart(links, latestWcUri);
    };

    // Disconnect
    disconnectBtn.onclick = async ()=>{
      try{
        if(connectionMode==="wc" && wcClient && session){
          await wcClient.disconnect({ topic: session.topic, reason:{ code:6000, message:"User disconnected" }});
        }
      }catch(e){ console.warn(e); }
      session = null;
      wcClient = null;
      secretKey = null;
      setConnected("", "none");
      toast("Disconnected.");
    };

    // Manual pubkey / secret key modes
    usePubkeyBtn.onclick = ()=>{
      const pk = pubkeyEl.value.trim();
      if(!isValidG(pk)) { toast("Invalid public key.", true); return; }
      secretKey = null;
      setConnected(pk, "pubkey");
      toast("Pubkey set (read-only).");
    };
    useSecretBtn.onclick = ()=>{
      const sk = seckeyEl.value.trim();
      if(!isValidS(sk)) { toast("Invalid secret key.", true); return; }
      const kp = SDK.Keypair.fromSecret(sk);
      secretKey = sk;
      setConnected(kp.publicKey(), "secret");
      toast("Secret key set (local signing).");
    };
    openExplorerBtn.onclick = ()=>{
      const pk = pubkeyEl.value.trim();
      if(!isValidG(pk)) return;
      window.open(`https://stellar.expert/explorer/public/account/${pk}`, "_blank", "noopener,noreferrer");
    };

    // -----------------------
    // Signing (shared pattern)
    // -----------------------
    const wcRequest = (method, xdr) => wcClient.request({
      topic: session.topic, chainId: "stellar:pubnet",
      request: { jsonrpc:"2.0", method, params:{ xdr } }
    });

    async function signCurrent(xdr){
      if(connectionMode==="wc"){
        const r = await wcRequest("stellar_signXDR", xdr);
        if(!r?.signedXDR) throw new Error("WalletConnect: no signedXDR");
        return r.signedXDR;
      }
      if(connectionMode==="freighter"){
        const api = await ensureFreighterApi();
        const res = await api.signTransaction(xdr, { networkPassphrase: NETWORK, accountToSign: pubkey });
        if(res?.error) throw new Error(res.error.message||"Freighter: sign failed");
        return res.signedTxXdr || res.signedXDR || res;
      }
      if(connectionMode==="secret"){
        if(!secretKey) throw new Error("No secret key loaded.");
        const tx = SDK.TransactionBuilder.fromXDR(xdr, NETWORK);
        tx.sign(SDK.Keypair.fromSecret(secretKey));
        return tx.toXDR();
      }
      throw new Error("Not connected (or read-only pubkey mode).");
    }

    async function handleSignedSorobanXdr(signedXdr, statusEl){
      const pk = pubkeyEl.value.trim();
      const hasVault = await detectVault(pk);
      if(hasVault){
        try{ await navigator.clipboard.writeText(signedXdr); }catch{}
        openVaultModal(signedXdr);
        if(statusEl) statusEl.textContent = "Signed. Vault co-sign required (XDR copied / shown).";
        return null;
      }
      const final = await submitToSoroban(signedXdr);
      return final;
    }

    async function submitToSoroban(signedXdr){
      const tx = SDK.TransactionBuilder.fromXDR(signedXdr, NETWORK);
      const send = await rpc().sendTransaction(tx);
      if (send.status !== "PENDING" && send.status !== "SUCCESS"){
        throw new Error(`Soroban send failed: ${send.status}`);
      }
      let final = await rpc().getTransaction(send.hash);
      let tries = 0;
      while(final.status === "NOT_FOUND" && tries < 12){
        await new Promise(r=>setTimeout(r, 800));
        final = await rpc().getTransaction(send.hash);
        tries++;
      }
      if(final.status !== "SUCCESS") throw new Error(`Tx failed: ${final.status}`);
      return final;
    }

    // -----------------------
    // Contract read helpers
    // -----------------------
    async function simulateRead(method, args = []){
      const source = await rpc().getAccount(SIM_SOURCE);
      const tx = new SDK.TransactionBuilder(source, {
        fee: "10000",
        networkPassphrase: NETWORK
      })
        .addOperation(contract.call(method, ...args))
        .setTimeout(180)
        .build();

      logLine(`‚Üí simulate ${method}()`);
      const sim = await rpc().simulateTransaction(tx);
      if(sim.error) throw new Error(sim.error);
      if(!sim.result) throw new Error("No simulate result.");
      logLine(`‚Üê ${method}() ok`);
      return sim;
    }

    function unwrapU128(sim){
      // Depending on SDK version, the shape varies slightly.
      // Try common shapes:
      const rv = sim?.result?.retval ?? sim?.result?.returnValue ?? sim?.result?.results?.[0]?.xdr;
      // If already a number-like:
      if(typeof rv === "bigint") return rv;
      if(typeof rv === "number") return BigInt(Math.trunc(rv));
      // If it‚Äôs an object with u128:
      if(rv && typeof rv === "object" && "u128" in rv) return BigInt(rv.u128);
      // If it‚Äôs a string of digits:
      if(typeof rv === "string" && /^\d+$/.test(rv)) return BigInt(rv);

      // If it‚Äôs an XDR base64, we can‚Äôt reliably decode here without ABI;
      // return 0 and log for debugging.
      logLine("WARN: could not unwrap u128, rv=", rv);
      return 0n;
    }

    function unwrapAddress(sim){
      const rv = sim?.result?.retval ?? sim?.result?.returnValue;
      if(typeof rv === "string") return rv;
      if(rv?.address) return rv.address;
      if(rv?.value) return rv.value;
      return String(rv ?? "‚Äî");
    }

    // -----------------------
    // Contract write builders
    // -----------------------
    async function buildWriteXDR(method, args = []){
      if(!pubkey || !isValidG(pubkey)) throw new Error("Connect a wallet first.");
      const source = await rpc().getAccount(pubkey);

      // base tx
      let tx = new SDK.TransactionBuilder(source, { fee:"10000", networkPassphrase: NETWORK })
        .addOperation(contract.call(method, ...args))
        .setTimeout(180)
        .build();

      // prepare (Soroban footprint, etc.)
      tx = await rpc().prepareTransaction(tx);
      return tx.toXDR();
    }

    // -----------------------
    // UI: state refresh
    // -----------------------
    async function refreshState(){
      stateStatus.textContent = "Refreshing‚Ä¶";
      try{
        // These are the view methods you already tested:
        // query_asset, query_share, share_price, total_assets, total_supply
        const [assetSim, shareSim, spSim, taSim, tsSim] = await Promise.all([
          simulateRead("query_asset"),
          simulateRead("query_share"),
          simulateRead("share_price"),
          simulateRead("total_assets"),
          simulateRead("total_supply"),
        ]);

        const assetId = unwrapAddress(assetSim);
        const shareId = unwrapAddress(shareSim);

        const sharePriceRaw = unwrapU128(spSim);     // scaled? (we show 7dp)
        const totalAssetsRaw = unwrapU128(taSim);
        const totalSupplyRaw = unwrapU128(tsSim);

        // Heuristic: display as 7dp token amounts
        const sp = Number(sharePriceRaw) / 1e7;
        const ta = Number(totalAssetsRaw) / 1e7;
        const ts = Number(totalSupplyRaw) / 1e7;

        shareOut.textContent = shareId;
        assetOut.textContent = assetId;

        sharePriceOut.textContent = fmt7(sp);
        impliedOut.textContent = `1 bUSDC ‚âà ${fmt7(sp)} USDC`;

        totalAssetsOut.textContent = `${fmt7(ta)} (units)`;
        totalSupplyOut.textContent = `${fmt7(ts)} (shares)`;

        stateStatus.textContent = "Updated.";
      }catch(e){
        console.error(e);
        stateStatus.textContent = `Error: ${e.message || e}`;
        toast(e.message || "Refresh failed.", true);
      }
    }

    // -----------------------
    // Balance refresh (Horizon classic)
    // -----------------------
    async function refreshBalance(){
      const pk = pubkeyEl.value.trim();
      if(!isValidG(pk)){
        busdcBalOut.textContent = "‚Äî";
        busdcLiaOut.textContent = "‚Äî";
        return;
      }
      balStatus.textContent = "Loading Horizon balances‚Ä¶";
      try{
        const r = await fetch(`${HORIZON}/accounts/${pk}`);
        const j = await r.json();
        const bal = (j.balances || []).find(b => b.asset_code===BUSDC_CODE && b.asset_issuer===BUSDC_ISSUER);
        busdcBalOut.textContent = bal ? fmt7(Number(bal.balance)) : "0";
        busdcLiaOut.textContent = bal ? fmt7(Number(bal.selling_liabilities || "0")) : "0";
        balStatus.textContent = "";
      }catch(e){
        console.error(e);
        balStatus.textContent = "Could not load balance.";
      }
    }

    // -----------------------
    // Deposit / Withdraw actions
    // -----------------------
    depositXdrToggle.onclick = ()=> toggleEl(depositXdr, depositXdrToggle);
    withdrawXdrToggle.onclick = ()=> toggleEl(withdrawXdr, withdrawXdrToggle);

    depositBtn.onclick = async ()=>{
      depositStatus.textContent = "";
      try{
        if(!pubkey) { openModal(); return; }
        if(connectionMode==="pubkey") throw new Error("Read-only pubkey mode cannot sign. Use WC/Freighter/Secret.");

        const amt = parseAmtToI128_7dp(depositAmt.value);
        if(!(amt > 0n)) throw new Error("Enter a deposit amount.");

        // TODO: if your method name differs, change "deposit" here.
        const xdr = await buildWriteXDR("deposit", [amt]);
        depositXdr.value = xdr;

        if(connectionMode==="wc") openSignModal();
        toast("Check your wallet to sign‚Ä¶");

        const signed = await signCurrent(xdr);
        const final = await handleSignedSorobanXdr(signed, depositStatus);

        if(final){
          depositStatus.innerHTML = `Submitted ‚úì hash: <span class="mono">${final.hash}</span> ¬∑ <a href="https://stellar.expert/explorer/public/tx/${final.hash}" target="_blank" rel="noreferrer">view</a>`;
          toast("Deposit submitted.");
          refreshBalance().catch(()=>{});
          refreshState().catch(()=>{});
        }else{
          toast("Deposit signed. Complete in LOBSTR Vault.");
        }
        closeSignModal();
      }catch(e){
        console.error(e);
        closeSignModal();
        depositStatus.textContent = `Error: ${e.message || e}`;
        toast(e.message || "Deposit failed.", true);
      }
    };

    withdrawBtn.onclick = async ()=>{
      withdrawStatus.textContent = "";
      try{
        if(!pubkey) { openModal(); return; }
        if(connectionMode==="pubkey") throw new Error("Read-only pubkey mode cannot sign. Use WC/Freighter/Secret.");

        const amt = parseAmtToI128_7dp(withdrawAmt.value);
        if(!(amt > 0n)) throw new Error("Enter a withdraw amount.");

        // TODO: if your method name differs, change "withdraw" here.
        const xdr = await buildWriteXDR("withdraw", [amt]);
        withdrawXdr.value = xdr;

        if(connectionMode==="wc") openSignModal();
        toast("Check your wallet to sign‚Ä¶");

        const signed = await signCurrent(xdr);
        const final = await handleSignedSorobanXdr(signed, withdrawStatus);

        if(final){
          withdrawStatus.innerHTML = `Submitted ‚úì hash: <span class="mono">${final.hash}</span> ¬∑ <a href="https://stellar.expert/explorer/public/tx/${final.hash}" target="_blank" rel="noreferrer">view</a>`;
          toast("Withdraw submitted.");
          refreshBalance().catch(()=>{});
          refreshState().catch(()=>{});
        }else{
          toast("Withdraw signed. Complete in LOBSTR Vault.");
        }
        closeSignModal();
      }catch(e){
        console.error(e);
        closeSignModal();
        withdrawStatus.textContent = `Error: ${e.message || e}`;
        toast(e.message || "Withdraw failed.", true);
      }
    };

    // -----------------------
    // Init
    // -----------------------
    contractIdOut.textContent = CONTRACT_ID;
    rpcOut.textContent = SOROBAN_RPC;
    issuerOut.textContent = BUSDC_ISSUER;

    refreshBtn.onclick = refreshState;
    refreshBalBtn.onclick = refreshBalance;

    toggleLogsBtn.onclick = ()=>{
      toggleEl(logsEl, toggleLogsBtn);
      if(logsEl.style.display === "block") toggleLogsBtn.textContent = "Hide logs";
      else toggleLogsBtn.textContent = "Show logs";
    };

    // first load
    refreshState().catch(()=>{});
  </script>

  <!-- Freighter UMD fallback -->
  <script>
    if(!window.freighterApi){
      const s = document.createElement("script");
      s.src = "https://cdn.freighter.app/freighter-api-v1.js";
      document.head.appendChild(s);
    }
  </script>
</body>
</html>
