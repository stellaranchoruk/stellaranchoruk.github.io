<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aquarius Vote Booster Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 10px; }
    pre { background: #f9f9f9; padding: 10px; white-space: pre-wrap; word-break: break-word; }
    .controls { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 20px; }
    .control { display: flex; flex-direction: column; }
    .control label { margin-bottom: 4px; font-size: 0.9em; }
    .control input { padding: 4px; width: 100px; }
    .chart-container { max-width: 600px; margin-top: 20px; }
    .table-container { overflow-x: auto; margin-top: 40px; }
    table { border-collapse: collapse; width: 100%; min-width: 800px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    input[type=number] { width: 80px; }
    @media (max-width: 600px) {
      .controls { flex-direction: column; }
      .control input { width: 80px; }
      table { min-width: 600px; }
    }
  </style>
</head>
<body>
  <h2>Aquarius Vote Booster Simulator</h2>
  <p>Boost formula (fixed):</p>
  <pre>Boost = 1 + MaxBoost × e<sup>–Bribe / (R_market_cap ÷ Divisor)</sup></pre>

  <div class="controls">
    <div class="control">
      <label for="divisor">Divisor</label>
      <input type="number" id="divisor" value="5" min="1" />
    </div>
    <div class="control">
      <label for="rTotal">R_total (AQUA/day)</label>
      <input type="number" id="rTotal" value="7000000" min="0" />
    </div>
    <div class="control">
      <label for="pCap">P_cap (%)</label>
      <input type="number" id="pCap" value="10" min="0" max="100" />
    </div>
    <div class="control">
      <label for="rMarketCap">R_market_cap</label>
      <input type="text" id="rMarketCap" value="700000" disabled />
    </div>
  </div>

  <div class="chart-container">
    <canvas id="curveChart"></canvas>
  </div>

  <div id="loading">Loading data<span id="dots"></span></div>

  <div class="table-container" id="tableWrapper" style="display:none;">
    <table id="votesTable">
      <thead>
        <tr>
          <th>Market</th>
          <th>Votes</th>
          <th>Static Adj Votes</th>
          <th>Bribes</th>
          <th>Dynamic Boost</th>
          <th>Dampened Adj Votes</th>
          <th>Vote Share</th>
          <th>Vote Share Adjust</th>
          <th>AQUA Rewards</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <th id="totalVotesFooterVotes">0</th>
          <th id="totalStaticFooter">0</th>
          <th></th>
          <th></th>
          <th id="totalDampFooter">0</th>
          <th id="totalShareFooter">0%</th>
          <th id="totalShareAdjustFooter">0%</th>
          <th id="totalRewardsFooter">0</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div id="apiTotalsContainer" class="table-container" style="display:none;">
    <h3>API Vote Totals</h3>
    <table id="apiTotalsTable">
      <tbody>
        <tr><td>AQUA Votes</td><td id="apiAqua">–</td></tr>
        <tr><td>upvoteICE Votes</td><td id="apiUpICE">–</td></tr>
        <tr><td>downvoteICE Votes</td><td id="apiDownICE">–</td></tr>
        <tr><th>Total Votes</th><th id="apiTotal">–</th></tr>
      </tbody>
    </table>
  </div>

  <script>
    // Helpers
    function fmt(n, d=2) { return n.toLocaleString(undefined, { minimumFractionDigits:d, maximumFractionDigits:d }); }
    function parseNum(s) { return parseFloat(String(s).replace(/,/g,'').replace('%',''))||0; }
    function debounce(fn, wait=800){ let t; return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)} }

    // Chart
    const ctx = document.getElementById('curveChart').getContext('2d');
    let curveChart;
    function computeCurve(M, R, D) {
      if (!R||!D) return [{x:0,y:1+M}];
      const pts=[], step=R/50;
      for (let b=0; b<=R; b+=step) {
        pts.push({ x:b, y:1 + M * Math.exp(-b/(R/D)) });
      }
      return pts;
    }
    function updateChart(){
      let D=parseNum(divisor.value)||5,
          RT=parseNum(rTotal.value), PC=parseNum(pCap.value);
      if(RT<0) RT=0; if(PC<0) PC=0;
      const RMC=RT*PC/100;
      rMarketCap.value = fmt(RMC,2);
      const cA=computeCurve(0.3,RMC,D), cB=computeCurve(0.5,RMC,D);
      if(!curveChart){
        curveChart=new Chart(ctx,{
          type:'line',
          data:{datasets:[
            {label:'MaxBoost 0.3',data:cA,borderColor:'blue',fill:false,parsing:{xAxisKey:'x',yAxisKey:'y'}},
            {label:'MaxBoost 0.5',data:cB,borderColor:'red', fill:false,parsing:{xAxisKey:'x',yAxisKey:'y'}}
          ]},
          options:{scales:{x:{type:'linear',title:{display:true,text:'Bribe'}},y:{title:{display:true,text:'Boost'}}}}
        });
      } else {
        curveChart.data.datasets[0].data=cA;
        curveChart.data.datasets[1].data=cB;
        curveChart.update();
      }
    }

    // Recalc rows & debounce
    function recalcAll(){
      document.querySelectorAll('#votesTable tbody tr').forEach(tr => {
        const vIn = tr.querySelector('input.vote'),
              bIn = tr.querySelector('input.bribe'),
              dynC = tr.cells[4], dmpC = tr.cells[5], stC = tr.cells[2];
        const base = parseNum(vIn.value),
              st   = parseNum(stC.getAttribute('data-static')),
              br   = parseNum(bIn.value);
        // static adj
        const sAdj = base>0 ? base*st : base;
        stC.textContent = fmt(sAdj,2);
        // dynamic boost
        let dyn = st>1.5 ? st : (base>0 ? 1 + (st-1)*Math.exp(-br/(parseNum(rMarketCap.value)/parseNum(divisor.value))) : st);
        dynC.textContent = dyn.toFixed(5);
        // dampened
        const dVal = base>0 ? base*dyn : base;
        dmpC.textContent = fmt(dVal,2);
      });
      updateShares();
    }
    const debounced = debounce(()=>{ updateChart(); recalcAll() }, 800);

    // Hooks
    ['divisor','rTotal','pCap'].forEach(id => document.getElementById(id).addEventListener('input', debounced));

    // Fetch & build
    const API='https://voting-tracker.aqua.network/api/voting-snapshot/top-volume/?limit=200',
          HORIZON='https://horizon.stellar.org/accounts/';
    let dot=0, intv=setInterval(()=>{ dot=(dot+1)%4; dots.textContent='.'.repeat(dot); },500);

    async function fetchMarkets(){
      let all=[], url=API;
      while(url){
        const js=await (await fetch(url)).json();
        all.push(...js.results);
        url=js.next;
      }
      return all;
    }
    async function fetchTrustlines(k){
      try{
        const js=await (await fetch(HORIZON+k)).json();
        const bal=js.balances||[],
              hasX=bal.some(b=>b.asset_type==='native'),
              nonX=bal.filter(b=>b.asset_type!=='native').map(b=>b.asset_code);
        if(nonX.length>=2) return nonX;
        if(nonX.length===1&&hasX) return [nonX[0],'XLM'];
        if(hasX) return ['XLM'];
        return nonX;
      } catch { return ['XLM']; }
    }

    function calcStatic(arr){
      let s=1;
      if(arr.includes('AQUA')) s+=0.5;
      if(arr.includes('XLM'))  s+=0.3;
      if(arr.includes('USDC')) s+=0.3;
      return s;
    }

    async function init(){
      updateChart();
      const mkts = await fetchMarkets(),
            ats  = await Promise.all(mkts.map(m=>fetchTrustlines(m.market_key))),
            frag = document.createDocumentFragment();

      mkts.forEach((m,i)=>{
        const base = parseNum(m.votes_value),
              st   = calcStatic(ats[i]),
              tr   = document.createElement('tr');

        // store static boost in data-static for recalc
        const staticCell = `<td data-static="${st}">${fmt(base>0?base*st:base,2)}</td>`;

        tr.innerHTML = `
          <td>${ats[i].join(' / ')}</td>
          <td><input class="vote" type="number" step="any" value="${base}"></td>
          ${staticCell}
          <td><input class="bribe" type="number" value="0" min="0"></td>
          <td>${st.toFixed(5)}</td>
          <td>${fmt(base>0?base*st:base,2)}</td>
          <td>0.00000%</td>
          <td>0.00000%</td>
          <td>0.00</td>`;

        // attach recalc to both inputs
        tr.querySelector('input.vote').addEventListener('input', recalcAll);
        tr.querySelector('input.bribe').addEventListener('input', recalcAll);

        frag.appendChild(tr);
      });

      document.querySelector('#votesTable tbody').appendChild(frag);
      recalcAll();
      clearInterval(intv);
      loading.style.display='none';
      tableWrapper.style.display='block';
      await fetchApiTotals();
    }

    // updateShares() and fetchApiTotals() unchanged from previous version…

    init();
  </script>
</body>
</html>
