<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aquarius Vote Booster Simulator</title>
  <style>
    body { font-family: sans-serif; margin: 10px; }
    .controls { display: flex; flex-wrap: wrap; gap: 16px; margin-top: 20px; }
    .control { display: flex; flex-direction: column; }
    .control label { margin-bottom: 4px; font-size: 0.9em; }
    .control input { padding: 4px; width: 100px; }
    .table-container { overflow-x: auto; margin-top: 40px; }
    table { border-collapse: collapse; width: 100%; min-width: 800px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    input[type=number] { width: 80px; }
    @media (max-width: 600px) {
      .controls { flex-direction: column; }
      .control input { width: 80px; }
      table { min-width: 600px; }
    }
  </style>
</head>
<body>
  <h2>Aquarius Vote Booster Simulator</h2>

  <div class="controls">
    <div class="control">
      <label for="rTotal">R_total (AQUA/day)</label>
      <input type="number" id="rTotal" value="7000000" min="0" />
    </div>
    <div class="control">
      <label for="pCap">P_cap (%)</label>
      <input type="number" id="pCap" value="10" min="0" max="100" />
    </div>
    <div class="control">
      <label for="rMarketCap">R_market_cap</label>
      <input type="text" id="rMarketCap" value="700000" disabled />
    </div>
  </div>

  <div id="loading">Loading data<span id="dots"></span></div>
  <div class="table-container" id="tableWrapper" style="display:none;">
    <table id="votesTable">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Market</th>
          <th>Bribes</th>
          <th>Votes</th>
          <th>Vote Boost</th>
          <th>Boosted Votes</th>
          <th>Vote Share</th>
          <th>Vote Share Adjust</th>
          <th>AQUA Rewards</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <th></th>
          <th id="totalBribesFooter">0</th>
          <th id="totalVotesFooter">0</th>
          <th></th>
          <th id="totalBoostedFooter">0</th>
          <th id="totalShareFooter">0%</th>
          <th id="totalShareAdjustFooter">0%</th>
          <th id="totalRewardsFooter">0</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div id="apiTotalsContainer" class="table-container" style="display:none;">
    <h3>API Vote Totals</h3>
    <table id="apiTotalsTable">
      <tbody>
        <tr><td>AQUA Votes</td><td id="apiAqua">–</td></tr>
        <tr><td>upvoteICE Votes</td><td id="apiUpICE">–</td></tr>
        <tr><td>downvoteICE Votes</td><td id="apiDownICE">–</td></tr>
        <tr><th>Total Votes</th><th id="apiTotal">–</th></tr>
      </tbody>
    </table>
  </div>

  <script>
    function fmt(num, dec = 2) {
      return num.toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec });
    }
    function parseNum(str) {
      return parseFloat(String(str).replace(/,/g, '').replace('%', '')) || 0;
    }
    function debounce(fn, wait = 800) {
      let timeout;
      return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn.apply(this, args), wait); };
    }

    const rTotalInput = document.getElementById('rTotal');
    const pCapInput = document.getElementById('pCap');
    const rMarketCapInput = document.getElementById('rMarketCap');
    const loadingEl = document.getElementById('loading');
    const dotsEl = document.getElementById('dots');
    const wrapEl = document.getElementById('tableWrapper');
    const apiBlock = document.getElementById('apiTotalsContainer');
    let dot = 0;
    const intv = setInterval(() => { dot = (dot + 1) % 4; dotsEl.textContent = '.'.repeat(dot); }, 500);

    function updateMarketCap() {
      let rt = parseNum(rTotalInput.value), pc = parseNum(pCapInput.value);
      rt = rt < 0 ? 0 : rt; pc = pc < 0 ? 0 : pc;
      rMarketCapInput.value = fmt((rt * pc) / 100, 2);
    }
    function recalcAll() { document.querySelectorAll('#votesTable tbody tr input').forEach(i => i.dispatchEvent(new Event('input'))); }
    const debouncedUpdate = debounce(() => { updateMarketCap(); recalcAll(); });
    rTotalInput.addEventListener('input', debouncedUpdate);
    pCapInput.addEventListener('input', debouncedUpdate);

    function calcStatic(assets) {
      let b = 1; if (assets.includes('AQUA')) b+=0.5; if (assets.includes('XLM')) b+=0.3; if (assets.includes('USDC')) b+=0.3; return b;
    }
    const API = 'https://voting-tracker.aqua.network/api/voting-snapshot/top-volume/?limit=200';
    const HORIZON = 'https://horizon.stellar.org/accounts/';
    async function fetchMarkets() { let all = [], url = API; while (url) { const js = await (await fetch(url)).json(); all = all.concat(js.results); url = js.next; } return all; }
    async function fetchTrustlines(key) { try { const js = await (await fetch(HORIZON + key)).json(); const bal = js.balances||[], nonX = bal.filter(b=>b.asset_type!=='native').map(b=>b.asset_code), hasX = bal.some(b=>b.asset_type==='native'); if (nonX.length>=2) return nonX; if (nonX.length===1&&hasX) return [nonX[0],'XLM']; if (hasX) return ['XLM']; return nonX; } catch { return ['XLM']; } }

    function createRow(item) {
      const tr = document.createElement('tr');
      const st = item.staticBoost, base = item.original;
      tr.innerHTML = `
        <td>${item.rank}</td>
        <td>${item.market}</td>
        <td><input type="number" value="0" min="0"></td>
        <td><input type="number" value="${fmt(base,2)}" min="0"></td>
        <td>${st.toFixed(1)}</td>
        <td>${fmt(base * st,2)}</td>
        <td>0.00000%</td>
        <td>0.00000%</td>
        <td>0.00</td>`;
      const [brInput, votesInput] = tr.querySelectorAll('input');
      function onInput() {
        const votes = parseNum(votesInput.value);
        tr.cells[4].textContent = st.toFixed(1);
        tr.cells[5].textContent = fmt(votes * st,2);
        updateShares();
      }
      brInput.addEventListener('input', onInput);
      votesInput.addEventListener('input', onInput);
      return tr;
    }

    function updateShares() {
      const rows = Array.from(document.querySelectorAll('#votesTable tbody tr'));
      const boosted = rows.map(r=>parseNum(r.cells[5].textContent));
      const totalBoost = boosted.reduce((a,b)=>a+b,0);
      rows.forEach((r,i)=> r.cells[6].textContent = totalBoost?((boosted[i]/totalBoost)*100).toFixed(5)+'%':'0.00000%');
      const qualifiers = rows.filter(r=>parseNum(r.cells[6].textContent)>=0.5).map(r=>({row:r,pct:parseNum(r.cells[6].textContent)}));
      const totQ = qualifiers.reduce((a,q)=>a+q.pct,0)||1;
      qualifiers.forEach(q=> q.row.cells[7].textContent = ((q.pct/totQ)*100).toFixed(5)+'%');
      const rt = parseNum(rTotalInput.value);
      qualifiers.forEach(q=> q.row.cells[8].textContent = fmt((rt*parseNum(q.row.cells[7].textContent))/100,2));

      // footers
      const sumBr = rows.map(r=>parseNum(r.cells[2].querySelector('input').value)).reduce((a,b)=>a+b,0);
      const sumVo = rows.map(r=>parseNum(r.cells[3].querySelector('input').value)).reduce((a,b)=>a+b,0);
      const sumBt = boosted.reduce((a,b)=>a+b,0);
      const sumSh = rows.map(r=>parseNum(r.cells[6].textContent)).reduce((a,b)=>a+b,0);
      const sumAd = qualifiers.reduce((a,q)=>a+parseNum(q.row.cells[7].textContent),0);
      const sumRe = qualifiers.reduce((a,q)=>a+parseNum(q.row.cells[8].textContent),0);
      document.getElementById('totalBribesFooter').textContent = fmt(sumBr,2);
      document.getElementById('totalVotesFooter').textContent = fmt(sumVo,2);
      document.getElementById('totalBoostedFooter').textContent = fmt(sumBt,2);
      document.getElementById('totalShareFooter').textContent = sumSh.toFixed(5)+'%';
      document.getElementById('totalShareAdjustFooter').textContent = sumAd.toFixed(5)+'%';
      document.getElementById('totalRewardsFooter').textContent = fmt(sumRe,2);
    }

    async function fetchApiTotals() {
      let a=0,u=0,d=0,url=API;
      while(url) { const js=await(await fetch(url)).json(); (js.results||[]).forEach(item=>{(item.extra?.upvote_assets||[]).forEach(x=>{const v=parseNum(x.votes_sum); if(x.asset.startsWith('AQUA:'))a+=v;else if(x.asset.startsWith('upvoteICE:'))u+=v;}); (item.extra?.downvote_assets||[]).forEach(x=>{const v=parseNum(x.votes_sum); if(x.asset.startsWith('downvoteICE:'))d+=v;});}); url=js.next; }
      document.getElementById('apiAqua').textContent=fmt(a,2);
      document.getElementById('apiUpICE').textContent=fmt(u,2);
      document.getElementById('apiDownICE').textContent=fmt(d,2);
      document.getElementById('apiTotal').textContent=fmt(a+u+d,2);
      apiBlock.style.display='block';
    }

    async function init() {
      updateMarketCap();
      const mkts = await fetchMarkets();
      const assets = await Promise.all(mkts.map(m=>fetchTrustlines(m.market_key)));
      const frag = document.createDocumentFragment();
      mkts.forEach((m,i)=>{
        const o = parseNum(m.votes_value);
        const s = calcStatic(assets[i]);
        frag.appendChild(createRow({ rank: i+1, market: assets[i].join(' / '), original: o, staticBoost: s }));
      });
      document.querySelector('#votesTable tbody').appendChild(frag);
      updateShares();
      clearInterval(intv); loadingEl.style.display='none'; wrapEl.style.display='block';
      await fetchApiTotals();
    }

    init();
  </script>
</body>
</html>
