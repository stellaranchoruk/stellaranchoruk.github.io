<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AQUA Bulk Payout → Build Stellar XDR</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111a2b; --muted:#8ea0c2; --text:#e8eefc;
      --accent:#5eead4; --warn:#fbbf24; --bad:#fb7185; --ok:#34d399;
      --border:rgba(255,255,255,.12);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text); background:radial-gradient(1200px 800px at 15% -10%, rgba(94,234,212,.18), transparent 60%), var(--bg);
    }
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 10px;font-size:20px}
    .sub{color:var(--muted);margin:0 0 18px;font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:14px; padding:14px;
    }
    .row{display:grid;grid-template-columns: 1.2fr 1.8fr 1fr 1fr; gap:10px; align-items:center}
    .row.header{color:var(--muted);font-size:12px;padding-bottom:8px;border-bottom:1px dashed rgba(255,255,255,.12);margin-bottom:10px}
    .name{font-weight:700}
    .addr{font-family:var(--mono);font-size:12px;color:var(--muted);word-break:break-all}
    input[type="text"], input[type="number"], textarea, select{
      width:100%; padding:10px 10px; border-radius:10px;
      background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.14);
      color:var(--text); outline:none;
    }
    input[type="number"]{font-family:var(--mono)}
    textarea{min-height:120px; font-family:var(--mono); font-size:12px}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    button{
      padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16);
      background:rgba(94,234,212,.12); color:var(--text); cursor:pointer;
      font-weight:700;
    }
    button.secondary{background:rgba(255,255,255,.06)}
    button.danger{background:rgba(251,113,133,.14)}
    .pill{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .two{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width: 980px){ .two{grid-template-columns: 1fr 1fr;} }
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .mono{font-family:var(--mono)}
    .totals{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .totals .box{padding:8px 10px;border:1px solid rgba(255,255,255,.14);border-radius:12px;background:rgba(255,255,255,.04)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AQUA Monthly Payouts → Build XDR</h1>
    <p class="sub">Enter amounts next to each wallet, then generate a single transaction XDR with multiple AQUA payments.</p>

    <div class="two">
      <div class="card">
        <div class="controls" style="justify-content:space-between">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <div style="min-width:240px">
              <div class="pill">Network</div>
              <select id="network">
                <option value="PUBLIC" selected>Public Network</option>
                <option value="TESTNET">Testnet</option>
              </select>
            </div>
            <div style="min-width:340px">
              <div class="pill">Source (payout) address</div>
              <input id="source" type="text" spellcheck="false" class="mono" />
            </div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="secondary" id="fillZeros">Fill blanks with 0</button>
            <button class="danger" id="clearAll">Clear amounts</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:12px">
          <div>
            <div class="pill">Base fee (stroops)</div>
            <input id="baseFee" type="number" min="100" step="1" value="100" />
          </div>
          <div>
            <div class="pill">Memo (optional)</div>
            <input id="memo" type="text" placeholder="e.g. AQUA monthly payout Feb 2026" />
          </div>
          <div>
            <div class="pill">Timebound (minutes)</div>
            <input id="timebound" type="number" min="0" step="1" value="0" />
          </div>
        </div>

        <div style="margin-top:12px" class="small">
          Asset:
          <span class="mono">AQUA</span> /
          <span class="mono">GBNZILSTVQZ4R7IKQDGHYGY2QXL5QOFJYQMXPKWRRM5PAV7Y4M67AQUA</span>
        </div>

        <div style="margin-top:14px" class="row header">
          <div>Name</div><div>Address</div><div>Amount (AQUA)</div><div>Include?</div>
        </div>
        <div id="rows"></div>

        <div style="margin-top:14px" class="totals">
          <div class="box"><span class="pill">Ops:</span> <span id="opCount" class="mono">0</span></div>
          <div class="box"><span class="pill">Total AQUA:</span> <span id="totalAqua" class="mono">0</span></div>
          <div class="box"><span class="pill">Status:</span> <span id="status" class="mono warn">Ready</span></div>
        </div>

        <div style="margin-top:14px" class="controls">
          <button id="build">Build XDR</button>
          <button class="secondary" id="copyXdr">Copy XDR</button>
          <button class="secondary" id="openLab">Open in Stellar Laboratory</button>
        </div>

        <div style="margin-top:12px">
          <div class="pill">XDR (base64)</div>
          <textarea id="xdr" spellcheck="false" placeholder="XDR will appear here..."></textarea>
          <div class="small" style="margin-top:8px">
            Tip: after building, you can sign in Stellar Laboratory, Freighter, or your own signer flow.
          </div>
        </div>
      </div>

      <div class="card">
        <h1 style="font-size:16px;margin:0 0 10px">Notes / checks</h1>
        <ul class="small" style="margin:0;padding-left:18px">
          <li>This builds <span class="mono">PAYMENT</span> ops for <span class="mono">AQUA</span>.</li>
          <li>Only amounts <span class="mono">&gt; 0</span> and checked “Include” become ops.</li>
          <li>Sequence number is fetched from Horizon for the source account.</li>
          <li>If recipients don’t have an AQUA trustline, payments will fail when submitted.</li>
          <li>Timebound:
            <span class="mono">0</span> = none.
            Otherwise, transaction is valid for N minutes from build time.
          </li>
        </ul>

        <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

        <div class="pill">Horizon endpoints</div>
        <div class="small mono" id="horizonInfo" style="margin-top:6px;word-break:break-all"></div>

        <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

        <div class="pill">Quick: paste amounts (optional)</div>
        <div class="small" style="margin-top:6px">
          You can paste lines like <span class="mono">blockhead92=123.45</span> or <span class="mono">GB...=50</span>,
          then click “Apply”.
        </div>
        <textarea id="bulk" spellcheck="false" placeholder="blockhead92=123.45&#10;corefusion=10&#10;GA...=5"></textarea>
        <div class="controls" style="margin-top:10px">
          <button class="secondary" id="applyBulk">Apply</button>
        </div>
        <div class="small" id="bulkResult" style="margin-top:8px;color:var(--muted)"></div>
      </div>
    </div>
  </div>

  <!-- Stellar SDK (CDN). If you prefer a pinned version you trust, swap this URL. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/12.2.0/stellar-sdk.min.js"></script>
  <script>
    // ---- Config you gave ----
    const RECIPIENTS = [
      ["blockhead92","GB5RFAUMPDQV5AVWDPWIUY7SQDLLG2D6TE45MQQCGIXK4D6SJRSVDIEE"],
      ["corefusion","GDUSWVZEKRZ7TPNBKNBGLUOIEXRJLVXJTX63IHTJBXKRI7UKQNFJRNE6"],
      ["Icehand41","GD3EXP7GTMP7UFHPOR4O24EUH7S6VDKT7UAC4GDGPNFOBU3SAOFCPVTH"],
      ["Jack","GCFJLCJ4HEB5OQRDSIEWQKAL7OBONG4SEWNEVW34SJQGCQ7ALFGQ22FV"],
      ["Jason","GAJOGYNY43FSCIGOOWGVJEGX7XTAEO4JYWEAX23ZNTPRF5VDGJY2AYVF"],
      ["LUX Payband","GAEBP4VL2XZTJ46IBYTZ5TTWDYAEEXMPNB45W6GGEUSIYWDFGWM3IHTQ"],
      ["Orbitlens","GAIV74GIYWW33RQL3RSTGCSMQXPRELVJDMTI33RKXEFZQVZLPZ6WAPFN"],
      ["pfranb/synt.tech","GB4XWB2XCYAFURLNWOKQLYADJ2PBIYEI7U7R73O4ICRYZPMX6SBEANGF"],
      ["ra.ph","GAVHKMSYQ4SURL5OR4C7TNMPT4YSJQVD4CYRQFY4ZYDF2MBUOADSHIGH"],
      ["Stables Guru","GADVLQ7SFH6YGUL2OPFK42RPQEXJFTUU5YSM3EEQSIMWQ2FOO73U4CMO"],
      ["Emir","GDIDVZPBHQLEFE6LPCSMLAGMWUJ25OLYPRITTUQVVDQM3ZGGQ6SGQHLU"],
      ["sunny.007","GDNO6HPKU6VLUZB7HUWZMEGK3NL4HDGDK5QQZLACKXEH6H4NX42NGZKP"],
    ];

    const SOURCE_DEFAULT = "GCL65B2BXG5LAD633I53QWD7W2BESQIKMDMKJOCRRBXAEUEFVQDCOUZA";
    const AQUA_CODE = "AQUA";
    const AQUA_ISSUER = "GBNZILSTVQZ4R7IKQDGHYGY2QXL5QOFJYQMXPKWRRM5PAV7Y4M67AQUA";

    // ---- UI wiring ----
    const elRows = document.getElementById("rows");
    const elSource = document.getElementById("source");
    const elNetwork = document.getElementById("network");
    const elStatus = document.getElementById("status");
    const elXdr = document.getElementById("xdr");
    const elOpCount = document.getElementById("opCount");
    const elTotalAqua = document.getElementById("totalAqua");
    const elHorizonInfo = document.getElementById("horizonInfo");

    elSource.value = SOURCE_DEFAULT;

    function horizonUrl() {
      return elNetwork.value === "TESTNET"
        ? "https://horizon-testnet.stellar.org"
        : "https://horizon.stellar.org";
    }

    function passphrase() {
      return elNetwork.value === "TESTNET"
        ? StellarSdk.Networks.TESTNET
        : StellarSdk.Networks.PUBLIC;
    }

    function setStatus(text, cls) {
      elStatus.className = "mono " + (cls || "warn");
      elStatus.textContent = text;
    }

    function fmt(n) {
      if (!isFinite(n)) return "0";
      // keep up to 7 decimals (Stellar asset precision)
      return (Math.round(n * 1e7) / 1e7).toString();
    }

    function rebuildHorizonInfo(){
      elHorizonInfo.textContent = horizonUrl() + " (network passphrase: " + passphrase() + ")";
    }
    rebuildHorizonInfo();
    elNetwork.addEventListener("change", rebuildHorizonInfo);

    // Build recipient rows
    const rowState = new Map(); // address -> {amountEl, includeEl, name}
    function makeRow(name, addr) {
      const wrap = document.createElement("div");
      wrap.className = "row";
      wrap.style.padding = "8px 0";
      wrap.style.borderBottom = "1px solid rgba(255,255,255,.06)";

      const c1 = document.createElement("div");
      c1.innerHTML = `<div class="name">${escapeHtml(name)}</div>`;

      const c2 = document.createElement("div");
      c2.innerHTML = `<div class="addr">${escapeHtml(addr)}</div>`;

      const c3 = document.createElement("div");
      const amount = document.createElement("input");
      amount.type = "number";
      amount.min = "0";
      amount.step = "0.0000001";
      amount.placeholder = "0";
      amount.inputMode = "decimal";
      amount.addEventListener("input", updateTotals);
      c3.appendChild(amount);

      const c4 = document.createElement("div");
      const include = document.createElement("input");
      include.type = "checkbox";
      include.checked = true;
      include.addEventListener("change", updateTotals);
      c4.appendChild(include);

      wrap.appendChild(c1); wrap.appendChild(c2); wrap.appendChild(c3); wrap.appendChild(c4);
      elRows.appendChild(wrap);

      rowState.set(addr, { amountEl: amount, includeEl: include, name });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    RECIPIENTS.forEach(([n,a]) => makeRow(n,a));

    function updateTotals(){
      let ops = 0;
      let total = 0;
      for (const [addr, st] of rowState.entries()){
        const inc = st.includeEl.checked;
        const v = parseFloat(st.amountEl.value || "0");
        if (inc && v > 0){
          ops += 1;
          total += v;
        }
      }
      elOpCount.textContent = String(ops);
      elTotalAqua.textContent = fmt(total);
    }
    updateTotals();

    document.getElementById("fillZeros").addEventListener("click", () => {
      for (const st of rowState.values()){
        if (!st.amountEl.value) st.amountEl.value = "0";
      }
      updateTotals();
    });

    document.getElementById("clearAll").addEventListener("click", () => {
      for (const st of rowState.values()){
        st.amountEl.value = "";
        st.includeEl.checked = true;
      }
      elXdr.value = "";
      setStatus("Ready", "warn");
      updateTotals();
    });

    // Bulk apply
    document.getElementById("applyBulk").addEventListener("click", () => {
      const txt = document.getElementById("bulk").value || "";
      const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

      // Build lookup by name (case-insensitive) and by address
      const byName = new Map();
      for (const [addr, st] of rowState.entries()){
        byName.set(st.name.toLowerCase(), addr);
      }

      let applied = 0, skipped = 0;
      for (const line of lines){
        const m = line.match(/^(.+?)\s*=\s*([0-9]+(\.[0-9]+)?)\s*$/);
        if (!m){ skipped++; continue; }
        const key = m[1].trim();
        const amt = m[2];

        let addr = null;
        if (rowState.has(key)) addr = key; // direct address
        if (!addr) addr = byName.get(key.toLowerCase()) || null;

        if (!addr){ skipped++; continue; }
        rowState.get(addr).amountEl.value = amt;
        rowState.get(addr).includeEl.checked = true;
        applied++;
      }

      updateTotals();
      document.getElementById("bulkResult").textContent = `Applied: ${applied}. Skipped: ${skipped}.`;
    });

    // ---- Build XDR ----
    async function fetchAccount(source, horizon){
      const r = await fetch(`${horizon}/accounts/${encodeURIComponent(source)}`);
      if (!r.ok) {
        const t = await r.text().catch(() => "");
        throw new Error(`Horizon account lookup failed (${r.status}). ${t}`.slice(0, 260));
      }
      return r.json();
    }

    function collectPayments(){
      const items = [];
      for (const [addr, st] of rowState.entries()){
        const inc = st.includeEl.checked;
        const v = parseFloat(st.amountEl.value || "0");
        if (inc && v > 0){
          // Stellar accepts amounts as strings with up to 7 decimals
          items.push({ destination: addr, amount: fmt(v), name: st.name });
        }
      }
      return items;
    }

    document.getElementById("build").addEventListener("click", async () => {
      try{
        setStatus("Building…", "warn");
        elXdr.value = "";

        const source = (elSource.value || "").trim();
        if (!source) throw new Error("Source address is blank.");

        const payments = collectPayments();
        if (!payments.length) throw new Error("No payments selected (amounts > 0).");

        const baseFee = parseInt(document.getElementById("baseFee").value || "100", 10);
        if (!isFinite(baseFee) || baseFee < 100) throw new Error("Base fee must be ≥ 100 stroops.");

        const horizon = horizonUrl();
        const acct = await fetchAccount(source, horizon);

        const server = new StellarSdk.Horizon.Server(horizon);
        const account = new StellarSdk.Account(acct.account_id, acct.sequence);

        const aqua = new StellarSdk.Asset(AQUA_CODE, AQUA_ISSUER);

        let builder = new StellarSdk.TransactionBuilder(account, {
          fee: String(baseFee),
          networkPassphrase: passphrase()
        });

        // Optional memo
        const memoTxt = (document.getElementById("memo").value || "").trim();
        if (memoTxt){
          builder = builder.addMemo(StellarSdk.Memo.text(memoTxt.slice(0, 28)));
        }

        // Optional timebounds
        const minutes = parseInt(document.getElementById("timebound").value || "0", 10);
        if (isFinite(minutes) && minutes > 0){
          const now = Math.floor(Date.now()/1000);
          builder = builder.setTimeout(minutes * 60); // uses maxTime = now + seconds
        } else {
          // If you want NO timeout at all (not recommended), Stellar SDK expects setTimeout(0)
          builder = builder.setTimeout(0);
        }

        for (const p of payments){
          builder = builder.addOperation(StellarSdk.Operation.payment({
            destination: p.destination,
            asset: aqua,
            amount: p.amount
          }));
        }

        const tx = builder.build();
        const xdr = tx.toXDR();
        elXdr.value = xdr;

        setStatus(`Built XDR with ${payments.length} ops.`, "ok");
      } catch (e){
        console.error(e);
        setStatus(e.message || String(e), "bad");
      }
    });

    document.getElementById("copyXdr").addEventListener("click", async () => {
      try{
        const v = elXdr.value.trim();
        if (!v) throw new Error("No XDR to copy.");
        await navigator.clipboard.writeText(v);
        setStatus("Copied XDR to clipboard.", "ok");
      } catch (e){
        setStatus(e.message || String(e), "bad");
      }
    });

    document.getElementById("openLab").addEventListener("click", () => {
      const v = elXdr.value.trim();
      if (!v){ setStatus("Build an XDR first.", "warn"); return; }

      // Stellar Laboratory can import XDR from the "Transaction Signer" page; passing as URL is not always stable,
      // so we open the signer and you paste XDR. Still useful as a quick jump.
      const url = "https://laboratory.stellar.org/#txsigner?network=" + (elNetwork.value === "TESTNET" ? "test" : "public");
      window.open(url, "_blank", "noopener,noreferrer");
      setStatus("Opened Stellar Laboratory (paste XDR into Tx Signer).", "ok");
    });
  </script>
</body>
</html>
